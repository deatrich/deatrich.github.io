<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Denice Deatrich" />
  <meta name="dcterms.date" content="2023-04-24" />
  <title>Creating a Linux Home Server</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {  background-color: #f5f5dc; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #0000ff; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #8f008f; font-weight: bold; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #ff0000; font-weight: bold; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="https://latex.now.sh/style.css" />
  <link rel="stylesheet" href="https://deatrich.github.io/style.css" />
  
  
  
  
  
  
</head>
<body>
<header id="title-block-header">
<h1 class="title">Creating a Linux Home Server</h1>
<p class="author">Denice Deatrich
  <br />Created: 24 April 2023
  <br />Last update: 11 October 2023
</p>
</header>
<nav id="TOC" role="doc-toc">
<h2 id="toc-title">Table of Contents</h2>
<ul>
<li><a href="#chapter-01">Overview</a>
<ul>
<li><a href="#reserved-address">A few issues before you begin</a></li>
<li><a href="#doc">About this document</a></li>
</ul></li>
<li><a href="#chapter-02">Picking the OS (Operating System) and the window manager</a>
<ul>
<li><a href="#ubuntu-lts">Ubuntu LTS</a></li>
<li><a href="#subscribing-to-a-few-mailing-lists">Subscribing to a few mailing lists</a></li>
<li><a href="#mate-desktop">MATE desktop</a></li>
</ul></li>
<li><a href="#chapter-03">Creating the installation disk</a></li>
<li><a href="#chapter-04">Installation and first experience</a>
<ul>
<li><a href="#getting-going-with-the-command-line">Getting Going with the Command-Line</a></li>
</ul></li>
<li><a href="#chapter-05">Creating a Samba file sharing service</a>
<ul>
<li><a href="#create-the-data-space-and-assign-appropriate-permissions.">Create the data space and assign appropriate permissions.</a></li>
<li><a href="#install-the-samba-software">Install the Samba software</a></li>
<li><a href="#modify-the-samba-configuration-file">Modify the Samba configuration file</a></li>
<li><a href="#restart-the-service-and-check-log-files">Restart the service and check log files</a></li>
<li><a href="#run-some-tests">Run some tests</a></li>
</ul></li>
<li><a href="#chapter-06">Backing up your server</a>
<ul>
<li><a href="#recovering-files-from-backups">Recovering files from backups</a></li>
</ul></li>
<li><a href="#chapter-07">Server customization</a>
<ul>
<li><a href="#turn-off-bluetooth">Turn off Bluetooth</a></li>
<li><a href="#turn-off-wireless">Turn Off wireless</a></li>
<li><a href="#install-a-simulated-hardware-clock">Install A simulated hardware clock</a></li>
<li><a href="#enable-boot-up-console-messages">Enable boot-up console messages</a></li>
<li><a href="#disable-the-graphical-login-interface">Disable the graphical login interface</a></li>
<li><a href="#disable-snap-infrastructure">Disable Snap infrastructure</a></li>
<li><a href="#modify-the-swap-setup">Modify the swap setup</a></li>
<li><a href="#remove-anacron-service">Remove <strong>anacron</strong> service</a></li>
<li><a href="#disable-various-unused-services">Disable various unused services</a></li>
<li><a href="#miscellaneous-configuration-tweaks">Miscellaneous configuration tweaks</a>
<ul>
<li><a href="#change-local-time-presentation-globally">Change local time presentation globally</a></li>
<li><a href="#change-log-rotation-file-naming">Change log rotation file naming</a></li>
<li><a href="#consider-enabling-a-static-ip-configuration">Consider enabling a static IP configuration</a></li>
<li><a href="#addressing-software-package-updates">Addressing software package updates</a></li>
<li><a href="#getting-rid-of-motd-terminal-output">Getting rid of <em>motd</em> terminal output</a></li>
</ul></li>
</ul></li>
<li><a href="#chapter-08">Enabling the Secure Shell daemon and using Secure Shell</a>
<ul>
<li><a href="#configure-the-sshd-daemon">Configure the sshd daemon</a></li>
<li><a href="#key-pair">Configure a personal SSH key pair</a></li>
<li><a href="#configure-an-ssh-agent">Configure an SSH agent</a></li>
<li><a href="#personal-configuration-in-config-file">Personal Configuration in ‘config’ File</a></li>
</ul></li>
<li><a href="#chapter-09">Enabling remote desktop services</a>
<ul>
<li><a href="#configure-remote-desktop-protocol-rdp">Configure Remote Desktop Protocol (RDP)</a></li>
<li><a href="#configure-x2go">Configure X2Go</a></li>
</ul></li>
<li><a href="#chapter-10">Starting Up an NFS service for other Linux devices</a>
<ul>
<li><a href="#configure-the-nfs-daemons">Configure the NFS daemons</a></li>
<li><a href="#configure-nfs-clients-on-other-hosts">Configure NFS clients on other hosts</a></li>
<li><a href="#some-factors-to-consider">Some factors To consider</a>
<ul>
<li><a href="#what-if-the-server-fails">What if the server fails</a></li>
<li><a href="#doing-maintenance-on-the-linux-server">Doing maintenance on the Linux server</a></li>
</ul></li>
</ul></li>
<li><a href="#chapter-11">Creating a web server</a>
<ul>
<li><a href="#installing-and-testing-apache-2.4">Installing and testing Apache 2.4</a></li>
<li><a href="#generating-a-self-signed-certificate-and-enabling-https">Generating a self-signed certificate and enabling HTTPS</a></li>
<li><a href="#apache-directory-infrastructure">Apache directory infrastructure</a></li>
<li><a href="#apache-configuration-issues">Apache configuration issues</a></li>
<li><a href="#disabling-ipv6-access-to-the-apache-daemon">Disabling IPv6 access to the Apache daemon</a></li>
<li><a href="#installing-the-php-apache-module">Installing the PHP Apache module</a></li>
</ul></li>
<li><a href="#chapter-12">Creating a database server</a>
<ul>
<li><a href="#installing-the-server">Installing the server</a></li>
<li><a href="#configuring-the-server">Configuring the server</a>
<ul>
<li><a href="#allowing-non-superuser-users-to-connect-remotely">Allowing non-superuser users to connect remotely</a></li>
</ul></li>
<li><a href="#backing-up-a-mariadb-database">Backing up a MariaDB database</a></li>
</ul></li>
<li><a href="#chapter-13">Starting your own Git service</a>
<ul>
<li><a href="#installing-and-configuring-git-services">Installing and configuring Git services</a>
<ul>
<li><a href="#setting-up-the-repository">Setting up the repository</a></li>
<li><a href="#setting-up-the-git-protocol">Setting up the <em>Git</em> protocol</a></li>
<li><a href="#setting-up-the-ssh-protocol">Setting up the <em>SSH</em> protocol</a></li>
</ul></li>
<li><a href="#setting-up-gitweb-for-web-access-to-git-repositories">Setting up <strong>gitweb</strong> for web access to Git repositories</a></li>
</ul></li>
<li><a href="#chapter-14">Setting up a virtualization service with QEMU/KVM</a>
<ul>
<li><a href="#verifying-kernel-support">Verifying kernel support</a></li>
<li><a href="#changing-the-network-interface-to-bridging-mode">Changing the network interface to bridging mode</a></li>
<li><a href="#installing-the-software">Installing the software</a></li>
<li><a href="#disabling-the-default-virtual-network">Disabling the default virtual network</a></li>
<li><a href="#setting-up-a-disk-area-for-clients-and-boot-images">Setting up a disk area for clients and boot images</a></li>
<li><a href="#creating-some-virtual-hosts">Creating some virtual hosts</a>
<ul>
<li><a href="#virt-manager">virt-manager</a></li>
<li><a href="#virt-install">virt-install</a></li>
</ul></li>
</ul></li>
<li><a href="#zappendix">Appendix</a>
<ul>
<li><a href="#find-device">Identifying device names for storage devices</a></li>
<li><a href="#image-cmds">Installation disk creation from the command-line</a></li>
<li><a href="#mod-partition">Modify the partitioning of the installation image</a>
<ul>
<li><a href="#identify-the-main-linux-partition-on-the-microsd">Identify the main Linux partition on the microSD</a></li>
<li><a href="#expand-the-main-linux-partition-on-the-microsd">Expand the main Linux partition on the microSD</a></li>
<li><a href="#create-a-new-data-partition">Create a new data partition</a></li>
<li><a href="#create-a-file-system-on-the-new-data-partition">Create a file system on the new data partition</a></li>
</ul></li>
<li><a href="#data-area">Setting up a data area</a></li>
<li><a href="#eg-cmds">Some command-line utilities and their purpose</a></li>
<li><a href="#mate-exercise">A MATE configuration exercise</a>
<ul>
<li><a href="#modify-the-top-panel">Modify the top panel</a></li>
<li><a href="#other-changes-done-from-the-control-centre">Other changes done from the control centre</a></li>
<li><a href="#here-are-a-few-notes-about-window-actions">Here are a few notes about window actions:</a></li>
</ul></li>
<li><a href="#backups">An example process and script for backups</a></li>
<li><a href="#lan">LAN (Local Area Network) configuration</a>
<ul>
<li><a href="#common-network-related-files">Common network-related files</a></li>
<li><a href="#changing-the-servers-hostname">Changing the server’s hostname</a></li>
<li><a href="#the-resolver-and-looking-up-your-local-hostnames">The resolver and looking up your local hostnames</a></li>
<li><a href="#modifying-the-resolvers-list-of-nameservers">Modifying the resolver’s list of nameservers</a></li>
<li><a href="#static-ip">Statically configuring your server’s IP address</a></li>
</ul></li>
<li><a href="#root">Other ways of becoming the superuser in a restricted environment</a>
<ul>
<li><a href="#setting-a-password-for-the-superuser">Setting a password for the superuser</a></li>
<li><a href="#allowing-secure-shell-access-from-another-device-in-your-lan">Allowing secure-shell access from another device in your LAN</a></li>
</ul></li>
<li><a href="#new-git-repo">Creating a new Git repository</a></li>
<li><a href="#new-git-user">Allowing a new user SSH access to the Git server</a></li>
</ul></li>
<li><a href="#command-list">List of Linux commands used in this guide</a></li>
<li><a href="#url-list">List of URLs mentioned in this guide</a></li>
</ul>
</nav>
<!-- Pandoc metadata, mostly used when generating PDF

     Solution for starting a new page for major sections of PDF output
     in metadata (documentclass, header-includes) is decscribed at:
     https://superuser.com/a/1436367

     Be sure to change 'title', 'author' and 'date' below:
-->
<!-- -->
<h1 id="chapter-01">Overview</h1>
<p>Single-board computers (SBC) are both inexpensive and reliable; they are also very small. As such they make excellent 24x7 home servers. This guide steps you through the process of creating such a server.</p>
<p>This guide was originally tested on a Raspberry Pi 400, and then later on a Raspberry Pi 4b. The main difference it that the Pi 400 board is embedded in a small keyboard.</p>
<p>I also have another SBC, an <a href="https://www.hardkernel.com/">ODROID</a> still running Ubuntu LTS 16.04, and I will document it as well when I update it. I am not sure yet whether I will document it here, or as another mini-document. For now I am focusing on the Raspberry Pi.</p>
<p>One of my goals is to promote using the command-line to do most of the work. If you are interested in expanding your horizons and understanding more about the power of the command-line, then this guide is for you. There is also a lot of detail in this guide; this is my personal preference. I grow tired of the current trend to provide internet-searched answers in a few phrases to fit on the screen of a mobile phone.</p>
<p>Take a look at the table of contents at the top of the document. Some users will only be interested in creating a 24x7 local file-sharing (Samba) service at home – in that case you do not need to read beyond the section on ‘Backups’.</p>
<p>Subsequent chapters are more complex, so an interest in the command-line is really needed. Of course, people familiar with Linux and the command-line will skip some sections of this guide.</p>
<h2 id="reserved-address">A few issues before you begin</h2>
<p>You should look into assigning a permanent network IP address for your server in your home network so that you can easily connect to it from any of your devices. Your home network router/WiFi modem should have the option to enable you to reserve an IP address for any device. You only need to know the hardware MAC address of your future server. There will be 2 MAC addresses - one for hardwired ethernet and one for wireless. You can reserve both interfaces until you decide which way you will connect your server to your router.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="co">// There are a few ways to find the MAC addresses of your network devices under</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a><span class="co">// contemporary Linux distributions.  One quick command-line method is to look</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a><span class="co">// in the &#39;/sys/class/net/&#39; sub-directory for the network devices:</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a><span class="kw">$ ls  /sys/class/net/*/address</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a>/sys/class/net/eth0/address  /sys/class/net/wlan0/address</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a>/sys/class/net/lo/address</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true"></a><span class="co">// On a Pi with Ubuntu installed the wired network device is &#39;eth0&#39; and the</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true"></a><span class="co">// wireless network device is &#39;wlan0&#39;</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true"></a><span class="kw">$ cat /sys/class/net/eth0/address</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true"></a>e4:5f:01:a7:22:54</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true"></a><span class="kw">$ cat /sys/class/net/wlan0/address</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true"></a>e4:5f:01:a7:22:55</span></code></pre></div>
<h2 id="doc">About this document</h2>
<p>This guide was created in the <a href="https://www.markdownguide.org/getting-started/"><em>Markdown</em></a> markup language (the Pandoc flavour of Markdown). Markdown is wonderfully simple. Then, using the versatile <a href="https://pandoc.org/">Pandoc</a> command set, both HTML and PDF formats of the document were generated. In fact this document was created using the home server as a remote desktop. The server served as a git, web and NFS server; as well it served as a remote desktop for contemporary documentation creation.</p>
<p>The appendix of this document is rather large. The idea is to push some of the command-line and technical detail into the appendix. Thus the flow of the document covers the basics, encouraging the reader to see the bigger picture and to avoid being smothered in the detail.</p>
<p>In this guide command-line sessions appear in a pale-yellow box, using a customized <em>.console</em> Markdown syntax highlighting convention which I created <a href="https://github.com/deatrich/console-syntax/">for command-line input and output</a>. Two kinds of simplified command-line prompts appear. As well, explanatory comments starting with two slashes are coloured blue:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="co">// Usually your prompt would be more complex, something like this:</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a><span class="co">//    myname@ubuntu:~/.vim/syntax$</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a><span class="co">// or like this:</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a><span class="co">//    [desktop /tmp]$ </span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a><span class="co">// But I simplify its appearance when illustrating command-line sessions.</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a><span class="co">// Normal Users&#39; command-line prompt, coloured &#39;green&#39;:</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a><span class="kw">$ some-command</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a><span class="co">// The root superuser&#39;s prompt, simplifed also, and coloured &#39;red&#39;:</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true"></a><span class="fu"># some-other-command</span></span></code></pre></div>
<p>From my experience creating this guide I added another git repository containing the examples of the Markdown documentation style and support files <a href="https://github.com/deatrich/doc-with-pandoc-markdown/">used in this guide</a>.</p>
<p>Sometimes command output is long and/or uninteresting in the context of this guide. I might show such segments with a ellipsis (<strong>…</strong>)</p>
<p>Sometimes a double-exclamation (<strong>!!</strong>) mark may appear somewhere – this is only a reminder for myself to fix an issue at that point in the documentation. These reminders will eventually disappear.</p>
<p>I tend to use ‘ssh’ as a verb - it is not really correct to do this, but it really is a verb in my life. So I apologize if it annoys you.</p>
<p>If you discover issues with instructions in this document, or have other comments or suggestions then you can contact me on <a href="https://github.com/deatrich/">my github project page</a>.</p>
<!-- -->
<h1 id="chapter-02">Picking the OS (Operating System) and the window manager</h1>
<h2 id="ubuntu-lts">Ubuntu LTS</h2>
<p>Though many Raspberry Pi owners run the Raspberry Pi OS (formerly known as Raspbian), in this guide I chose to use Ubuntu. <a href="https://releases.ubuntu.com/">Ubuntu LTS</a> is a long-term support Debian-based Linux OS. Ubuntu is renowned for its desktop support, but it also provides a comfortable home server experience.</p>
<p>A server should be stable. We want to apply software updates, but we also want to avoid the need to update the major version of the base OS every year. The Official Gnome LTS releases with the Gnome desktop environment in the <em>main</em> software repository are supported for up to 5 years from the time of the initial release, and for up to 10 years with extended security-only updates via <a href="https://ubuntu.com/pro/tutorial">Ubuntu Advantage</a> access<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>, also known as <em>Expanded Security Maintenance</em> (ESM).</p>
<p>Without ESM not all repositories get the same level of support. For example, the community-supported desktop environments located in the <em>universe</em> software repository only get best-effort maintenance from Canonical and the Ubuntu community. Nonetheless, most critical services are installed from the base repository, and thus have excellent functional and security support.</p>
<p>However with an <em>ESM/Advantage/Pro</em> account, then all packages get security updates for 10 years from initial release. This change was introduced <a href="https://discourse.ubuntu.com/t/ubuntu-pro-faq/34042">in January of 2023</a>.</p>
<p>As with all OS distributions the versions of major software stay with the initial release, and patches to the software are for bugs and security issues for those software versions.</p>
<p>Generally you should think about upgrading your server OS every few years so that you stay in touch with current technologies, and so that you benefit from newer software versions.</p>
<p>At the time of writing this guide I used version 22.04 of Ubuntu LTS (also known as <strong>Jammy Jellyfish</strong>). It was first released in April 2022, as indicated by the release number.</p>
<h2 id="subscribing-to-a-few-mailing-lists">Subscribing to a few mailing lists</h2>
<p>If you are a going to be using Ubuntu then it is wise to subscribe to a few mailing lists. There are <a href="https://lists.ubuntu.com/">lots of them</a>, but a few low volume ones like these are a good idea:</p>
<ul>
<li><a href="https://lists.ubuntu.com/mailman/listinfo/ubuntu-security-announce">Ubuntu Security Announce</a>
<ul>
<li>Low-traffic announcement list for notifications of security updates for Ubuntu</li>
</ul></li>
<li><a href="https://lists.ubuntu.com/mailman/listinfo/ubuntu-announce">Ubuntu Announce</a>
<ul>
<li>Low-traffic Ubuntu Announcements</li>
</ul></li>
</ul>
<h2 id="mate-desktop">MATE desktop</h2>
<p>I also opt to use an installation image which uses the <a href="https://mate-desktop.org/">MATE desktop system</a> – at the bottom of that linked website is a note about why it is called MATE (pronounced mat-ay). The MATE window manager is intuitive, efficient, skinny, dependable and popular. It is widely available on most flavours of Linux. MATE is not flashy, but it gets the job done.</p>
<p>Even though we are creating a home server, it is useful to configure the server to provide a remote graphical desktop environment – this is why in this guide we use the desktop image rather than the server image. Then you can use the desktop for fun, learning, or perhaps as your Linux development environment from other devices. Accessing the desktop remotely is also documented in this guide.</p>
<p>This installation image still uses the <a href="https://en.wikipedia.org/wiki/X.Org_Server">X.org display server</a> instead of <a href="https://en.wikipedia.org/wiki/Wayland_(protocol)#Wayland_compositors">Wayland</a>, partly because it uses MATE which is not yet ready for Wayland at this Ubuntu LTS release, and also because this build is for the Raspberry Pi, where Wayland support is new. Moreover remote desktop support is a work in progress for Wayland environments, and is better left to the X.org protocol for now.</p>
<!-- -->
<h1 id="chapter-03">Creating the installation disk</h1>
<p>You will need a new or repurposed microSD card with a capacity of at least 32 GB – since this is a server we might want to store lots of photos or videos on it. See <a href="https://ubuntu-mate.org/raspberry-pi/">the Ubuntu MATE website</a> for some examples of microSD cards. Recently I was able to buy a 256 GB Silicon Power microSD card for less than $25 Cdn on Amazon; this brand is rated highly for use on Raspberry Pi’s by testers like <a href="https://www.tomshardware.com/best-picks/raspberry-pi-microsd-cards">Tom’s Hardware</a>.</p>
<p>Go to <a href="https://ubuntu-mate.org/raspberry-pi/download/">the Ubuntu MATE download website</a> to download your image - for a Pi 4 generation with 4 or more GB of RAM the 64-bit ARM architecture (arm64) is best. For the version I used in March 2023 the image name was:<br />
<em>ubuntu-mate-22.04-desktop-arm64+raspi.img.xz</em>.</p>
<p>There are many instructions available online to help you download the disk image and install it onto installation media - I will not reproduce the instructions here. How you create the image depends on your home computing device and its OS. There is a helpful <a href="https://ubuntu.com/tutorials/how-to-install-ubuntu-desktop-on-raspberry-pi-4#2-prepare-the-sd-card">tutorial</a> on creating the installation image using the Raspberry Pi Imager software for 3 operating systems:</p>
<ul>
<li><a href="https://downloads.raspberrypi.org/imager/imager_latest.exe">Windows OS</a></li>
<li><a href="https://downloads.raspberrypi.org/imager/imager_latest.dmg">MacOS</a></li>
<li><a href="https://downloads.raspberrypi.org/imager/imager_latest_amd64.deb">Debian-based Linux</a></li>
</ul>
<p>After installing the disk image on the microSD the disk partitioning looks like this using the <em>fdisk</em> command. I show it here so that you are aware of what is going on under the hood. Here is an example of a 256 GB microSD inserted into a USB card reader on another Linux computer where the card showed up as /dev/sde:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a><span class="kw">$ sudo fdisk -l /dev/sde</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a>Disk /dev/sde: 231.68 GiB, 248765218816 bytes, 485869568 sectors</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a>Disk model: FCR-HS3       -3</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true"></a>...</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true"></a>Disklabel type: dos</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true"></a>Disk identifier: 0x11d94b9e</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true"></a>Device     Boot  Start      End  Sectors  Size Id Type</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true"></a>/dev/sde1  *      2048   499711   497664  243M  c W95 FAT32 (LBA)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true"></a>/dev/sde2       499712 12969983 12470272  5.9G 83 Linux</span></code></pre></div>
<p>There are 2 partitions; the first (/dev/sde1) is a small boot partition whose type is FAT32, and the second (/dev/sde2) is the minimal 6 GB Linux partition. Though this microSD is 256 GB, only the first 6 GB is currently used. The automatic installation process will expand the partition right to the maximum extend of its partition or of un-allocated space. Most Linux installation images allow you to choose your disk partitioning; the Raspberry Pi Ubuntu installation image does not.</p>
<p>However, it is possible and useful to <a href="#mod-partition">modify the pre-installation partitioning</a> directly on the microSD card as described in the appendix.</p>
<p>In the appendix I also provide a generic Linux <a href="#image-cmds">command-line approach</a> to downloading, un-compressing and writing the image to the microSD card. If you are not yet very familiar with the command-line then leave this exercise for a later time in your Linux adventure.</p>
<!-- -->
<h1 id="chapter-04">Installation and first experience</h1>
<p>Once you have prepared your microSD card then insert it in your Raspberry Pi. Note that the card pushes in easily. It will only go in one way. On a Pi 400 you can eject it by gently <em>pushing on it once</em> and it will pop out enough to grab it. There is no need to pull on it to remove it because it essentially pops out. With a Pi 4b you will need to pull it out.</p>
<p>Turn the power on with the Pi connected to a monitor, USB keyboard and mouse. You will shortly see the firmware rainbow splash screen. Shortly after that there are a series of screens allowing you to customize the installation:</p>
<ul>
<li>pick your language</li>
<li>pick the keyboard layout language</li>
<li>enable the Wi-Fi network access if you want to have concurrent updates</li>
<li>select your timezone by clicking on your timezone region</li>
<li>enter your preferred name and your login name with a password – this is your login account. Document this if you are poor at remembering login and password details.</li>
</ul>
<p>As the installation starts it will show some informational screens to entertain you while it installs. Eventually it will reboot and present you with the login screen. Once you login you will see the default MATE desktop configuration.</p>
<p>Before going further immediately update the software on the system. The MATE installation image is not released often, so it can be a bit behind the package update curve. As well, any final configuration issues will be updated.</p>
<p>Open a terminal window by selecting:<br />
Application -&gt; System Tools -&gt; MATE Terminal<br />
and enter the following commands:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="co">// This will update the system&#39;s knowledge about what should be updated;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a><span class="co">// in other works, the cache of software package names pending for update:</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a><span class="kw">$ sudo apt update</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true"></a><span class="co">// then update the software; the command is actually &#39;upgrade&#39;, which is odd,</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true"></a><span class="co">// at least to me.. I like &#39;yum check-update&#39; and &#39;yum update&#39; much better...</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true"></a><span class="kw">$ sudo apt upgrade</span></span></code></pre></div>
<p>It will take a while. Once finished there is one more update to do before you reboot the system – the Raspberry Pi bootloader EEPROM update, in case there are pending updates to apply:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a><span class="co">// You can check the current state of firmware updates without being root.</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a><span class="co">// Here we see that the firmware is up-to-date, but the default bootloader</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true"></a><span class="co">// could be set to use the latest firmware:</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true"></a><span class="kw">$ rpi-eeprom-update</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true"></a>*** UPDATE AVAILABLE ***</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true"></a>BOOTLOADER: update available</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true"></a>   CURRENT: Thu 29 Apr 16:11:25 UTC 2021 (1619712685)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true"></a>    LATEST: Tue 25 Jan 14:30:41 UTC 2022 (1643121041)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true"></a>   RELEASE: default (/lib/firmware/raspberrypi/bootloader/default)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true"></a>            Use raspi-config to change the release.</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true"></a>  VL805_FW: Using bootloader EEPROM</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true"></a>     VL805: up to date</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true"></a>   CURRENT: 000138a1</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true"></a>    LATEST: 000138a1</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true"></a><span class="co">// now we need to be root since we want to apply the update:</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true"></a><span class="kw">$ sudo rpi-eeprom-update -a</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true"></a>*** INSTALLING EEPROM UPDATES ***</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true"></a>...</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true"></a>EEPROM updates pending. Please reboot to apply the update.</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true"></a>To cancel a pending update run &quot;sudo rpi-eeprom-update -r&quot;.</span></code></pre></div>
<p>Now reboot the server to get the newer kernel, and to complete the firmware update. On the far upper right taskbar, select the power button icon, and then select <em>Switch Off</em> -&gt; <em>Restart</em>.</p>
<h2 id="getting-going-with-the-command-line">Getting Going with the Command-Line</h2>
<p>For people without much command-line experience it is important to get going at the command-line. When logged into the MATE desktop open a terminal window by selecting Application -&gt; System Tools -&gt; MATE Terminal.</p>
<p>Try <a href="#eg-cmds">some command-line examples</a> in the appendix. Note that the up/down arrow keys can be used to recall your previous commands. You can edit and reuse an entry in your previous commands using the left/right arrow keys.</p>
<p>You will find that the ‘TAB’ key (shown below as <em>&lt;TAB&gt;</em>) is very useful for command-line completion.</p>
<p>Suppose you are going to use the command ‘timedatectl’. You start by typing the word ‘time’ and then hit the TAB key once, then again when you do not get a response. You will see 4 possible commands as shown below. Then to complete the command simply type d followed by another TAB and the full command will complete:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="kw">$ time&lt;TAB&gt;&lt;TAB&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a>time         timedatectl  timeout      times</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a><span class="kw">$ timed&lt;TAB&gt;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a><span class="kw">$ timedatectl </span></span></code></pre></div>
<p>Look online for some tutorials; there are millions of results on Google if you search for:</p>
<pre><code>    Linux &quot;command line&quot; tutorial for beginners</code></pre>
<p>See also the <a href="#command-list">list of all commands used in this guide</a>.</p>
<p>There are many Ubuntu-specific tutorials. You might want to check out these two:</p>
<ul>
<li><a href="https://ubuntu.com/tutorials/command-line-for-beginners">The Linux command line for beginners</a></li>
<li><a href="https://linuxconfig.org/ubuntu-server-tutorial-for-beginners">Ubuntu server tutorial for beginners</a></li>
</ul>
<!-- -->
<h1 id="chapter-05">Creating a Samba file sharing service</h1>
<p>We are going to create a Samba file sharing service on our server. Other devices like mobile phones, tablets, laptops and desktops running a variety of operating systems should be able to manage files in the designated data area.</p>
<p>We are not going to be really secure, in that we are allowing guest access. Presumably if you let your family and your guests connect to your network, then you would allow them to connect to your Samba server.</p>
<p>But as always, your internal home network should be well protected with at least a strong password for your wireless SSID connections.</p>
<h2 id="create-the-data-space-and-assign-appropriate-permissions.">Create the data space and assign appropriate permissions.</h2>
<p>First, visit <a href="#data-area">Setting Up a Data Area</a> in the appendix to find out how to create your data area.</p>
<p>Always use a sub-directory inside the data area to begin any new project. One of the advantages is that the <a href="https://www.baeldung.com/linux/lost-found-directory">lost+found</a> directory does not become part of your project. For this Samba project we will create <em>/data/shared</em>.</p>
<p>For Samba the top level ownership of the samba area will be a user named ‘nobody’. This user is always created in Linux systems and has no login shell, so ‘nobody’ cannot log in. It is a safer user identity to use for guest access to Samba shares.</p>
<p>We set the access permissions using chmod<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> and chown<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a><span class="kw">$ cd /data</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a><span class="kw">$ sudo mkdir shared</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true"></a><span class="kw">$ sudo chown nobody:nogroup shared</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true"></a><span class="kw">$ sudo chmod g+ws shared</span></span></code></pre></div>
<p>Here are 3 example directories to create for differing purposes:<br />
‘Music’, ‘Protected’ and ‘Test’<br />
other examples might be ‘Videos’ and ‘Pictures’:</p>
<p>You will be able to create directories inside the shared area using your other devices as well.</p>
<p>I use the Test area initially for testing from various devices; that is, create and delete files in the test directory.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true"></a><span class="kw">$ cd /data/shared</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true"></a><span class="kw">$ sudo mkdir Test</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true"></a><span class="kw">$ sudo chown nobody:nogroup Test</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true"></a><span class="kw">$ sudo chmod g+ws Test</span></span></code></pre></div>
<p>I like having a general ‘Protected’ area that others can access but cannot change. I use secure-shell access to that area for dumping files that I manage without using Samba tools.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a><span class="kw">$ cd /data/shared</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true"></a><span class="kw">$ sudo mkdir Protected</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true"></a><span class="kw">$ sudo chown myname:mygroup Protected</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true"></a><span class="kw">$ sudo chmod g+ws Protected</span></span></code></pre></div>
<p>As an example I put my old Music files in ‘Music’ so that it could be accessed from various devices 24x7. You can either keep the permissions as <em>nobody:nogroup</em>, allowing other people in your home network to help manage the collection, or you can change ownership so that only you manage them locally. In this example my login name is ‘myname’ with group ‘mygroup’:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true"></a><span class="kw">$ du -sh /data/shared/Music/</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true"></a>7.4G    /data/shared/Music/</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true"></a><span class="kw">$ ls -la /data/shared/Music/</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true"></a>drwxr-sr-x  9 myname mygroup   4096 Apr 15 16:03 .</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true"></a>drwxrwsr-x  7 nobody nogroup   4096 Feb 26 11:59 ..</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true"></a>-rw-r--r--  1 myname mygroup 108364 Feb 27  2022 all.m3u</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true"></a>drwxr-xr-x  9 myname mygroup   4096 Feb 26  2022 Celtic</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true"></a>-rw-r--r--  1 myname mygroup  13373 Mar  6  2022 Celtic.m3u</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true"></a>...</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true"></a>drwxr-xr-x  5 myname mygroup   4096 Feb 27  2022 Nostalgia</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true"></a>-rw-r--r--  1 myname mygroup   6145 Feb 27  2022 Nostalgia.m3u</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true"></a>drwxr-xr-x 13 myname mygroup   4096 Feb 26  2022 Pop</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true"></a>-rw-r--r--  1 myname mygroup  10065 Feb 27  2022 Pop.m3u</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true"></a>drwxr-xr-x 39 myname mygroup   4096 Feb 26  2022 Rock</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true"></a>-rw-r--r--  1 myname mygroup  41656 Feb 27  2022 Rock.m3u</span></code></pre></div>
<h2 id="install-the-samba-software">Install the Samba software</h2>
<p>Simply install the <em>samba</em> package; <em>apt</em> will pull in any dependencies:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true"></a><span class="kw">$ sudo apt install samba</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true"></a>...</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true"></a>0 upgraded, 21 newly installed, 0 to remove and 3 not upgraded.</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true"></a>Need to get 7,870 kB of archives.</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true"></a>After this operation, 44.1 MB of additional disk space will be used.</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true"></a>Do you want to continue? [Y/n] </span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true"></a>...</span></code></pre></div>
<h2 id="modify-the-samba-configuration-file">Modify the Samba configuration file</h2>
<p>The main configuration file is:<br />
<em>/etc/samba/smb.conf</em></p>
<p>The file is organized into sections:</p>
<ul>
<li>the <em>global</em> section</li>
<li>the <em>printers</em> section (which we will simply ignore, or you can comment it out)</li>
<li>any other <strong>shares</strong> that you create; in this example I create one named <em>home</em></li>
</ul>
<p>Here are the specifics:</p>
<ul>
<li>Global Section
<ol type="1">
<li>In the global section change the <em>workgroup</em> name to something you like; I have chosen <em>LINUX</em></li>
<li>Just below the workgroup definition we add some <a href="https://www.samba.org/samba/docs/current/man-html/vfs_fruit.8.html">vfs_fruit</a> module options that allow Apple SMB clients to interact with the server</li>
<li>we add a logging option to increase some logging for debugging purposes</li>
</ol></li>
<li>Our ‘share’ section named <em>home</em></li>
</ul>
<p>The <a href="https://raw.githubusercontent.com/deatrich/linux-home-server/main/examples/smb.conf">modified smb.conf file</a> is in github.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true"></a><span class="kw">$ cd /etc/samba</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true"></a><span class="kw">$ sudo cp -p smb.conf smb.conf.orig</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true"></a><span class="kw">$ sudo nano smb.conf</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true"></a><span class="co">// The &#39;diff&#39; command shows differences in snippets with the line numbers</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true"></a><span class="co">// A more elegant way to see the differences would be side-by-side:</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true"></a><span class="co">//   diff --color=always -y smb.conf.orig smb.conf | less -r </span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true"></a><span class="kw">$ diff smb.conf.orig smb.conf</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true"></a>29c29,30</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true"></a>&lt;    workgroup = WORKGROUP</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true"></a>---</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true"></a>&gt; #   workgroup = WORKGROUP</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true"></a>&gt;    workgroup = LINUX</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true"></a>33a35,39</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true"></a>&gt; # for Apple SMB clients</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true"></a>&gt;    fruit:nfs_aces = no</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true"></a>&gt;    fruit:aapl = yes</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true"></a>&gt;    vfs objects = catia fruit streams_xattr</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true"></a>&gt; </span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true"></a>62a69,70</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true"></a>&gt;    log level = 1 passdb:3 auth:3</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true"></a>&gt; </span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true"></a>241a250,259</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true"></a>&gt; </span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true"></a>&gt; [home]</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true"></a>&gt;     comment = Samba on Raspberry Pi</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true"></a>&gt;     path = /data/shared</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true"></a>&gt;     writable = yes</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true"></a>&gt;     read only = no</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true"></a>&gt;     browsable = yes</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true"></a>&gt;     guest ok = yes</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true"></a>&gt;     create mask = 0664</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true"></a>&gt;     directory mask = 0775</span></code></pre></div>
<h2 id="restart-the-service-and-check-log-files">Restart the service and check log files</h2>
<div class="sourceCode" id="cb14"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true"></a><span class="kw">$ sudo systemctl restart smbd nmbd</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true"></a><span class="kw">$ systemctl status smbd | grep Status:</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true"></a>     Status: &quot;smbd: ready to serve connections...&quot;</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true"></a><span class="kw">$ systemctl  status nmbd | grep Status:</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true"></a>     Status: &quot;nmbd: ready to serve connections...&quot;</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true"></a><span class="co">// </span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true"></a><span class="kw">$ cd /var/log/samba</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true"></a><span class="kw">$ ls -ltr</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true"></a>total 2168</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true"></a>drwx------ 5 root root    4096 May  7 09:45 cores/</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true"></a>-rw-r--r-- 1 root root     369 May  7 10:03 log.desktop</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true"></a>-rw-r--r-- 1 root root       0 May  7 10:08 log.ubuntu</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true"></a>-rw-r--r-- 1 root root    9000 May  7 10:51 log.192.168.1.82</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true"></a><span class="kw">$ tail log.192.168.1.82</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true"></a>[2023/05/07 10:51:01.059310,  3] ../../source3/auth/auth.c:201(auth_check_ntlm_password)</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true"></a>  check_ntlm_password:  Checking password for unmapped user ... with the new password interface</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true"></a>[2023/05/07 10:51:01.059391,  3] ../../source3/auth/auth.c:204(auth_check_ntlm_password)</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true"></a>  check_ntlm_password:  mapped user is: [LINUX]\[guest]@[UBUNTU]</span></code></pre></div>
<h2 id="run-some-tests">Run some tests</h2>
<p>Tests to run to validate functionality include the following:</p>
<ol type="1">
<li>Create a folder for your personal use</li>
<li>Browse to the Test folder</li>
<li>Copy and Paste a file from your device here</li>
<li>Create a folder here too, and copy your file into that folder</li>
<li>Delete all files and folders inside the Test folder</li>
</ol>
<p>Testing will depend on your device and client.</p>
<p><em>Suppose you have an Android phone</em>. Download the App named <a href="https://cxfileexplorer.com/">Cx File Explorer</a> from your App Store. Under its <em>Network</em> tab you can open a ‘remote’ Samba share in your home network. You enter in the IP address of the Pi server and select ‘Anonymous’ as the user instead of user/pass.</p>
<p>(!! get an example from Windows and from an iphone)</p>
<p><em>Suppose you have a MATE desktop session</em> on your Pi server or on another Linux device. Open a file browser:</p>
<p>Applications -&gt; Accessories -&gt; Files</p>
<p>The Files browser ‘File’ menu has an option: <em>Connect to Server</em>. If you have an older version of Mate then find the help option and search for ‘Connect to Server’.</p>
<p>A small connection window pops up. It is a bit annoying, so select any options that allow the file browser to remember your entries, and also create a bookmark.</p>
<p>There is no Samba password for ‘guest’, but the connection window will want one anyway; so give it the password ‘guest’ to make it happy.</p>
<p>At this point an application named <a href="https://wiki.gnome.org/Apps/Seahorse">seahorse</a> might pop up. It is the GNOME encryption interface, and you can store passwords and keys in it. I don’t use it, but you might want to for this Samba share. You can always cancel the seahorse window.</p>
<p>For the connection request, fill in this data:</p>
<ul>
<li>Enter the IP address of your Pi server</li>
<li>Select ‘Type’ Windows share</li>
<li>Enter the share name: home</li>
<li>Clear the Folder option</li>
<li>Enter the domain name: LINUX (or whatever name you chose in smb.conf)</li>
<li>User name: guest</li>
<li>Password: guest (and select the option to remember it for seahorse)</li>
<li>tick ‘add bookmark’ and give it a name</li>
</ul>
<p>and finally connect.</p>
<!-- -->
<h1 id="chapter-06">Backing up your server</h1>
<p>Always, always, do some kind of backups on your server. For system backups, very little actually needs to be backed up, yet it is important to get into a frame of mind where you think about these things. Let’s look at what you should back up on your server, and how you might do it.</p>
<p>There is no need to back up everything - you can always reinstall and reconfigure. This is my favourite list of system directories to back up:</p>
<ul>
<li>/etc – a lot of system configuration is in this directory. Some important configuration files found here are: the host’s secure-shell keys, user account details, and most server configuration changes</li>
<li>/home – this is where your user account resides</li>
<li>/root – this is the super-user’s home directory</li>
<li>/var/log – system log files are here; for forensic reasons I back them up</li>
<li>/var/spool – in case you have personalized cron job entries</li>
<li>/var/www – if you have a web server then it’s data files are usually here</li>
</ul>
<p>If you are playing with database services then you need to inform yourself which directories and/or data exports should be added and/or used for backups. Note that when you have created a Samba or an NFS server you will have other data directories to back up, and these directories might be large.</p>
<p>A <a href="#backups">backup process and a link to an example backup script</a> are in the appendix. We look at backing up both system and data directories, including the backup of large directories. Compressed system directories are typically small. But /home and /data/shared might be large. Be aware of your space needs, and adjust backups accordingly.</p>
<h2 id="recovering-files-from-backups">Recovering files from backups</h2>
<p>Recovering files from backups is fairly easy. It is best to use an empty directory with adequate space. In this example we recover files from compressed tar files. We unpack the tar files <em>etc.tgz</em> and <em>home.tgz</em> in the empty directory, and then move or copy any files into place in the file system. Example:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true"></a><span class="co">// This example unpacks home.tgz and etc.tgz.  Do this with sudo so that</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true"></a><span class="co">// files are unpacked with the correct permissions.</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true"></a><span class="kw">$ sudo mkdir /var/local-recovery</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true"></a><span class="co">// We can copy files from the local backup tree: /var/local-backups/</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true"></a><span class="co">// or from the external drive once we mount it:  /mnt/backups/</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true"></a><span class="co">// So use the needed pathname instead of &#39;/path/to/&#39; below:</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true"></a><span class="kw">$ sudo cp -ip /path/to/home.tgz /path/to/etc.tgz  /var/local-recovery/</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true"></a><span class="kw">$ cd /var/local-recovery</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true"></a><span class="kw">$ sudo tar -zxf etc.tgz</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true"></a><span class="kw">$ sudo tar -zxf home.tgz</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true"></a><span class="kw">$ sudo rm etc.tgz home.tgz</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true"></a><span class="kw">$ ls -l </span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true"></a>drwxr-xr-x 152 root root 12288 Jun  1 10:56 etc</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true"></a>drwxr-xr-x   3 root root  4096 May 25 10:45 home</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true"></a><span class="kw">$ ls -l home/</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true"></a>drwxr-x--- 25 myname myname 4096 Jun  1 21:12 myname</span></code></pre></div>
<p>If you need to recover files from large directory backups then you can copy the files directly from the removable media to your target directories. For large directory backups we do not compress the backed up files, since it takes some time and may introduce an additional disk space problem.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true"></a><span class="co">// This example recovers a directory inside the large directory backup of</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true"></a><span class="co">// /home.  First mount the USB drive -- the example partition here is at</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true"></a><span class="co">// /dev/sda1:</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true"></a><span class="kw">$ sudo mount /dev/sda1 /mnt</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true"></a><span class="kw">$ cd /mnt/rsyncs</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true"></a><span class="kw">$ ls</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true"></a>0  3  5  copy</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true"></a><span class="kw">$ cd 0/home/myname/</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true"></a><span class="kw">$ ls</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true"></a>bin  doc  downloads  etc  git  icons  inc  lib  src</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true"></a></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true"></a><span class="co">// Since the files are my files then I do not need to use &#39;sudo&#39;.</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true"></a><span class="co">// Here I am recovering my &#39;bin&#39; directory.</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true"></a><span class="co">// Note that I copy it to a different directory name so that I have the</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true"></a><span class="co">// option of comparing any existing &#39;bin&#39; directory in my home.</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true"></a><span class="kw">$ cp -a bin ~/bin.recovered</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true"></a></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true"></a><span class="co">// Change directories away from the USB drive so that you can unmount it.</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true"></a><span class="co">// You cannot unmount a file system if you are parked in it:</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true"></a><span class="kw">$ cd </span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true"></a><span class="kw">$ sudo umount /mnt</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true"></a><span class="kw">$ pwd</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true"></a>/home/myname</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true"></a><span class="kw">$ diff -r bin bin.recovered</span></span></code></pre></div>
<!-- -->
<h1 id="chapter-07">Server customization</h1>
<p>Here is a list of tasks you can apply to your server for 24x7 service. Ubuntu installations are more common on laptops and desktops which are often connected via wireless, are turned on and off frequently, and have a lot of software configuration not usually present or needed on a server.</p>
<p>The main objective here is to show you some options that reduce complexity and memory consumption, and might improve security and reliability. You can always circle back here in the future and try them, or just try any one topic which interests you.</p>
<p>By all means, ignore all of this if you don’t want to be bothered with disabling extraneous software. I have spent 3 decades managing UNIX and Linux systems, so I can be a bit picky about what runs on my systems.</p>
<h2 id="turn-off-bluetooth">Turn off Bluetooth</h2>
<p>If you won’t be using it on your server then turn Bluetooth off.</p>
<p>The Pi does not have a BIOS like personal computers do; instead configuration changes to enable or disable devices are made in the configuration file <em>config.txt</em> in the directory <em>/boot/firmware/</em></p>
<!-- at some point discuss the lack of a RTC and its effect
on logging, etc. on SBC devices -->
<p>You will need to eventually reboot the server once you have made this change. If you also disable WiFi then wait until you have finished the next task, or any other tasks in this chapter.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true"></a><span class="co">// List bluetooth devices:</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true"></a><span class="kw">$ hcitool dev</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true"></a>Devices:</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true"></a>        hci0    E4:5F:01:A7:22:56</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true"></a><span class="co">// disable bluetooth services running on the Pi</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true"></a><span class="kw">$ sudo systemctl disable blueman-mechanism bluetooth</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true"></a><span class="co">// Always save a copy of the original file with the &#39;cp&#39; command:</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true"></a><span class="kw">$ cd /boot/firmware</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true"></a><span class="kw">$ sudo cp -p config.txt config.txt.orig</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true"></a><span class="co">// Disable bluetooth in config.txt by adding &#39;dtoverlay=disable-bt&#39; at the end</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true"></a><span class="kw">$ sudo nano config.txt</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true"></a><span class="co">// Use the &#39;tail&#39; command to see the end of the file:</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true"></a><span class="kw">$ tail -3 config.txt</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true"></a></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true"></a>dtoverlay=disable-bt</span></code></pre></div>
<h2 id="turn-off-wireless">Turn Off wireless</h2>
<p>If you will use the built-in ethernet interface for networking on your server then turn WiFi off. I prefer wired connections for servers, especially since newer technology offers gigabit speed ethernet. In my experience, the network latency is usually better to wired devices. But if you prefer to keep the server on wireless then skip this task.</p>
<p>You will need to reboot the server once you have made this change, but <strong>remember to connect the ethernet cable</strong> on the Pi to your home router first!</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true"></a><span class="co">// List wireless devices - after making this change you will not see this</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true"></a><span class="co">// information:</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true"></a><span class="kw">$ iw dev</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true"></a>phy#0</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true"></a>        Unnamed/non-netdev interface</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true"></a>                wdev 0x2</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true"></a>                addr e6:5f:01:a7:71:0d</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true"></a>                type P2P-device</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true"></a>                txpower 31.00 dBm</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true"></a>        Interface wlan0</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true"></a>                ifindex 3</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true"></a>                wdev 0x1</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true"></a>                addr e4:5f:01:a7:22:55</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true"></a>                ssid MYNET</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true"></a>                type managed</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true"></a>                channel 104 (5520 MHz), width: 80 MHz, center1: 5530 MHz</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true"></a>                txpower 31.00 dBm</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true"></a></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true"></a><span class="co">// Disable wireless in config.txt by adding &#39;dtoverlay=disable-wifi&#39; at the end</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true"></a><span class="kw">$ cd /boot/firmware</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true"></a><span class="kw">$ sudo nano config.txt</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true"></a><span class="co">// Use the &#39;tail&#39; command to see the end of the file:</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true"></a><span class="fu"># tail -3 config.txt</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true"></a></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true"></a>dtoverlay=disable-bt</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true"></a>dtoverlay=disable-wifi</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true"></a></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true"></a><span class="co">// After rebooting the Pi disable the wireless authentication service</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true"></a><span class="kw">$ sudo systemctl stop wpa_supplicant</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true"></a><span class="kw">$ sudo systemctl disable wpa_supplicant</span></span></code></pre></div>
<h2 id="install-a-simulated-hardware-clock">Install A simulated hardware clock</h2>
<p>SBC’s like the Raspberry Pi do not have a <a href="https://en.wikipedia.org/wiki/Real-time_clock">real-time clock (RTC)</a>, whereas more complex systems like desktops and laptops do.</p>
<p>You can <a href="https://www.pishop.ca/product/ds3231-real-time-clock-module-for-raspberry-pi/">buy an RTC for the Pi</a>, or you can install a package that fakes some of the functionality of a hardware clock:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true"></a><span class="kw">$ sudo apt install fake-hwclock</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true"></a>...</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true"></a>Setting up fake-hwclock (0.12) ...</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true"></a>Created symlink /etc/systemd/system/sysinit.target.wants/fake-hwclock.service ...</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true"></a>update-rc.d: warning: start and stop actions are no longer supported; falling back to defaults</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true"></a><span class="co">// The package complains about unsupported start/stop actions, so it does</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true"></a><span class="co">// not start the fake clock; simply start it yourself:</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true"></a><span class="kw">$ systemctl status fake-hwclock</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true"></a>  fake-hwclock.service - Restore / save the current clock</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true"></a>     Loaded: loaded (/lib/systemd/system/fake-hwclock.service; enabled; vendor &gt;</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true"></a>     Active: inactive (dead)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true"></a>       Docs: man:fake-hwclock(8)</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true"></a><span class="kw">$ sudo systemctl start fake-hwclock</span></span></code></pre></div>
<p>Without this package you will notice that the timestamps at startup are wildly wrong. For example when you look at snippets of the ‘last’ logged in users, the logs about reboots are always odd, but once you have installed the fake clock then reboot times are in line with real world time:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true"></a><span class="co">// without fake-hwclock:</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true"></a><span class="kw">$ last | less</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true"></a>...</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true"></a>myname   pts/1        desktop.home     Wed Jul 12 14:34 - 15:51  (01:17)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true"></a>myname   pts/0        desktop.home     Wed Jul 12 14:28 - 14:46  (00:17)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true"></a>reboot   system boot  5.15.0-1033-rasp Mon Mar 20 08:33 - 09:30 (115+00:56)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true"></a>myname   pts/4        desktop.home     Tue Jul 11 18:13 - 23:44  (05:31)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true"></a>myname   pts/2        desktop.home     Tue Jul 11 16:29 - 18:21  (01:52)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true"></a>myname   pts/2        desktop.home     Tue Jul 11 16:10 - 16:24  (00:14)</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true"></a></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true"></a><span class="co">// with fake-hwclock:</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true"></a>...</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true"></a>root     pts/0        ubuntu.home      Wed Jul 26 10:39   still logged in</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true"></a>reboot   system boot  5.15.0-1034-rasp Wed Jul 26 10:38   still running</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true"></a>myname   pts/2        desktop.home     Wed Jul 26 10:37 - 10:37  (00:00)</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true"></a>root     pts/1        ubuntu.home      Wed Jul 26 10:15 - down   (00:23)</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true"></a>myname   pts/0        desktop.home     Wed Jul 26 10:11 - 10:38  (00:27)</span></code></pre></div>
<h2 id="enable-boot-up-console-messages">Enable boot-up console messages</h2>
<p>Maybe like me you like seeing informational messages as a computer boots up. In that case you need to edit <em>/boot/firmware/cmdline.txt</em> and remove the <em>quiet</em> argument. On my system this one line file now ends in:<br />
‘… fixrtc splash’<br />
instead of<br />
‘… fixrtc quiet splash’:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true"></a><span class="kw">$ cd /boot/firmware</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true"></a><span class="kw">$ sudo cp -p cmdline.txt cmdline.txt.orig</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true"></a><span class="kw">$ sudo nano cmdline.txt</span></span></code></pre></div>
<h2 id="disable-the-graphical-login-interface">Disable the graphical login interface</h2>
<p>Simpler is better for a server. Normally 24x7 servers are headless, mouseless, keyboardless, and sit in the semi-darkness. A graphics-based console is therefore useless. Though your home server might not be as lonely as a data centre server, you might want to try a text-based console:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true"></a><span class="kw">$ sudo systemctl set-default multi-user</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true"></a><span class="kw">$ sudo systemctl stop display-manager</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true"></a><span class="co">// If you do have a mouse and a screen attached then you can still make </span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true"></a><span class="co">// the mouse work in a text console login -- it can be useful.  At work</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true"></a><span class="co">// I have sometimes used the mouse at a console switch to quickly copy and</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true"></a><span class="co">// paste process numbers for the kill command.</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true"></a><span class="kw">$ sudo apt install gpm</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true"></a><span class="kw">$ sudo systemctl status gpm</span></span></code></pre></div>
<h2 id="disable-snap-infrastructure">Disable Snap infrastructure</h2>
<p>Ubuntu promotes another kind of software packaging called <strong>Snaps</strong> (which includes an <em>App</em> store). Some users are not pleased with issues introduced by the underlying support software, and decide to <a href="https://onlinux.systems/guides/20220524_how-to-disable-and-remove-snap-on-ubuntu-2204">delete Snap support</a> from their systems. In my early testing of Ubuntu LTS 22.04 I also ran into the problem of firefox not able to start, and like others I traced it back to snap (firefox is installed from a Snap package).</p>
<p>My opinion is that ‘Snaps’ are not meant for a server environment, and so I remove the associated software. I certainly find it distasteful to have more than a dozen mounted loop devices cluttering up output of block device commands for a handful of snap packages. I would rather free up the memory footprint and <a href="https://www.redhat.com/sysadmin/inodes-linux-filesystem">inodes</a> for other purposes.</p>
<p>But if you like ‘Snaps’ then skip to the next topic.</p>
<p>Here is a quick summary on removing Snap support, that is, all snap packages and the snapd daemon:</p>
<h4 id="disable-the-daemon">Disable the daemon</h4>
<p>You should close firefox if it is running in a desktop setting. Then disable the snapd services and socket:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true"></a><span class="kw">$ sudo systemctl disable snapd snapd.seeded snapd.socket</span></span></code></pre></div>
<h4 id="remove-the-packages">Remove the packages</h4>
<p>List the Snap packages installed, and then delete them. Leave <em>base</em> and <em>snapd</em> packages until the end. As noted in <a href="https://onlinux.systems/guides/20220524_how-to-disable-and-remove-snap-on-ubuntu-2204">Erica’s instructions</a> remove packages one at a time and watch for messages warning about dependencies. This is my list of Snap packages; your list might be different depending on what you have installed:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true"></a><span class="kw">$ snap list</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true"></a>Name                       Version           ...  Publisher      Notes</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true"></a>bare                       1.0               ...  canonical     base</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true"></a>core20                     20230404          ...  canonical     base</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true"></a>core22                     20230404          ...  canonical     base</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true"></a>firefox                    112.0.2-1         ...  mozilla       -</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true"></a>gnome-3-38-2004            0+git.6f39565     ...  canonical     -</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true"></a>gnome-42-2204              0+git.587e965     ...  canonical     -</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true"></a>gtk-common-themes          0.1-81-g442e511   ...  canonical     -</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true"></a>snapd                      2.59.2            ...  canonical     snapd</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true"></a>snapd-desktop-integration  0.9               ...  canonical     -</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true"></a>software-boutique          0+git.0fdcecc     ...  flexiondotorg classic</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true"></a>ubuntu-mate-pi             0+git.0f0bcdf     ...  ubuntu-mate   -</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true"></a>ubuntu-mate-welcome        22.04.0-a59036a6  ...  flexiondotorg classic</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true"></a></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true"></a><span class="kw">$ sudo snap remove firefox</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true"></a><span class="kw">$ sudo snap remove software-boutique</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true"></a><span class="kw">$ sudo snap remove ubuntu-mate-welcome</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true"></a><span class="kw">$ sudo snap remove ubuntu-mate-pi</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true"></a><span class="kw">$ sudo snap remove snapd-desktop-integration</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true"></a><span class="kw">$ sudo snap remove gtk-common-themes</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true"></a><span class="kw">$ sudo snap remove gnome-42-2204</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true"></a><span class="kw">$ sudo snap remove gnome-3-38-2004</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true"></a><span class="kw">$ sudo snap remove core22</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true"></a><span class="kw">$ sudo snap remove core20</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true"></a><span class="kw">$ sudo snap remove bare</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true"></a><span class="kw">$ sudo snap remove snapd</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true"></a></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true"></a><span class="kw">$ snap list</span></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true"></a>No snaps are installed yet. Try &#39;snap install hello-world&#39;.</span></code></pre></div>
<h4 id="clean-up-snap-loose-ends-and-add-a-new-firefox-dpkg-source">Clean up SNAP loose-ends and add a new firefox dpkg source</h4>
<p>Completely remove snapd and its cache files from the system.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true"></a><span class="kw">$ sudo apt autoremove --purge snapd</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true"></a><span class="kw">$ sudo rm -rf /root/snap</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true"></a><span class="kw">$ rm -rf ~/snap</span></span></code></pre></div>
<p>As well, you can clean up ‘PATH’ environment variables and remove ‘snap’ from them. I also take the opportunity to fix issues that bother me. I have never overly trusted binaries in /usr/local/ (having supported them in the old commercial UNIX world) so I either push those paths to the end, or I remove them. I know that all directories in /usr/local/ are empty anyway, so I remove them:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true"></a><span class="kw">$ cd /etc</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true"></a><span class="kw">$ sudo cp -p environment environment.orig</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true"></a><span class="kw">$ sudo nano environment</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true"></a><span class="kw">$ diff environment.orig environment</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true"></a>1c1</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true"></a>&lt; PATH=&quot;/usr/local/sbin:/usr/local/bin:/usr/sbin:...:/usr/local/games:/snap/bin&quot;</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true"></a>---</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true"></a>&gt; PATH=&quot;/usr/sbin:/usr/bin:/sbin:/bin:/usr/games&quot;</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true"></a></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true"></a><span class="kw">$ sudo cp -p manpath.config manpath.config.orig</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true"></a><span class="kw">$ sudo nano manpath.config</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true"></a><span class="kw">$ diff manpath.config.orig manpath.config</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true"></a>22d21</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true"></a>&lt; MANDATORY_MANPATH                     /usr/local/share/man</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true"></a>33,36d31</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true"></a>&lt; MANPATH_MAP   /usr/local/bin          /usr/local/man</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true"></a>&lt; MANPATH_MAP   /usr/local/bin          /usr/local/share/man</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true"></a>&lt; MANPATH_MAP   /usr/local/sbin         /usr/local/man</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true"></a>&lt; MANPATH_MAP   /usr/local/sbin         /usr/local/share/man</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true"></a>68,69d62</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true"></a>&lt; MANDB_MAP     /usr/local/man          /var/cache/man/oldlocal</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true"></a>&lt; MANDB_MAP     /usr/local/share/man    /var/cache/man/local</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true"></a>72d64</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true"></a>&lt; MANDB_MAP     /snap/man               /var/cache/man/snap</span></code></pre></div>
<p>Then add configuration files for <em>apt</em> access to firefox <em>dpkg-based</em> packages. Finally install firefox from the Mozilla Personal Package Archive (PPA):</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true"></a><span class="co">// Create the necessary apt configurations for firefox:</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true"></a><span class="kw">$ sudo nano /etc/apt/preferences.d/firefox-no-snap</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true"></a><span class="kw">$ cat /etc/apt/preferences.d/firefox-no-snap</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true"></a>Package: firefox*</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true"></a>Pin: release o=Ubuntu*</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true"></a>Pin-Priority: -1</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true"></a></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true"></a><span class="kw">$ sudo add-apt-repository ppa:mozillateam/ppa</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true"></a>...</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true"></a>PPA publishes dbgsym, you may need to include &#39;main/debug&#39; component</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true"></a>Repository: &#39;deb https://ppa.launchpadcontent.net/.../ppa/ubuntu/ jammy main&#39;</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true"></a>Description:</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true"></a>Mozilla Team&#39;s Firefox stable + 102 ESR and Thunderbird 102 stable builds</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true"></a>Support for Ubuntu 16.04 ESM is included.</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true"></a>...</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true"></a></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true"></a><span class="co">// Install firefox</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true"></a><span class="kw">$ sudo apt install firefox</span></span></code></pre></div>
<h2 id="modify-the-swap-setup">Modify the swap setup</h2>
<p>There is a big 1 GB <a href="https://help.ubuntu.com/community/SwapFaq">swapfile</a> in the root of the file system - I find that offensive, so I moved it. If you are not as easily offended as I am then skip this topic.</p>
<p>It is a good idea to have some kind of swap enabled, since swap is only used if too much memory is being consumed by processes. Once memory is low the system will start using any configured swap on disk. Of course this is slower than memory, but it is better to use some swap at those moments instead of having an unfortunate process die <a href="https://docs.memset.com/cd/Linux%27s-OOM-Process-Killer.199066633.html">because of an out-of-memory condition</a>.</p>
<p>Over time if you never see swap being used then you could turn swap off and delete the swap file.</p>
<p>Here we create another 1 GB file – it can be much larger if needed; but if you need a lot of swap then you should investigate to see what is eating memory.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true"></a><span class="co">// check to see what the current swap usage is; in this case it is 0</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true"></a><span class="kw">$ free -t</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true"></a>           total       used        free    shared  buff/cache   available</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true"></a>Mem:     3881060     176900     3022600      5332      681560     3541748</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true"></a>Swap:    1048572          0     1048572</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true"></a>Total:   4929632     176900     4071172</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true"></a></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true"></a><span class="co">// Look at what systemd does with swap, and turn off the appropriate items</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true"></a><span class="kw">$ systemctl list-unit-files | grep swap</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true"></a>mkswap.service                              disabled        enabled</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true"></a>swapfile.swap                               static          -</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true"></a>swap.target                                 static          -</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true"></a></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true"></a><span class="co">// There will be a .swap rule for every swap file - this one is for /swapfile</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true"></a><span class="co">// and we want to get rid of it</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true"></a><span class="kw">$ sudo systemctl mask swapfile.swap</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true"></a>Created symlink /etc/systemd/system/swapfile.swap → /dev/null.</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true"></a></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true"></a><span class="co">// Even though the &#39;mkswap&#39; service is by default disabled, I also</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true"></a><span class="co">// mask it so that it doesn&#39;t come back from the dead - because it</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true"></a><span class="co">// will come back if you don&#39;t also mask that service</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true"></a><span class="kw">$ sudo systemctl mask mkswap.service</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true"></a>Created symlink /etc/systemd/system/mkswap.service → /dev/null.</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true"></a></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true"></a><span class="co">// turn current swap off so we can delete the old file</span></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true"></a><span class="kw">$ sudo swapoff -a</span></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true"></a><span class="kw">$ sudo rm /swapfile</span></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true"></a></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true"></a><span class="co">// Create an new swapfile in a subdirectory</span></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true"></a><span class="kw">$ sudo mkdir /swap</span></span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true"></a><span class="kw">$ sudo fallocate -l 1G /swap/swapfile</span></span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true"></a><span class="kw">$ sudo mkswap /swap/swapfile</span></span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true"></a>Setting up swapspace version 1, size = 1024 MiB (1073737728 bytes)</span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true"></a>no label, UUID=3e64d157-6f09-48d1-94c2-3851b82a73b7</span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true"></a></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true"></a><span class="co">// Protect the swap file and add it to /etc/fstab</span></span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true"></a><span class="kw">$ sudo chmod 600 /swap/swapfile</span></span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true"></a><span class="kw">$ sudo nano /etc/fstab</span></span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true"></a><span class="kw">$ grep swap /etc/fstab</span></span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true"></a>/swap/swapfile    none           swap defaults     0 0</span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true"></a></span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true"></a><span class="co">// Turn swap back on and check</span></span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true"></a><span class="kw">$ sudo swapon -a</span></span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true"></a><span class="kw">$ swapon</span></span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true"></a>NAME           TYPE  SIZE USED PRIO</span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true"></a>/swap/swapfile file 1024M   0B   -2</span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true"></a></span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true"></a><span class="co">// Note that systemd will show a new &#39;swap&#39; type named &#39;swap-swapfile.swap&#39;</span></span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true"></a><span class="kw">$ systemctl --type swap </span></span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true"></a>  UNIT               LOAD   ACTIVE SUB    DESCRIPTION   </span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true"></a>  swap-swapfile.swap loaded active active /swap/swapfile</span></code></pre></div>
<h2 id="remove-anacron-service">Remove <strong>anacron</strong> service</h2>
<p>UNIX and Linux has a mechanism called <em>cron</em> allowing servers to run commands at specific times and days. However personal and mobile computing is typically not powered on all the time. So operating systems like Linux have another mechanism called <em>anacron</em> which tries to run periodic cron-configured commands while the computer is still running. Since we are creating a 24x7 server we do not also need anacron – delete it:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true"></a><span class="kw">$ sudo apt remove anacron</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true"></a><span class="kw">$ sudo apt purge anacron</span></span></code></pre></div>
<h2 id="disable-various-unused-services">Disable various unused services</h2>
<p>Here are some services which normally can be disabled. Of course, if any of these services are interesting to you then keep them. Note that server processes are sometimes called <em>daemons</em>.</p>
<p>The <em>systemctl</em> command can handle multiple services at the same time, but doing them individually allows you to watch for any feedback. You can also simply disable these services without stopping them. They will not run on the next reboot.</p>
<h4 id="disable-modemmanager-hciuart-openvpn-and-cups">Disable ModemManager, hciuart, openvpn and cups</h4>
<div class="sourceCode" id="cb30"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true"></a><span class="co">// If you want to run a series of commands as root you can sudo to the bash</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true"></a><span class="co">// shell, run your commands, and then exit the shell.  Be careful to</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true"></a><span class="co">// always exit immediately after running your commands.</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true"></a><span class="kw">$ sudo /bin/bash</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true"></a><span class="co">// disable serial and bluetooth modems or serial devices</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true"></a><span class="fu"># systemctl stop ModemManager</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true"></a><span class="fu"># systemctl disable ModemManager</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true"></a><span class="fu"># systemctl stop hciuart</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true"></a><span class="fu"># systemctl disable hciuart</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true"></a></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true"></a><span class="co">// disable VPN and printing services - you can print without running</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true"></a><span class="co">// a local printer daemon (!!maybe document using one though )</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true"></a><span class="fu"># systemctl stop openvpn</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true"></a><span class="fu"># systemctl disable openvpn</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true"></a><span class="fu"># systemctl stop cups-browsed cups</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true"></a><span class="fu"># systemctl disable cups-browsed cups</span></span></code></pre></div>
<h4 id="disable-sssdsssd-secureboot-db-whoopsie-kerneloops-apport-and-apparmorapparmor">Disable <a href="https://ubuntu.com/server/docs/service-sssd">sssd</a>, secureboot-db, whoopsie, kerneloops, apport and <a href="https://en.wikipedia.org/wiki/AppArmor">apparmor</a></h4>
<p>Note that it is possible to enable <a href="https://news.ycombinator.com/item?id=35815382">some form of secure boot</a> with OTP (One Time Programmable Memory) on a Raspberry Pi 4, but it is not yet for the faint of heart.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true"></a><span class="co">// disable System Security Services Daemon (sssd) if you don&#39;t need it</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true"></a><span class="fu"># systemctl disable sssd</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true"></a><span class="co">// Disable UEFI Secure Boot (secureboot-db)</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true"></a><span class="co">// To be sure, install mokutil and take a look:</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true"></a></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true"></a><span class="fu"># apt install mokutil</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true"></a><span class="fu"># man mokutil</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true"></a><span class="co">// --sb-state means:  Show SecureBoot State</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true"></a><span class="fu"># mokutil --sb-state</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true"></a>EFI variables are not supported on this system</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true"></a></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true"></a><span class="fu"># systemctl status secureboot-db</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true"></a>- secureboot-db.service - Secure Boot updates for DB and DBX</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true"></a>     Loaded: loaded (/lib/systemd/system/secureboot-db.service; enabled; vendor&gt;</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true"></a>     Active: inactive (dead)</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true"></a></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true"></a><span class="fu"># systemctl disable secureboot-db</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true"></a><span class="fu"># apt autoremove --purge secureboot-db</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true"></a></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true"></a><span class="co">// disable whoopsie and kerneloops if you don&#39;t want to be sending</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true"></a><span class="co">// information to outside entities</span></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true"></a><span class="fu"># systemctl stop kerneloops</span></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true"></a><span class="fu"># systemctl disable kerneloops</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true"></a><span class="fu"># systemctl stop whoopsie</span></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true"></a><span class="fu"># systemctl disable whoopsie</span></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true"></a><span class="fu"># apt remove whoopsie kerneloops</span></span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true"></a><span class="fu"># apt purge whoopsie kerneloops</span></span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true"></a></span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true"></a><span class="co">// If you want to disable other apport-based crash reporting then remove apport</span></span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true"></a><span class="co">// from your server:</span></span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true"></a><span class="fu"># apt autoremove --purge apport</span></span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true"></a></span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true"></a><span class="co">// Apparmor (like SELinux) provides another layer of security to systems.</span></span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true"></a><span class="co">// If you are new to Linux you should keep it around to learn about it.</span></span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true"></a><span class="co">// For a home server I think it can be disabled; you must previously have</span></span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true"></a><span class="co">// removed &#39;Snaps&#39;:</span></span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true"></a><span class="fu"># aa-status</span></span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true"></a>apparmor module is loaded.</span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true"></a>50 profiles are loaded.</span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true"></a>41 profiles are in enforce mode.</span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true"></a>...</span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true"></a><span class="fu"># aa-teardown</span></span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true"></a>Unloading AppArmor profiles </span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true"></a></span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true"></a><span class="fu"># aa-status</span></span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true"></a>apparmor module is loaded.</span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true"></a></span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true"></a><span class="fu"># systemctl disable apparmor </span></span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true"></a>...</span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true"></a>Removed /etc/systemd/system/sysinit.target.wants/apparmor.service.</span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true"></a></span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true"></a><span class="fu"># apt autoremove --purge apparmor</span></span>
<span id="cb31-54"><a href="#cb31-54" aria-hidden="true"></a>dpkg: warning:  directory &#39;/etc/apparmor.d/abstractions/ubuntu-browsers.d&#39;</span>
<span id="cb31-55"><a href="#cb31-55" aria-hidden="true"></a> not empty so not removed</span>
<span id="cb31-56"><a href="#cb31-56" aria-hidden="true"></a></span>
<span id="cb31-57"><a href="#cb31-57" aria-hidden="true"></a><span class="fu"># cd /etc</span></span>
<span id="cb31-58"><a href="#cb31-58" aria-hidden="true"></a>root@pi:/etc# mv apparmor.d apparmor.d.old</span></code></pre></div>
<h2 id="miscellaneous-configuration-tweaks">Miscellaneous configuration tweaks</h2>
<h3 id="change-local-time-presentation-globally">Change local time presentation globally</h3>
<p>If you prefer to see time in 24 hour format, or if you prefer to tweak other <a href="https://en.wikipedia.org/wiki/Locale_(computer_software)">locale</a> settings, then use <em>localectl</em> to set global locale settings.</p>
<p>In this example the locale setting is generic English with a region code for Canada. Because the British English locale uses a 24 hour clock then changing only the time locale will show datestrings with a 24 hour clock:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true"></a><span class="co">// Show your current locale settings</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true"></a><span class="kw">$ locale</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true"></a>LANG=en_CA.UTF-8</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true"></a>LANGUAGE=en_CA:en</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true"></a>LC_CTYPE=&quot;en_CA.UTF-8&quot;</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true"></a>LC_NUMERIC=&quot;en_CA.UTF-8&quot;</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true"></a>LC_TIME=en_CA.UTF-8</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true"></a>LC_TIME=en_GB.UTF-8</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true"></a>...</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true"></a></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true"></a><span class="co">// What the date is in the current (Canadian) locale</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true"></a><span class="kw">$ date</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true"></a>Thu 11 May 2023 08:43:57 AM MDT</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true"></a></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true"></a><span class="co">// What the date would look like if (American) en_US.UTF-8 were used:</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true"></a><span class="kw">$ LC_TIME=en_US.UTF-8 date</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true"></a>Thu May 11 08:45:18 AM MDT 2023</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true"></a></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true"></a><span class="co">// What the date would look like if (British) en_GB.UTF-8 were used:</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true"></a><span class="kw">$ LC_TIME=en_GB.UTF-8 date</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true"></a>Thu 11 May 08:44:00 MDT 2023</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true"></a></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true"></a><span class="co">// Change it to the British style.  The change is immediate, but since</span></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true"></a><span class="co">// you inherit the older locale environment at login, then you will not see</span></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true"></a><span class="co">// the change until you logout, and then back in.</span></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true"></a><span class="kw">$ sudo localectl set-locale LC_TIME=&quot;en_GB.UTF-8&quot;</span></span></code></pre></div>
<h3 id="change-log-rotation-file-naming">Change log rotation file naming</h3>
<p>Ubuntu installs a log rotation package which controls how log files are rotated on your server. This package typically once a week compresses log files to a different name in /var/log/ and truncates the current log. The resulting files are rotated through a specified rotation, and the oldest compressed log is deleted; for example here are 4 weeks worth of rotated auth.log files:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true"></a><span class="kw">$ ls -ltr /var/log/ | grep auth.log</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true"></a>-rw-r-----  1 syslog     adm      3498 Apr 15 23:17 auth.log.4.gz</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true"></a>-rw-r-----  1 syslog     adm      8178 Apr 22 23:17 auth.log.3.gz</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true"></a>-rw-r-----  1 syslog     adm      7225 Apr 30 01:09 auth.log.2.gz</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true"></a>-rw-r-----  1 syslog     adm     58810 May  7 00:22 auth.log.1</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true"></a>-rw-r-----  1 syslog     adm     46426 May 11 09:17 auth.log</span></code></pre></div>
<p>A better scheme is to use the ‘dateext’ option in <em>/etc/logrotate.conf</em> so that older compressed logs keep their compressed and dated names until they are deleted:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true"></a><span class="kw">$ ls -ltr /var/log/ | grep auth.log</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true"></a>-rw-r----- 1 syslog      adm      3287 Apr 17 07:30 auth.log-20230417.gz</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true"></a>-rw-r----- 1 syslog      adm      2494 Apr 23 07:30 auth.log-20230423.gz</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true"></a>-rw-r----- 1 syslog      adm      4495 May  1 07:30 auth.log-20230501.gz</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true"></a>-rw-r----- 1 syslog      adm     35715 May  7 07:30 auth.log-20230507</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true"></a>-rw-r----- 1 syslog      adm     29500 May 11 09:55 auth.log</span></code></pre></div>
<p>To make this change /etc/logrotate.conf is modified. We also set the number of rotations to keep to 12 weeks instead of 4 weeks. Note that per-service log file customization is possible; look at examples in <em>/etc/logrotate.d/</em></p>
<div class="sourceCode" id="cb35"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true"></a><span class="kw">$ cd /etc</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true"></a><span class="kw">$ sudo cp -p logrotate.conf logrotate.conf.orig</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true"></a><span class="kw">$ sudo nano logrotate.conf</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true"></a><span class="kw">$ diff logrotate.conf.orig logrotate.conf</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true"></a>13c13,14</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true"></a>&lt; rotate 4</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true"></a>---</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true"></a>&gt; #rotate 4</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true"></a>&gt; rotate 12</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true"></a>19c20</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true"></a>&lt; #dateext</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true"></a>---</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true"></a>&gt; dateext</span></code></pre></div>
<h3 id="consider-enabling-a-static-ip-configuration">Consider enabling a static IP configuration</h3>
<p>Normally you get your network configuration from your home router via its DHCP service. If you are using a wired connection then consider statically configuring the IP address information on your server – there is <a href="#static-ip">a description of the process</a> in the appendix in case you want to see how it is done.</p>
<h3 id="addressing-software-package-updates">Addressing software package updates</h3>
<p>By default the <em>unattended-upgrades</em> package is installed on Ubuntu LTS, and it is configured to run in an unattended manner. Its configuration files are in <em>/etc/apt/apt.conf.d/</em>, and the log files are in <em>/var/log/unattended-upgrades/</em>.</p>
<p>In particular the log files <em>/var/log/unattended-upgrades-dpkg.log*</em> contain the list of all upgraded packages:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true"></a><span class="co">// list files in time reverse order, then for each file find the date &amp; package</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true"></a><span class="kw">$ ls -tr unattended-upgrades-dpkg.log* | \</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true"></a><span class="kw">  while read f ; do \</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true"></a><span class="kw">    echo &quot;Log File $f:&quot; \</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true"></a><span class="kw">    zegrep &#39;^Log started:|^Unpacking &#39; $f \</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true"></a><span class="kw">    echo &quot;&quot;; \</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true"></a><span class="kw">  done</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true"></a></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true"></a>Log File unattended-upgrades-dpkg.log.1.gz:</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true"></a>Log started: 2023-05-10  06:05:40</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true"></a>Unpacking librados2 (17.2.5-0ubuntu0.22.04.3) over (17.2.5-0ubuntu0.22.04.2) ...</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true"></a>Log started: 2023-05-10  06:05:52</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true"></a>Unpacking libcephfs2 (17.2.5-0ubuntu0.22.04.3) over (17.2.5-0ubuntu0.22.04.2) ...</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true"></a>Log started: 2023-05-10  06:06:03</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true"></a>Unpacking libfreetype6:arm64 (2.11.1+dfsg-1ubuntu0.2) over (2.11.1+dfsg-1ubuntu0.1) ...</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true"></a></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true"></a>Log File unattended-upgrades-dpkg.log-20230601.gz:</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true"></a>Log started: 2023-05-12  06:40:40</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true"></a>Unpacking linux-modules-5.15.0-1028-raspi (5.15.0-1028.30) ...</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true"></a>Unpacking linux-image-5.15.0-1028-raspi (5.15.0-1028.30) ...</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true"></a>Unpacking linux-modules-extra-5.15.0-1028-raspi (5.15.0-1028.30) ...</span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true"></a>Unpacking linux-modules-extra-raspi (5.15.0.1028.25) over (5.15.0.1027.24) ...</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true"></a>Log started: 2023-05-12  06:42:58</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true"></a>Unpacking linux-image-raspi (5.15.0.1028.25) over (5.15.0.1027.24) ...</span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true"></a>Log started: 2023-05-12  06:43:10</span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true"></a>Log started: 2023-05-17  06:28:44</span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true"></a>Unpacking linux-libc-dev:arm64 (5.15.0-72.79) over (5.15.0-71.78) ...</span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true"></a>...</span></code></pre></div>
<p>If you are accustomed to monitoring and applying patches yourself, then you can delete the automatic update infrastructure, and do the patching yourself. Many work-place servers cannot be automatically updated without some risk, so if you support Linux at work you are probably used to configuring and managing your own software update policy.</p>
<p>If you decide to manage updates yourself then you could remove this package and its components. Of course, you should not do this until you are sure that you will follow through with doing your own updates:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true"></a><span class="kw">$ systemctl status unattended-upgrades</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true"></a>     Loaded: loaded (/lib/systemd/system/unattended-upgrades.service; enabled</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true"></a>...</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true"></a><span class="kw">$ sudo apt remove update-notifier-common unattended-upgrades</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true"></a>...</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true"></a>The following packages will be REMOVED:</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true"></a>  ubuntu-release-upgrader-gtk unattended-upgrades update-manager update-notifier</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true"></a>  update-notifier-common</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true"></a>...</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true"></a></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true"></a><span class="kw">$ sudo systemctl disable apt-daily-upgrade.timer apt-daily.timer</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true"></a>Removed /etc/systemd/system/timers.target.wants/apt-daily.timer.</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true"></a>Removed /etc/systemd/system/timers.target.wants/apt-daily-upgrade.timer.</span></code></pre></div>
<h3 id="getting-rid-of-motd-terminal-output">Getting rid of <em>motd</em> terminal output</h3>
<p>Regardless of whether you have registered for and configured the free ESM update program or not, you might get tired of seeing your terminal windows with any kind of messages.</p>
<p>One way to get rid of messages is to comment out these message properties in <a href="https://en.wikipedia.org/wiki/Linux_PAM">PAM (Pluggable Authentication Modules)</a> configuration files. In the example session below I comment out dynamic <em>motd</em> (message of the day) and <em>last login</em> messages in 2 modules: <em>sshd</em> and <em>login</em></p>
<div class="sourceCode" id="cb38"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true"></a><span class="kw">$ cd /etc/pam.d</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true"></a><span class="kw">$ sudo cp -p sshd sshd.orig</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true"></a><span class="co">// comment out the dynamic motd configuration</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true"></a><span class="kw">$ sudo nano sshd</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true"></a><span class="kw">$ diff sshd.orig sshd</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true"></a>33c33</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true"></a>&lt; session    optional     pam_motd.so  motd=/run/motd.dynamic</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true"></a>---</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true"></a>&gt; #session    optional     pam_motd.so  motd=/run/motd.dynamic</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true"></a></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true"></a><span class="kw">$ sudo cp -p login login.orig</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true"></a><span class="co">// comment out the dynamic motd configuration and the last login configuration</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true"></a><span class="kw">$ sudo nano login</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true"></a><span class="kw">$ diff login.orig login</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true"></a>33c33</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true"></a>&lt; session    optional   pam_motd.so motd=/run/motd.dynamic</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true"></a>---</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true"></a>&gt; #session    optional   pam_motd.so motd=/run/motd.dynamic</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true"></a>82c82</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true"></a>&lt; session    optional   pam_lastlog.so</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true"></a>---</span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true"></a>&gt; #session    optional   pam_lastlog.so</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true"></a></span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true"></a><span class="co">// For sshd, you need to edit /etc/ssh/sshd_config and set &#39;PrintLastLog&#39; to no</span></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true"></a><span class="co">// We won&#39;t do that here; instead we will do it in the secure-shell chapter.</span></span></code></pre></div>
<p>The other kind of optional pam session type of <em>motd</em> will still be displayed in your terminal window whenever you create a file named <em>/etc/motd</em>, since we did not comment it out.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true"></a><span class="kw">$ grep -h motd /etc/pam.d/login /etc/pam.d/login | grep -v &#39;^#&#39;</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true"></a>session    optional   pam_motd.so noupdate</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true"></a>session    optional   pam_motd.so noupdate</span></code></pre></div>
<p>It is unlikely that you will create a message that way for yourself. However, it is an interesting idea to drop an information file named <em>/etc/motd</em> on your server if your daily backups fail …</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true"></a><span class="co">// Somewhere in your script you have:</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true"></a>echo &quot;Your backups failed at `date`&quot; &gt;&gt;/etc/motd</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true"></a><span class="co">// then when you log in the next day:</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true"></a><span class="kw">$ ssh pi.home</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true"></a>Your backups failed at Fri 28 Jul 01:19:45 MDT 2023 </span></code></pre></div>
<!--
still to look at:
  * explore firewall issues - ufw seems lacking
  * local time configuration and ntp configuration options
-->
<!-- -->
<h1 id="chapter-08">Enabling the Secure Shell daemon and using Secure Shell</h1>
<p>The <a href="https://en.wikipedia.org/wiki/Secure_Shell">Secure Shell</a> daemon, <strong><em>sshd</em></strong>, is a very useful and important service for connecting between computers near or far. If you are never going to connect via SSH into your Pi home server from within your network then do NOT install the daemon. You can always use the secure shell client, <strong><em>ssh</em></strong>, to initiate a connection to some external server – for that you do not need sshd.</p>
<h2 id="configure-the-sshd-daemon">Configure the sshd daemon</h2>
<p>If you will be needing sshd then first install it, since it is not installed by default in the LTS desktop version:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true"></a><span class="kw">$ sudo apt install openssh-server</span></span></code></pre></div>
<p>If you will be using ssh to connect to any local Linux systems, then think about configuring your local area network (LAN) to suit your taste. There is an <a href="#lan">explanation in the appendix</a>.</p>
<p>There are some sshd configuration issues that I like to fix in the secure shell daemon’s configuration file: <em>/etc/ssh/sshd_config</em>. The issues to fix are:</p>
<ul>
<li>stop the daemon from listening on IPv6: <em>AddressFamily inet</em></li>
<li>tell the daemon to use DNS: <em>UseDNS yes</em></li>
<li>stop the daemon from printing the last login info: <em>PrintLastLog no</em></li>
<li>limit ssh access to yourself in your LAN; and block ssh access to the root user except for ‘localhost’:<br />
<em>AllowUsers myname@192.168.1.* <span class="citation" data-cites="localhost">@localhost</span></em></li>
</ul>
<div class="sourceCode" id="cb42"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true"></a><span class="kw">$ cd /etc/ssh</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true"></a><span class="kw">$ sudo cp -p sshd_config sshd_config.orig</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true"></a><span class="co">// edit the file:</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true"></a><span class="kw">$ sudo nano sshd_config</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true"></a></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true"></a><span class="kw">$ diff sshd_config.orig sshd_config</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true"></a>15a16</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true"></a>&gt; AddressFamily inet</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true"></a>95a97</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true"></a>&gt; PrintLastLog no</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true"></a>101a104</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true"></a>&gt; UseDNS yes</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true"></a>122a126,131</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true"></a>&gt; </span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true"></a>&gt; # Limit access to root user; only local users can connect via ssh</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true"></a>&gt; # to the root user, but only if root&#39;s authorized_keys file allows them.</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true"></a>&gt; # note: using @localhost does not work on ubuntu unless you set &#39;UseDNS&#39; to yes</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true"></a>&gt; AllowUsers    myname@192.168.1.* *@localhost</span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true"></a>&gt; </span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true"></a></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true"></a><span class="co">// Another option is to also allow root access to this server from your Linux</span></span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true"></a><span class="co">// desktop (eg: 192.168.1.65).  Then the &#39;AllowUsers&#39; configuration would</span></span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true"></a><span class="co">// look like this:</span></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true"></a>AllowUsers      myname@192.168.1.* root@192.168.1.65 *@localhost</span></code></pre></div>
<h2 id="key-pair">Configure a personal SSH key pair</h2>
<p>If you use the Linux command-line for work between computers you soon understand the usefulness of ssh. Here we go through the exercise of creating an ssh key pair so that you can connect securely between devices.</p>
<p>We use <em>ssh-keygen</em> to create the key pair. You should treat the private key carefully, distributing it to your desktop systems only. You can copy your public key to remote hosts, where you create an <em>authorized_keys</em> file that specifies which public keys are allowed to connect without using a standard system password.</p>
<p>Over time the Secure Shell key types have changed. Some key types are no longer considered secure, like SSH-1 or DSA keys. Here we will use an SSH RSA-based key with a key size of 4096 bits. Always use a strong passphrase. It is not like a password since you have more liberty to use combinations of characters; as the man-page on ssh-keygen says:</p>
<blockquote>
<p>A passphrase is similar to a password, except it can be a phrase with a series of words, punctuation, numbers, whitespace, or any string of characters you want.</p>
</blockquote>
<p>I would not create a passphrase that is less than 16 characters; I would certainly never set an empty passphrase.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true"></a><span class="co">// If you do not yet have a .ssh directory in your home directory then</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true"></a><span class="co">// create one now; and give access to yourself only:</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true"></a></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true"></a><span class="kw">$ cd</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true"></a><span class="kw">$ mkdir .ssh</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true"></a><span class="kw">$ chmod 700 .ssh</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true"></a></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true"></a><span class="co">// Generate the key:</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true"></a><span class="kw">$ ssh-keygen -t rsa -b 4096</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true"></a>Generating public/private rsa key pair.</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true"></a>Enter file in which to save the key (/home/myname/.ssh/id_rsa): </span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true"></a>Enter passphrase (empty for no passphrase):</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true"></a>Enter same passphrase again:</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true"></a>Your identification has been saved in /home/myname/.ssh/id_rsa.</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true"></a></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true"></a><span class="co">// The private key is named &#39;id_rsa&#39; and the public key is named &#39;id_rsa.pub&#39;</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true"></a><span class="co">// Note the permissions of these 2 files; the private key is protected</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true"></a><span class="co">// and is read-write only to the owner.</span></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true"></a><span class="kw">$ ls -l ~/.ssh/id_rsa ~/.ssh/id_rsa.pub</span></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true"></a>-rw------- 1 myname myname 3326 May  2 22:34 /home/myname/.ssh/id_rsa</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true"></a>-rw-r--r-- 1 myname myname  746 May  2 22:34 /home/myname/.ssh/id_rsa.pub</span></code></pre></div>
<p>Be sure to back-up important directories like $HOME/.ssh – in your home environment it might not seem important, but once you start using your ssh keys for access to external resources then you should follow good practices. If you lose the private key then you will need to generate a new key pair.</p>
<p>Suppose you created your keys on your desktop, and you want to use them to ssh to your Linux home server without using a standard password. To do this you create an authorized keys file on the server:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true"></a><span class="co">// secure-copy your public key to the linux server (assuming the server is named &#39;pi&#39;)</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true"></a><span class="kw">$ scp ~/.ssh/id_rsa.pub myname@pi:~/</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true"></a>The authenticity of host &#39;pi (192.168.1.90)&#39; can&#39;t be established.</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true"></a>ECDSA key fingerprint is SHA256:iP...</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true"></a>ECDSA key fingerprint is MD5:79:54:...</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true"></a>Are you sure you want to continue connecting (yes/no)? yes</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true"></a>Warning: Permanently added &#39;pi,192.168.1.90&#39; (ECDSA) to the list of known hosts.</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true"></a></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true"></a><span class="co">// On the server create your authorized_keys file if it does not exist</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true"></a><span class="co">// inside &#39;~/.ssh&#39;, and then &#39;cat&#39; your public key to the end of the file.</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true"></a><span class="co">// The authorized_keys file should always be protected.</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true"></a></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true"></a><span class="kw">$ ssh myname@pi</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true"></a>myname@pi&#39;s password:</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true"></a><span class="kw">$ mkdir ~/.ssh</span></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true"></a><span class="kw">$ chmod 700 ~/.ssh</span></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true"></a><span class="kw">$ cd ~/.ssh</span></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true"></a><span class="kw">$ touch authorized_keys</span></span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true"></a><span class="kw">$ chmod 600 authorized_keys</span></span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true"></a><span class="kw">$ cat /path/to/id_rsa.pub &gt;&gt; authorized_keys</span></span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true"></a><span class="kw">$ tail -1 authorized_keys</span></span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true"></a>ssh-rsa AAAAB3...6oLYnLx5d myname@somewhere.com</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true"></a><span class="kw">$ rm /path/to/id_rsa.pub</span></span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true"></a><span class="co">// logout from the server session</span></span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true"></a><span class="kw">$ exit</span></span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true"></a></span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true"></a><span class="co">// Back on the desktop verify that you can ssh into the server using only</span></span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true"></a><span class="co">// the key&#39;s passphrase (and not your password):</span></span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true"></a><span class="kw">$ ssh myname@pi</span></span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true"></a>Enter passphrase for key &#39;/home/myname/.ssh/id_rsa&#39;: </span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true"></a>Welcome to Ubuntu 22.04.2 LTS (GNU/Linux 5.15.0-1027-raspi aarch64)</span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true"></a>...</span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true"></a><span class="kw">$ exit</span></span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true"></a></span>
<span id="cb44-35"><a href="#cb44-35" aria-hidden="true"></a><span class="co">// If you want to only allow ssh access to your account from a specific</span></span>
<span id="cb44-36"><a href="#cb44-36" aria-hidden="true"></a><span class="co">// computer in your LAN, than limit the hosts which are allowed by using</span></span>
<span id="cb44-37"><a href="#cb44-37" aria-hidden="true"></a><span class="co">// the &#39;from=&#39; option.  Edit the authorized_keys file and prepend the </span></span>
<span id="cb44-38"><a href="#cb44-38" aria-hidden="true"></a><span class="co">// &#39;from=&#39; option like this:</span></span>
<span id="cb44-39"><a href="#cb44-39" aria-hidden="true"></a><span class="kw">$ pwd</span></span>
<span id="cb44-40"><a href="#cb44-40" aria-hidden="true"></a>/home/myname/.ssh</span>
<span id="cb44-41"><a href="#cb44-41" aria-hidden="true"></a><span class="co">// allow from host with IP address 192.168.1.65, and from localhost:</span></span>
<span id="cb44-42"><a href="#cb44-42" aria-hidden="true"></a><span class="kw">$ nano authorized_keys</span></span>
<span id="cb44-43"><a href="#cb44-43" aria-hidden="true"></a><span class="kw">$ tail -1 authorized_keys</span></span>
<span id="cb44-44"><a href="#cb44-44" aria-hidden="true"></a>from=&quot;192.168.1.65&quot; ssh-rsa AAAAB3...6oLYnLx5d myname@somewhere.com</span></code></pre></div>
<h2 id="configure-an-ssh-agent">Configure an SSH agent</h2>
<p>The goal here is to start an <a href="https://www.ssh.com/academy/ssh/agent">SSH agent</a> on your desktop, and add your key(s) to the agent.</p>
<p>With a few tweaks we allow other programs to inherit the ssh-agent <em>environment variables</em> and we avoid entering passwords and passphrases throughout the day, or until you logout, reboot or turn off your desktop.</p>
<h4 id="script-to-start-an-ssh-agent">Script to start an ssh-agent</h4>
<p>Download the shell script named <a href="https://github.com/deatrich/tools/blob/main/prime-ssh-keys.sh"><em>prime-ssh-keys.sh</em></a> to start the agent. The script saves the environment variables in a file named:</p>
<blockquote>
<p>~/.ssh-agent-info-YOUR-FULL-HOSTNAME</p>
</blockquote>
<div class="sourceCode" id="cb45"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true"></a><span class="co">// Copy the shell script to your home &#39;bin&#39; directory; create it if needed:</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true"></a><span class="kw">$ cd</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true"></a><span class="kw">$ mkdir bin</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true"></a><span class="kw">$ cp /path/to/prime-ssh-keys.sh ~/bin/</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true"></a><span class="kw">$ chmod 755 ~/bin/prime-ssh-keys.sh </span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true"></a></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true"></a><span class="co">// Run the script:</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true"></a><span class="kw">$ ~/bin/prime-ssh-keys.sh </span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true"></a>Enter passphrase for /home/myname/.ssh/id_rsa: </span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true"></a>Identity added: /home/myname/.ssh/id_rsa (/home/myname/.ssh/id_rsa)</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true"></a> </span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true"></a><span class="co">// This file sets and exports environment variables for the socket and the PID:</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true"></a><span class="kw">$ cat ~/.ssh-agent-info-desktop.home</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true"></a>SSH_AUTH_SOCK=/tmp/ssh-XXXXXXxRlqsm/agent.21324; export SSH_AUTH_SOCK;</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true"></a>SSH_AGENT_PID=21325; export SSH_AGENT_PID;</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true"></a></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true"></a><span class="co">// Now if you &#39;source&#39; the agent file to inherit the environment variables</span></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true"></a><span class="co">//  you will be able to ssh into the linux server without using</span></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true"></a><span class="co">//  a password or passphrase:</span></span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true"></a><span class="kw">$ . ~/.ssh-agent-info-desktop.home </span></span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true"></a><span class="kw">$ ssh -Y pi.home</span></span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true"></a>Welcome to Ubuntu 22.04.2 LTS (GNU/Linux 5.15.0-1027-raspi aarch64)</span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true"></a>...</span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true"></a>Last login: Thu May 11 23:56:17 2023 from desktop.home</span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true"></a><span class="kw">$ </span></span></code></pre></div>
<h4 id="script-to-start-an-ssh-agent-at-initial-login">Script to start an ssh-agent at initial login</h4>
<p>In a MATE desktop setting, you can add startup programs that run as soon as you log into your desktop. You can find the startup options in:</p>
<blockquote>
<p>Menus -&gt; System -&gt; Preferences -&gt; Personal -&gt; Startup Applications</p>
</blockquote>
<p>Create and add the script – it will open a temporary terminal window asking for the passphrase(s) for your key(s). The terminal window can be any terminal the allows you to run a shell script as an argument. You can use <em>mate-terminal</em>, or if you have installed the <strong>xterm</strong> package then you can use <em>xterm</em>. Note that the script invokes a shell (<em>/bin/sh</em> is a symbolic link to <em>/bin/bash</em>, and starts with a <a href="https://en.wikipedia.org/wiki/Shebang_(Unix)">shebang</a>)</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true"></a><span class="co">// make the &#39;bin&#39; directory if it does not exist:</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true"></a><span class="kw">$ cd</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true"></a><span class="kw">$ touch ~/bin/exec-prime-ssh-keys.sh</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true"></a><span class="kw">$ chmod 755 ~/bin/exec-prime-ssh-keys.sh</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true"></a><span class="kw">$ nano ~/bin/exec-prime-ssh-keys.sh</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true"></a><span class="kw">$ cat ~/bin/exec-prime-ssh-keys.sh</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true"></a>#!/bin/sh</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true"></a></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true"></a>#Decide which terminal command you will use:</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true"></a>exec mate-terminal -e /home/myname/bin/prime-ssh-keys.sh &amp; 2&gt;/dev/null</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true"></a>#exec xterm -u8 -e /home/myname/bin/prime-ssh-keys.sh &amp; 2&gt;/dev/null</span></code></pre></div>
<p>Another useful tactic is to get your personal bash shell configuration file to inherit the SSH agent’s environment variables. Create a small script named <em>~/.bash_ssh_env</em> which provides the variables. You can process that file in your <em>~/.bashrc</em> file so that any new terminal window you launch will always inherit the variables. As well, other scripts which might need the variables can do the same.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true"></a><span class="co">// First create .bash_ssh_env; we &#39;cat&#39; it after to show what it contains:</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true"></a><span class="kw">$ nano ~/.bash_ssh_env</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true"></a><span class="kw">$ cat ~/.bash_ssh_env</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true"></a></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true"></a>ssh_info_file=$HOME/.ssh-agent-info-`/usr/bin/hostname`</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true"></a>if [ -f $ssh_info_file ] ; then</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true"></a>  . $ssh_info_file</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true"></a>fi</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true"></a></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true"></a><span class="co">// Then source ~/.bash_ssh_env inside your .bashrc file by simply including</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true"></a><span class="co">// the following line in ~/.bashrc:</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true"></a></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true"></a>. ~/.bash_ssh_env</span></code></pre></div>
<h2 id="personal-configuration-in-config-file">Personal Configuration in ‘config’ File</h2>
<p>You can configure some personal preferences in a configuration file named <em>$HOME/.ssh/config</em></p>
<p>I have a few favourite settings which have solved issues I have encountered in the past (like setting <em>KeepAlive</em> and <em>ServerAliveInterval</em>). A new favourite is setting <strong>HashKnownHosts</strong> to <em>no</em>. I like seeing the name of hosts I have connected to in <em>~/.ssh/known_hosts</em>. Debian/Ubuntu set globally the <em>HashKnownHosts</em> value to <em>yes</em>. The result is that you can no longer see hostnames or IP addresses in your known_hosts file because they have been ‘hashed’.`</p>
<p>This is also where you can assign customized per-host ssh key pair filenames to particular hosts.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true"></a><span class="co">// Create and edit your ssh config file:</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true"></a><span class="kw">$ cd ~/.ssh/</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true"></a><span class="kw">$ touch config</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true"></a><span class="kw">$ chmod 600 config</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true"></a><span class="kw">$ nano config </span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true"></a><span class="kw">$ cat config </span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true"></a>## see:  man ssh_config</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true"></a></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true"></a>## ssh configuration data is parsed in the following order:</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true"></a>##         1.   command-line options</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true"></a>##         2.   user&#39;s configuration file (~/.ssh/config)</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true"></a>##         3.   system-wide configuration file (/etc/ssh/ssh_config)</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true"></a>## Any configuration value is only changed the first time it is seen.</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true"></a>## Therefore this file overrides system-wide defaults.</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true"></a></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true"></a>Host *</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true"></a>   KeepAlive yes</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true"></a>   ServerAliveInterval 60</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true"></a>   HashKnownHosts no</span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true"></a></span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true"></a>## Example private key which has a customized key name for github.com</span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true"></a>Host github.com</span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true"></a>   IdentityFile ~/.ssh/id_rsa_github</span></code></pre></div>
<!-- -->
<h1 id="chapter-09">Enabling remote desktop services</h1>
<p>In case you have various devices at home that you would like to use in a Linux desktop fashion, but you do not want to change the current environment on those devices, then you can configure your home Linux server to provide that opportunity.</p>
<p>For all remote desktop options, first create an <em>.Xsession</em> file in your home directory on the server and configure it to start a MATE desktop session:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true"></a><span class="kw">$ cd</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true"></a><span class="kw">$ nano .Xsession</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true"></a><span class="kw">$ cat .Xsession</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true"></a>/usr/bin/mate-session</span></code></pre></div>
<h2 id="configure-remote-desktop-protocol-rdp">Configure Remote Desktop Protocol (RDP)</h2>
<p>Most operating systems have client support for Microsoft’s Remote Desktop Protocol. On Linux there is also a software package named <em>xrdp</em> which can provide RDP.</p>
<p>Note that RDP is <a href="https://threatpost.com/remote-desktop-protocol-secure/167719/">typically not really secure</a> without adding some additional security features. However, from within your home network xrdp is okay.</p>
<p>We install xrdp, tweak the configuration a little, and restart xrdp:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true"></a><span class="kw">$ sudo apt install xrdp</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true"></a>...</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true"></a>The following additional packages will be installed:</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true"></a>  xorgxrdp</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true"></a>...</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true"></a>Setting up xrdp (0.9.17-2ubuntu2) ...</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true"></a></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true"></a>Generating 2048 bit rsa key...</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true"></a></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true"></a>ssl_gen_key_xrdp1 ok</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true"></a></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true"></a>saving to /etc/xrdp/rsakeys.ini</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true"></a></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true"></a>Created symlink /etc/systemd/system/multi-user.target.wants/xrdp-sesman.service ...</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true"></a>Created symlink /etc/systemd/system/multi-user.target.wants/xrdp.service ...</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true"></a>Setting up xorgxrdp (1:0.2.17-1build1) ...</span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true"></a>...</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true"></a></span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true"></a><span class="co">// The configuration file is xrdp.ini; here we disable ipv6 by stipulating</span></span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true"></a><span class="co">// &#39;tcp://:3389&#39; in the port configuration:</span></span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true"></a><span class="kw">$ cd /etc/xrdp</span></span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true"></a><span class="kw">$ sudo cp -p xrdp.ini xrdp.ini.orig</span></span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true"></a><span class="kw">$ sudo nano xrdp.ini</span></span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true"></a><span class="kw">$ diff xrdp.ini.orig xrdp.ini</span></span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true"></a>23c23,24</span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true"></a>&lt; port=3389</span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true"></a>---</span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true"></a>&gt; ;;port=3389</span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true"></a>&gt; port=tcp://:3389</span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true"></a></span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true"></a><span class="co">// restart xrdp</span></span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true"></a><span class="kw">$ sudo systemctl restart xrdp</span></span></code></pre></div>
<p>You can test the setup from any other linux computer with <a href="https://ubuntu.com/tutorials/access-remote-desktop#1-overview"><em>remmina</em></a> installed, or you can secure-shell into the Linux server with X11 forwarding using the ‘-Y’ option and run ‘remmina’ from the command-line; that is:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true"></a><span class="co">// Suppose that your server is named pi.home</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true"></a><span class="kw">$ ssh -Y pi.home</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true"></a></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true"></a><span class="co">// Test if X11 forwarding is working:</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true"></a><span class="kw">$ xhost</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true"></a>access control enabled, only authorized clients can connect</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true"></a>SI:localuser:myname</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true"></a></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true"></a></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true"></a><span class="co">// If remmina is not installed, then install it:</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true"></a><span class="kw">$ sudo apt install remmina</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true"></a><span class="kw">$ remmina</span></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true"></a></span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true"></a><span class="co">// Start remmina and log into the server with your username and password.</span></span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true"></a><span class="co">// You can save a connection profile with a custom resolution setting</span></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true"></a><span class="co">// to get the best possible presentation.</span></span></code></pre></div>
<p>There are many web-based tutorials; check out <a href="https://www.digitalocean.com/community/tutorials/how-to-enable-remote-desktop-protocol-using-xrdp-on-ubuntu-22-04"><em>XRDP on Ubuntu 22.04</em></a>. This tutorial shows how to connect from Windows and from macOS as well.</p>
<h2 id="configure-x2go">Configure X2Go</h2>
<p><a href="https://en.wikipedia.org/wiki/X2Go">X2Go</a> is my favourite remote desktop setup since it runs seamlessly via secure shell connections and can use <a href="#key-pair">SSH key pairs</a> to avoid password use. Thus I can comfortably connect as a remote desktop to remote servers across the continent, and write and test code as if I was down the hall from the remote server.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true"></a><span class="co">// install both the server and the client software</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true"></a><span class="kw">$ sudo apt install x2goserver x2goclient</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true"></a>...</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true"></a>Setting up x2goserver-x2goagent (4.1.0.3-5) ...</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true"></a>Setting up x2goserver (4.1.0.3-5) ...</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true"></a>Created symlink /etc/systemd/system/multi-user.target.wants/x2goserver.service</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true"></a>...</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true"></a></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true"></a><span class="kw">$ systemctl list-unit-files | grep -i x2go</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true"></a>x2goserver.service                         enabled         enabled</span></code></pre></div>
<p>Your local desktop must have <em>x2goclient</em> installed so that you can start a remote X2Go desktop. From any Linux desktop running an X.org service you can start it from the command-line. This way the client inherits the SSH environment variables (you can also embed a small shell script which provides the environment in a custom application launcher).</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true"></a><span class="co">// Bring up the application window; redirect stderr to /dev/null to ignore</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true"></a><span class="co">//  various uninteresting messages.</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true"></a><span class="kw">$ x2goclient 2&gt;/dev/null</span></span></code></pre></div>
<p>Create and save the session parameters by starting a new session:</p>
<ol type="1">
<li>Session -&gt; New Session
<ul>
<li>Give the session a name</li>
<li>Add the hostname or IP address</li>
<li>Add your login name</li>
<li>Enable ‘auto login’</li>
<li>Change ‘Session type’ to <em>MATE</em></li>
</ul></li>
<li>Change tabs to the Input/Output tab
<ul>
<li>Select a useful custom display geometry (e.g. Width: 1152 Height: 864)</li>
</ul></li>
<li>Change tabs to the Media tab
<ul>
<li>Disable sound and client-side printing</li>
</ul></li>
<li>Click on the ‘OK’ button to save the session data</li>
<li>Start the client connection by clicking on the session name on the right</li>
</ol>
<p>If you are using X2Go between different Linux varieties you might need to solve a few problems like font paths.</p>
<p>At the time of documenting this setup I found that starting the x2goclient from an older Linux system like CentOS 7 to this Ubuntu system needed a tweak in the Ubuntu Pi’s sshd configuration in /etc/ssh/sshd_config; it was fixed by adding ‘PubkeyAcceptedAlgorithms +ssh-rsa’. This was not needed between similar Ubuntu setups.</p>
<!-- Also describe startx? !! in a future client doc point out pkgs
      to install for traditional X fonts
  -->
<!-- -->
<h1 id="chapter-10">Starting Up an NFS service for other Linux devices</h1>
<p>Usually your home directory on your Linux desktop is where most of your important files reside. When you shutdown your desktop then those files are inaccessible. If you also have a Linux laptop then it would be nice to have the same home directory available on both the desktop and the laptop.</p>
<p>Putting your home directory on the Linux server would solve this issue. Here we look at installing an NFS service for 24x7 availability. If you have no other Linux devices then skip this chapter.</p>
<h2 id="configure-the-nfs-daemons">Configure the NFS daemons</h2>
<p>First install the needed packages. The <em>nfs-common</em> package contains both client and server elements; the <em>nfs-kernel-server</em> contains the server daemons <em>rpc.mountd</em> and <em>rpc.nfsd</em>.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true"></a><span class="kw">$ sudo apt install nfs-common nfs-kernel-server</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true"></a>...</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true"></a>The following NEW packages will be installed:</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true"></a>  keyutils libevent-core-2.1-7 nfs-common nfs-kernel-server rpcbind</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true"></a>...</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true"></a>Setting up rpcbind (1.2.6-2build1) ...</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true"></a>Created symlink /etc/systemd/system/multi-user.target.wants/rpcbind.service ...</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true"></a>Created symlink /etc/systemd/system/sockets.target.wants/rpcbind.socket ...</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true"></a>...</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true"></a>Creating config file /etc/idmapd.conf with new version</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true"></a>Creating config file /etc/nfs.conf with new version</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true"></a>...</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true"></a>Created symlink /etc/systemd/system/multi-user.target.wants/nfs-client.target ...</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true"></a>Created symlink /etc/systemd/system/remote-fs.target.wants/nfs-client.target ...</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true"></a>...</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true"></a>Setting up nfs-kernel-server (1:2.6.1-1ubuntu1.2) ...</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true"></a>Created symlink /etc/systemd/system/nfs-client.target.wants/nfs-blkmap.service ...</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true"></a>Created symlink /etc/systemd/system/multi-user.target.wants/nfs-server.service ...</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true"></a>...</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true"></a>Creating config file /etc/exports with new version</span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true"></a>Creating config file /etc/default/nfs-kernel-server with new version</span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true"></a>...</span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true"></a></span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true"></a><span class="co">// show NFS and RPC services which are now enabled:</span></span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true"></a><span class="kw">$ systemctl list-unit-files --state=enabled | egrep &#39;nfs|rpc&#39;</span></span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true"></a>nfs-blkmap.service                  enabled enabled</span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true"></a>nfs-server.service                  enabled enabled</span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true"></a>rpcbind.service                     enabled enabled</span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true"></a>rpcbind.socket                      enabled enabled</span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true"></a>nfs-client.target                   enabled enabled</span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true"></a></span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true"></a><span class="co">// show NFS and RPC processes currently running:</span></span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true"></a><span class="kw">$ ps -ef |egrep &#39;nfs|rpc&#39;</span></span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true"></a>_rpc      271754       1  0 10:45 ?        00:00:00 /sbin/rpcbind -f -w</span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true"></a>root      272176       2  0 10:46 ?        00:00:00 [rpciod]</span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true"></a>root      272280       1  0 10:46 ?        00:00:00 /usr/sbin/rpc.idmapd</span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true"></a>statd     272282       1  0 10:46 ?        00:00:00 /sbin/rpc.statd</span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true"></a>root      272285       1  0 10:46 ?        00:00:00 /usr/sbin/nfsdcld</span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true"></a>root      272286       1  0 10:46 ?        00:00:00 /usr/sbin/rpc.mountd</span>
<span id="cb54-40"><a href="#cb54-40" aria-hidden="true"></a>root      272294       2  0 10:46 ?        00:00:00 [nfsd]</span>
<span id="cb54-41"><a href="#cb54-41" aria-hidden="true"></a>root      272295       2  0 10:46 ?        00:00:00 [nfsd]</span>
<span id="cb54-42"><a href="#cb54-42" aria-hidden="true"></a>root      272296       2  0 10:46 ?        00:00:00 [nfsd]</span>
<span id="cb54-43"><a href="#cb54-43" aria-hidden="true"></a>root      272297       2  0 10:46 ?        00:00:00 [nfsd]</span>
<span id="cb54-44"><a href="#cb54-44" aria-hidden="true"></a>root      272298       2  0 10:46 ?        00:00:00 [nfsd]</span>
<span id="cb54-45"><a href="#cb54-45" aria-hidden="true"></a>root      272299       2  0 10:46 ?        00:00:00 [nfsd]</span>
<span id="cb54-46"><a href="#cb54-46" aria-hidden="true"></a>root      272300       2  0 10:46 ?        00:00:00 [nfsd]</span>
<span id="cb54-47"><a href="#cb54-47" aria-hidden="true"></a>root      272301       2  0 10:46 ?        00:00:00 [nfsd]</span></code></pre></div>
<p>There are a few files to configure. We remove IPv6 RPC services by commenting out <em>udp6</em> and <em>tcp6</em> from /etc/netconfig:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true"></a><span class="kw">$ sudo cp -p /etc/netconfig /etc/netconfig.orig</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true"></a><span class="kw">$ sudo nano /etc/netconfig</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true"></a><span class="kw">$ diff /etc/netconfig.orig /etc/netconfig</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true"></a>15,16c15,16</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true"></a>&lt; udp6       tpi_clts      v     inet6    udp     -       -</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true"></a>&lt; tcp6       tpi_cots_ord  v     inet6    tcp     -       -</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true"></a>---</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true"></a>&gt; #udp6       tpi_clts      v     inet6    udp     -       -</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true"></a>&gt; #tcp6       tpi_cots_ord  v     inet6    tcp     -       -</span></code></pre></div>
<p>Before restarting the daemons we see various IPv6 processes running:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true"></a><span class="kw">$ sudo lsof -i | grep rpc | grep IPv6</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true"></a>systemd        1      root  144u  IPv6 899098    0t0  TCP :sunrpc (LISTEN)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true"></a>systemd        1      root  145u  IPv6 899100    0t0  UDP :sunrpc </span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true"></a>rpcbind   271754      _rpc    6u  IPv6 899098    0t0  TCP :sunrpc (LISTEN)</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true"></a>rpcbind   271754      _rpc    7u  IPv6 899100    0t0  UDP :sunrpc </span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true"></a>rpc.statd 272282     statd   10u  IPv6 897604    0t0  UDP :59540 </span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true"></a>rpc.statd 272282     statd   11u  IPv6 897608    0t0  TCP :47971 (LISTEN)</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true"></a>rpc.mount 272286      root    6u  IPv6 900420    0t0  UDP :53821 </span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true"></a>rpc.mount 272286      root    7u  IPv6 902332    0t0  TCP :45067 (LISTEN)</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true"></a>rpc.mount 272286      root   10u  IPv6 902347    0t0  UDP :43059 </span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true"></a>rpc.mount 272286      root   11u  IPv6 902352    0t0  TCP :39207 (LISTEN)</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true"></a>rpc.mount 272286      root   14u  IPv6 902367    0t0  UDP :52374 </span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true"></a>rpc.mount 272286      root   15u  IPv6 902372    0t0  TCP :52705 (LISTEN)</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true"></a></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true"></a><span class="co">// restart the daemons (only the rpcbind ports still report IPv6)</span></span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true"></a><span class="kw">$ sudo systemctl restart rpcbind nfs-server rpc-statd</span></span></code></pre></div>
<p>Finally, the NFS shares need to be published and shared. It is best to export <em>/home</em> so that logins on both the server and any clients use the same ‘/home’ directories. If you use other directory names you need to change the home directory path in the password file, or create a symbolic link from <em>/home</em> to the new directory – though we can do this, it is a bit messy.</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true"></a><span class="co">// Edit the exports file on the NFS server:</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true"></a><span class="kw">$ sudo cp -p /etc/exports /etc/exports.orig</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true"></a><span class="kw">$ sudo nano /etc/exports</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true"></a></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true"></a><span class="kw">$ diff /etc/exports.orig /etc/exports</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true"></a>6c6,11</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true"></a>&lt; #</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true"></a>---</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true"></a>&gt; </span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true"></a>&gt; # Export home directories using NFSv3 syntax</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true"></a>&gt; # Limit nfs access to the IP address of the client node(s)</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true"></a>&gt; /home   192.168.1.65(rw,sync,no_subtree_check) \</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true"></a>&gt;         192.168.1.85(rw,sync,no_subtree_check)</span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true"></a>&gt;</span></code></pre></div>
<p>Then export the share. It can then be mounted on other clients.</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true"></a><span class="kw">$ sudo exportfs -a</span></span></code></pre></div>
<h2 id="configure-nfs-clients-on-other-hosts">Configure NFS clients on other hosts</h2>
<p>We will use <em>autofs</em> on other Linux hosts to automatically mount and unmount the home directory on demand. Note that any current directories in /home on your client will be affected, since we are going to mount the server’s /home directory using the /home directory. Anything in that directory will be hidden until you unmount the server’s version of /home. Consider migrating the content of /home to the server.</p>
<p>This example uses another Ubuntu host as the NFS client. We install autofs on it and then edit the automount map files as needed.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true"></a><span class="co">// install the autofs package</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true"></a><span class="kw">$ sudo apt install autofs</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true"></a>The following additional packages will be installed:</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true"></a>  keyutils libevent-core-2.1-7 nfs-common rpcbind</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true"></a>...</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true"></a>Setting up rpcbind (1.2.6-2build1) ...</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true"></a>Created symlink /etc/systemd/system/multi-user.target.wants/rpcbind.service ...</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true"></a>Created symlink /etc/systemd/system/sockets.target.wants/rpcbind.socket ...</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true"></a>...</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true"></a>Setting up autofs (5.1.8-1ubuntu1.2) ...</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true"></a>Creating config file /etc/auto.master with new version</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true"></a>...</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true"></a>Setting up nfs-common (1:2.6.1-1ubuntu1.2) ...</span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true"></a>...</span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true"></a>Created symlink /etc/systemd/system/multi-user.target.wants/nfs-client.target ...</span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true"></a>Created symlink /etc/systemd/system/remote-fs.target.wants/nfs-client.target ...</span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true"></a></span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true"></a><span class="co">// If you are getting used to reading &#39;man&#39; pages, then it is useful to use</span></span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true"></a><span class="co">// the &#39;man -k&#39; option to get a list and description of all man pages available</span></span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true"></a><span class="co">// matching a topic:</span></span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true"></a><span class="kw">$ man -k autofs</span></span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true"></a>auto.master (5)      - Master Map for automounter consulted by autofs</span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true"></a>autofs (5)           - Format of the automounter maps</span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true"></a>autofs (8)           - Service control for the automounter</span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true"></a>autofs.conf (5)      - autofs configuration</span>
<span id="cb59-26"><a href="#cb59-26" aria-hidden="true"></a>automount (8)        - manage autofs mount points</span>
<span id="cb59-27"><a href="#cb59-27" aria-hidden="true"></a></span>
<span id="cb59-28"><a href="#cb59-28" aria-hidden="true"></a><span class="co">// Now edit configuration file /etc/autofs.conf and get rid of the &#39;amd&#39; section</span></span>
<span id="cb59-29"><a href="#cb59-29" aria-hidden="true"></a><span class="co">// Keep things simple.</span></span>
<span id="cb59-30"><a href="#cb59-30" aria-hidden="true"></a><span class="kw">$ cd /etc</span></span>
<span id="cb59-31"><a href="#cb59-31" aria-hidden="true"></a><span class="kw">$ sudo cp -p autofs.conf autofs.conf.orig</span></span>
<span id="cb59-32"><a href="#cb59-32" aria-hidden="true"></a><span class="kw">$ sudo nano autofs.conf</span></span>
<span id="cb59-33"><a href="#cb59-33" aria-hidden="true"></a><span class="kw">$ diff autofs.conf.orig autofs.conf</span></span>
<span id="cb59-34"><a href="#cb59-34" aria-hidden="true"></a>404c404</span>
<span id="cb59-35"><a href="#cb59-35" aria-hidden="true"></a>&lt; [ amd ]</span>
<span id="cb59-36"><a href="#cb59-36" aria-hidden="true"></a>---</span>
<span id="cb59-37"><a href="#cb59-37" aria-hidden="true"></a>&gt; #[ amd ]</span>
<span id="cb59-38"><a href="#cb59-38" aria-hidden="true"></a>410c410</span>
<span id="cb59-39"><a href="#cb59-39" aria-hidden="true"></a>&lt; dismount_interval = 300</span>
<span id="cb59-40"><a href="#cb59-40" aria-hidden="true"></a>---</span>
<span id="cb59-41"><a href="#cb59-41" aria-hidden="true"></a>&gt; #dismount_interval = 300</span>
<span id="cb59-42"><a href="#cb59-42" aria-hidden="true"></a></span>
<span id="cb59-43"><a href="#cb59-43" aria-hidden="true"></a><span class="co">// Edit configuration file /etc/auto.master</span></span>
<span id="cb59-44"><a href="#cb59-44" aria-hidden="true"></a><span class="co">// We comment out the &#39;+auto.master&#39; line and append the auto.home configuration</span></span>
<span id="cb59-45"><a href="#cb59-45" aria-hidden="true"></a></span>
<span id="cb59-46"><a href="#cb59-46" aria-hidden="true"></a><span class="kw">$ sudo cp -p auto.master auto.master.orig</span></span>
<span id="cb59-47"><a href="#cb59-47" aria-hidden="true"></a><span class="kw">$ sudo nano auto.master</span></span>
<span id="cb59-48"><a href="#cb59-48" aria-hidden="true"></a><span class="kw">$ diff auto.master.orig auto.master</span></span>
<span id="cb59-49"><a href="#cb59-49" aria-hidden="true"></a>22c22</span>
<span id="cb59-50"><a href="#cb59-50" aria-hidden="true"></a>&lt; +dir:/etc/auto.master.d</span>
<span id="cb59-51"><a href="#cb59-51" aria-hidden="true"></a>---</span>
<span id="cb59-52"><a href="#cb59-52" aria-hidden="true"></a>&gt; #+dir:/etc/auto.master.d</span>
<span id="cb59-53"><a href="#cb59-53" aria-hidden="true"></a>38c38,43</span>
<span id="cb59-54"><a href="#cb59-54" aria-hidden="true"></a>&lt; +auto.master</span>
<span id="cb59-55"><a href="#cb59-55" aria-hidden="true"></a>---</span>
<span id="cb59-56"><a href="#cb59-56" aria-hidden="true"></a>&gt; #+auto.master</span>
<span id="cb59-57"><a href="#cb59-57" aria-hidden="true"></a>&gt; </span>
<span id="cb59-58"><a href="#cb59-58" aria-hidden="true"></a>&gt; ## This is a direct mountpoint for NFS-provided home directories ..</span>
<span id="cb59-59"><a href="#cb59-59" aria-hidden="true"></a>&gt; /-      /etc/auto.home --timeout 300</span>
<span id="cb59-60"><a href="#cb59-60" aria-hidden="true"></a>&gt; </span>
<span id="cb59-61"><a href="#cb59-61" aria-hidden="true"></a></span>
<span id="cb59-62"><a href="#cb59-62" aria-hidden="true"></a><span class="co">// We create /etc/auto.home; every regular user you create also needs</span></span>
<span id="cb59-63"><a href="#cb59-63" aria-hidden="true"></a><span class="co">//  an entry in this file.</span></span>
<span id="cb59-64"><a href="#cb59-64" aria-hidden="true"></a><span class="kw">$ sudo nano /etc/auto.home</span></span>
<span id="cb59-65"><a href="#cb59-65" aria-hidden="true"></a><span class="kw">$ cat /etc/auto.home</span></span>
<span id="cb59-66"><a href="#cb59-66" aria-hidden="true"></a>## For every new user you must add their home directory entry to this file.</span>
<span id="cb59-67"><a href="#cb59-67" aria-hidden="true"></a>## The IP address belongs to the Linux Server of course...</span>
<span id="cb59-68"><a href="#cb59-68" aria-hidden="true"></a>/home/myname \</span>
<span id="cb59-69"><a href="#cb59-69" aria-hidden="true"></a>  -rw,hard,intr,rsize=32768,wsize=32768,retrans=2,timeo=600,tcp,nfsvers=3 \</span>
<span id="cb59-70"><a href="#cb59-70" aria-hidden="true"></a>  192.168.1.90:/home/myname</span></code></pre></div>
<p>Now, you would normally restart autofs - but do not do this immediately:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true"></a><span class="co">// restart autofs:</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true"></a><span class="kw">$ sudo systemctl restart autofs</span></span></code></pre></div>
<p>Consider your impending ‘chicken-and-egg’ issue regarding being a regular user logged into your home directory while you restart autofs, causing your current home directory to disappear. There is some <a href="#root">help on this topic in the appendix</a>. Perhaps the easiest solution if you do not want to fiddle with changes to root access is to <strong>reboot your client device</strong>. If there were no mistakes in your configuration changes then when the client is back up again you should have a home directory that is served by your home server.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true"></a><span class="kw">$ pwd</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true"></a>/home/myname</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true"></a><span class="kw">$ df -h .</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true"></a>Filesystem                    Size  Used Avail Use% Mounted on</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true"></a>192.168.1.90:/home/myname      50G  464M   50G   1% /home/myname</span></code></pre></div>
<h2 id="some-factors-to-consider">Some factors To consider</h2>
<h3 id="what-if-the-server-fails">What if the server fails</h3>
<p>Once you NFS-mount your home directory on your clients, then if for any reason your server is down you will not be able to log in as a regular user. This would be a rare condition, but it would affect your ability to work from your other devices. You need to be able to login locally so that you can address the problem.</p>
<p>You could give your local root user a good password, or you could create another local user on each device and give them administrative rights so that they can use sudo for root access locally:</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true"></a><span class="co">// Suppose the other user is called &#39;helper&#39;</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true"></a><span class="co">// We will give the helper user another home directory</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true"></a><span class="kw">$ sudo mkdir /var/home</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true"></a><span class="kw">$ sudo groupadd -g 1100 helper</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true"></a><span class="kw">$ sudo useradd -u 1100 -g helper -m -d /var/home/helper -c &#39;Helper Account&#39; helper</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true"></a><span class="kw">$ sudo usermod -aG sudo helper</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true"></a><span class="kw">$ grep sudo /etc/group</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true"></a>sudo:x:27:myname,helper</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true"></a></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true"></a><span class="co">// Don&#39;t forget to set a password - presumably it would be the same as your password..</span></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true"></a><span class="kw">$ sudo passwd helper</span></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true"></a>[sudo] password for myname: </span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true"></a>New password: </span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true"></a>Retype new password: </span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true"></a>passwd: password updated successfully</span></code></pre></div>
<h3 id="doing-maintenance-on-the-linux-server">Doing maintenance on the Linux server</h3>
<p>The main benefit of letting the automounter unmount your directory when you log out is that you can easily do maintenance on the server without disturbing the state of your clients - that is, your desktop or laptop or other devices which might still be turned on.</p>
<p>When you log out of a client then the automounter should unmount your directory at the configured time limit - in our case - 5 minutes. But there are some misbehaved software which insists on staying around, and you might want to watch out for that software and investigate what you can do with it. Indeed, your <em>ssh-agent</em> (if you are using it) is not going to go away unless you kill it before logging out. This process alone will keep your home directory mounted on the client.</p>
<p>One solution is to let the display manager clean up for you. If you are using the <em>lightdm</em> display manager then you need to make a root-owned script on your Linux client that will do the job:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true"></a><span class="co">// Remember, this is done on your Linux client desktop, not on the server:</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true"></a><span class="kw">$ cd /etc/lightdm</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true"></a><span class="kw">$ sudo /bin/bash</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true"></a><span class="fu"># touch lightdm.conf</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true"></a><span class="fu"># nano lightdm.conf</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true"></a><span class="fu"># cat lightdm.conf</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true"></a></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true"></a>[Seat:*]</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true"></a>session-cleanup-script=/root/bin/clean-up-user.sh</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true"></a></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true"></a><span class="fu"># cd /root</span></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true"></a><span class="co">// make a bin directory if you don&#39;t have one</span></span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true"></a><span class="fu"># mkdir bin</span></span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true"></a><span class="fu"># touch clean-up-user.sh</span></span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true"></a><span class="fu"># chmod 755 clean-up-user.sh</span></span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true"></a><span class="fu"># nano clean-up-user.sh</span></span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true"></a><span class="fu"># cat clean-up-user.sh</span></span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true"></a>#!/bin/sh</span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true"></a></span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true"></a>## This script is called by the lightdm window manager.  It finds processes</span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true"></a>## owned by users on logout, and kills them.  Don&#39;t use this script if your</span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true"></a>## users need to leave any of these processes running on logout.</span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true"></a></span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true"></a>procs=$(ps -ef | grep -v grep | grep &#39;/lib/systemd/systemd --user&#39; | grep -v &#39;^root&#39;)</span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true"></a></span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true"></a>echo &quot;$procs&quot; | while read user process rest ; do</span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true"></a>  #echo debug: user is $user, proc is $process</span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true"></a>  if [ &quot;$user&quot; != &quot;&quot; ] ; then</span>
<span id="cb63-29"><a href="#cb63-29" aria-hidden="true"></a>    #echo debug: kill $process</span>
<span id="cb63-30"><a href="#cb63-30" aria-hidden="true"></a>    kill $process</span>
<span id="cb63-31"><a href="#cb63-31" aria-hidden="true"></a>  fi</span>
<span id="cb63-32"><a href="#cb63-32" aria-hidden="true"></a>done</span>
<span id="cb63-33"><a href="#cb63-33" aria-hidden="true"></a></span>
<span id="cb63-34"><a href="#cb63-34" aria-hidden="true"></a>procs=$(ps -ef | grep -v grep | grep ssh-agent | grep -v &#39;^root&#39;)</span>
<span id="cb63-35"><a href="#cb63-35" aria-hidden="true"></a>echo &quot;$procs&quot; | while read user process rest ; do</span>
<span id="cb63-36"><a href="#cb63-36" aria-hidden="true"></a>  #echo debug: user is $user, proc is $process</span>
<span id="cb63-37"><a href="#cb63-37" aria-hidden="true"></a>  if [ &quot;$user&quot; != &quot;&quot; ] ; then</span>
<span id="cb63-38"><a href="#cb63-38" aria-hidden="true"></a>    #echo debug: kill $process</span>
<span id="cb63-39"><a href="#cb63-39" aria-hidden="true"></a>    kill $process</span>
<span id="cb63-40"><a href="#cb63-40" aria-hidden="true"></a>  fi</span>
<span id="cb63-41"><a href="#cb63-41" aria-hidden="true"></a>done</span></code></pre></div>
<p>If you are using an X2go remote desktop session then you will not go through the display manager. Therefore the above script will not be called. You can always create a copy of this script in your own ~/bin/ directory and run it from a terminal session just before logging out.</p>
<!-- -->
<h1 id="chapter-11">Creating a web server</h1>
<p>Setting up an <a href="https://ubuntu.com/server/docs/web-servers-apache">Apache</a> web server is a great way to learn about web technologies. <a href="https://en.wikipedia.org/wiki/Nginx">Nginx</a> is another web server available on Ubuntu, but we will concentrate instead on the Apache offering.</p>
<p>We start with installing and doing an initial configuration of an http-based service listening on port 80. Then we enable an https-based service listening on port 443. Enabling https requires setting up a certificate. Since the web server is only in your home network it is tricky to get an official web certificate. Instead we will create a self-signed certificate, and coax web clients to trust it. Another option is to build your own <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-and-configure-a-certificate-authority-ca-on-ubuntu-20-04">certificate authority</a>.</p>
<p>Finally we will look at configuring ownership of some of the Apache directory infrastructure for future web projects and configuring a few virtual hosts.</p>
<h2 id="installing-and-testing-apache-2.4">Installing and testing Apache 2.4</h2>
<p>Install the Apache software. The ssl-cert package allows us to later create an SSL certificate for the https service, so we will install it as well.</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true"></a><span class="co">// The list of enabled apache modules on an Ubuntu system is also shown</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true"></a><span class="co">// for your information:</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true"></a><span class="kw">$ sudo apt install apache2 ssl-cert</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true"></a>...</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true"></a>The following NEW packages will be installed:</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true"></a>  apache2 apache2-bin apache2-data apache2-utils libapr1 libaprutil1</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true"></a>  libaprutil1-dbd-sqlite3 libaprutil1-ldap liblua5.3-0</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true"></a>...</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true"></a>Setting up apache2 (2.4.52-1ubuntu4.5) ...</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true"></a>Enabling module mpm_event.</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true"></a>Enabling module authz_core.</span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true"></a>Enabling module authz_host.</span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true"></a>Enabling module authn_core.</span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true"></a>Enabling module auth_basic.</span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true"></a>Enabling module access_compat.</span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true"></a>Enabling module authn_file.</span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true"></a>Enabling module authz_user.</span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true"></a>Enabling module alias.</span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true"></a>Enabling module dir.</span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true"></a>Enabling module autoindex.</span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true"></a>Enabling module env.</span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true"></a>Enabling module mime.</span>
<span id="cb64-23"><a href="#cb64-23" aria-hidden="true"></a>Enabling module negotiation.</span>
<span id="cb64-24"><a href="#cb64-24" aria-hidden="true"></a>Enabling module setenvif.</span>
<span id="cb64-25"><a href="#cb64-25" aria-hidden="true"></a>Enabling module filter.</span>
<span id="cb64-26"><a href="#cb64-26" aria-hidden="true"></a>Enabling module deflate.</span>
<span id="cb64-27"><a href="#cb64-27" aria-hidden="true"></a>Enabling module status.</span>
<span id="cb64-28"><a href="#cb64-28" aria-hidden="true"></a>Enabling module reqtimeout.</span>
<span id="cb64-29"><a href="#cb64-29" aria-hidden="true"></a>Enabling conf charset.</span>
<span id="cb64-30"><a href="#cb64-30" aria-hidden="true"></a>Enabling conf localized-error-pages.</span>
<span id="cb64-31"><a href="#cb64-31" aria-hidden="true"></a>Enabling conf other-vhosts-access-log.</span>
<span id="cb64-32"><a href="#cb64-32" aria-hidden="true"></a>Enabling conf security.</span>
<span id="cb64-33"><a href="#cb64-33" aria-hidden="true"></a>Enabling conf serve-cgi-bin.</span>
<span id="cb64-34"><a href="#cb64-34" aria-hidden="true"></a>Enabling site 000-default.</span>
<span id="cb64-35"><a href="#cb64-35" aria-hidden="true"></a>Created symlink /etc/systemd/system/multi-user.target.wants/apache2.service → ...</span>
<span id="cb64-36"><a href="#cb64-36" aria-hidden="true"></a>Created symlink /etc/systemd/system/multi-user.target.wants/apache-htcacheclean.service → ...</span>
<span id="cb64-37"><a href="#cb64-37" aria-hidden="true"></a>...</span></code></pre></div>
<p>As always, systemd starts the daemon. It is only listening on port 80 at this point:</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true"></a><span class="kw">$ sudo lsof -i :80</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true"></a>COMMAND    PID     USER   FD   TYPE  DEVICE SIZE/OFF NODE NAME</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true"></a>apache2 508647     root    4u  IPv6 1799685      0t0  TCP *:http (LISTEN)</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true"></a>apache2 508650 www-data    4u  IPv6 1799685      0t0  TCP *:http (LISTEN)</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true"></a>...</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true"></a><span class="kw">$ sudo lsof -i :443</span></span></code></pre></div>
<p>We can open a web client (firefox for example) and look at the default web page. We can also install a couple of useful <em>text-based</em> web clients which are useful for doing quick checks:</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true"></a><span class="kw">$ firefox http://pi.home/</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true"></a></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true"></a><span class="kw">$ sudo apt install links lynx</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true"></a>...</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true"></a>The following NEW packages will be installed:</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true"></a>  liblz1 links lynx lynx-common</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true"></a>...</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true"></a></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true"></a><span class="kw">$ links -dump http://pi.home/ | head</span></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true"></a>   Ubuntu Logo</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true"></a>   Apache2 Default Page</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true"></a>   It works!</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true"></a></span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true"></a>   This is the default welcome page used to test the correct operation of the</span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true"></a>   Apache2 server after installation on Ubuntu systems. ...</span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true"></a></span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true"></a><span class="kw">$ lynx --dump http://pi.home/ | head</span></span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true"></a>   Ubuntu Logo</span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true"></a>   Apache2 Default Page</span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true"></a>   It works!</span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true"></a>   ...</span></code></pre></div>
<p>Log files for the Apache daemon are stored under <em>/var/log/apache2/</em>:</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true"></a><span class="kw">$ head /var/log/apache2/access.log</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true"></a>192.168.1.82 - -  ... &quot;GET / HTTP/1.1&quot; 200 3460 &quot;-&quot; &quot;Mozilla/5.0 ... Firefox/113.0&quot;</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true"></a>192.168.1.82 - -  ... &quot;GET /icons/ubuntu-logo.png HTTP/1.1&quot; 200 3607 &quot;... Firefox/113.0&quot;</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true"></a>192.168.1.82 - -  ... &quot;GET /favicon.ico HTTP/1.1&quot; 404 485 &quot;http://pi.home/&quot; ... Firefox/113.0&quot;</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true"></a>192.168.1.100 - - ... &quot;GET / HTTP/1.1&quot; 200 3460 &quot;-&quot; &quot;Links ... text)&quot;</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true"></a>192.168.1.100 - - ... &quot;GET / HTTP/1.0&quot; 200 3423 &quot;-&quot; &quot;Lynx/2.9.0dev.10 ... GNUTLS/3.7.1&quot;</span></code></pre></div>
<h2 id="generating-a-self-signed-certificate-and-enabling-https">Generating a self-signed certificate and enabling HTTPS</h2>
<p>Before we enable listening on port 443 we will generate a self-signed SSL certificate. I have a script named <a href="https://github.com/deatrich/tools/blob/main/addcert.sh"><em>addcert.sh</em></a> which will generate the needed certificate files. You need to use a configuration file named <a href="https://github.com/deatrich/tools/blob/main/etc/addcert.cnf"><em>addcert.cnf</em></a> and edit it to use your certificate details:</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true"></a><span class="kw">$ mkdir ~/certs</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true"></a><span class="kw">$ cd ~/certs</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true"></a><span class="kw">$ cp /path/to/addcert.cnf .</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true"></a><span class="kw">$ cp /path/to/addcert.sh ~/bin/</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true"></a><span class="kw">$ chmod 755 ~/bin/addcert.sh</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true"></a><span class="kw">$ nano addcert.cnf</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true"></a><span class="kw">$ ~/bin/addcert.sh</span></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true"></a>Certificate request self-signature ok</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true"></a>subject=C = CA, ST = British Columbia, ... CN = pi.home, emailAddress = some.email@somewhere.com</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true"></a>-r--r--r-- 1 myname myname 2000 Jun 21 10:00 server.crt</span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true"></a>-r--r--r-- 1 myname myname 1740 Jun 21 10:00 server.csr</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true"></a>-r-------- 1 myname myname 3272 Jun 21 10:00 server.key</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true"></a>addcert.sh:  SVP copy server files into place and change ownership to root</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true"></a></span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true"></a><span class="co">// You can query the text version of your certificate:</span></span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true"></a><span class="kw">$ openssl x509 -in server.crt -text | less</span></span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true"></a>Certificate:</span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true"></a>    Data:</span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true"></a>        Version: 1 (0x0)</span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true"></a>        Serial Number:</span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true"></a>            70:5b:1d:...</span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true"></a>        Signature Algorithm: sha256WithRSAEncryption</span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true"></a>        Issuer: C = CA, ST = British Columbia, L = Cranbrook, O = Home ...</span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true"></a>        ...</span>
<span id="cb68-25"><a href="#cb68-25" aria-hidden="true"></a>            Not Before: Jun 21 16:00:37 2023 GMT</span>
<span id="cb68-26"><a href="#cb68-26" aria-hidden="true"></a>            Not After : Jun 18 16:00:37 2033 GMT</span>
<span id="cb68-27"><a href="#cb68-27" aria-hidden="true"></a>        ...</span></code></pre></div>
<p>The server key file and the server key certificate need to be copied into the Apache configuration area, and the ssl configuration paths need to be updated:</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true"></a><span class="kw">$ cd /etc/apache2</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true"></a><span class="kw">$ sudo mkdir certs</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true"></a><span class="kw">$ cd /home/myname/certs/</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true"></a><span class="kw">$ sudo cp -pi server.key server.crt /etc/apache2/certs/</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true"></a><span class="kw">$ cd /etc/apache2/certs</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true"></a><span class="kw">$ sudo chown root:root server.key server.crt</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true"></a><span class="kw">$ ls -l</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true"></a>-r--r--r-- 1 root root 2000 Jun 21 10:00 server.crt</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true"></a>-r-------- 1 root root 3272 Jun 21 10:00 server.key</span></code></pre></div>
<p>Now we enable SSL in apache, using a utility named <em>a2enmod</em>. We also enable the SSL default configuration using the utility <em>a2ensite</em>. We need to edit the configuration file with our path to the certificate and key files. Once we have done that we can restart apache.</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true"></a><span class="co">// enable the module:</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true"></a><span class="kw">$ sudo a2enmod ssl</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true"></a>Considering dependency setenvif for ssl:</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true"></a>Module setenvif already enabled</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true"></a>Considering dependency mime for ssl:</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true"></a>Module mime already enabled</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true"></a>Considering dependency socache_shmcb for ssl:</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true"></a>Enabling module socache_shmcb.</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true"></a>Enabling module ssl.</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true"></a>See /usr/share/doc/apache2/README.Debian.gz on how to ... and create self-signed certificates.</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true"></a>...</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true"></a></span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true"></a><span class="co">// enable the SSL configuration as a virtual host:</span></span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true"></a><span class="kw">$ sudo a2ensite default-ssl</span></span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true"></a>Enabling site default-ssl.</span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true"></a>...</span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true"></a></span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true"></a><span class="co">// Listing the enabled configuration files shows the following:</span></span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true"></a><span class="kw">$ pwd</span></span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true"></a>/etc/apache2/</span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true"></a><span class="kw">$ ls -l sites-enabled/</span></span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true"></a>lrwxrwxrwx ... Jun 19 10:47 000-default.conf -&gt; ../sites-available/000-default.conf</span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true"></a>lrwxrwxrwx ... Jun 21 10:19 default-ssl.conf -&gt; ../sites-available/default-ssl.conf</span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true"></a></span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true"></a><span class="co">// So we can edit &#39;/etc/apache2/sites-available/default-ssl.conf&#39;</span></span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true"></a><span class="kw">$ cd /etc/apache2/sites-available</span></span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true"></a><span class="kw">$ sudo cp -p default-ssl.conf default-ssl.conf.orig</span></span>
<span id="cb70-28"><a href="#cb70-28" aria-hidden="true"></a><span class="kw">$ sudo nano default-ssl.conf</span></span>
<span id="cb70-29"><a href="#cb70-29" aria-hidden="true"></a><span class="kw">$ diff default-ssl.conf.orig default-ssl.conf</span></span>
<span id="cb70-30"><a href="#cb70-30" aria-hidden="true"></a>32,33c32,33</span>
<span id="cb70-31"><a href="#cb70-31" aria-hidden="true"></a>&lt;               SSLCertificateFile      /etc/ssl/certs/ssl-cert-snakeoil.pem</span>
<span id="cb70-32"><a href="#cb70-32" aria-hidden="true"></a>&lt;               SSLCertificateKeyFile /etc/ssl/private/ssl-cert-snakeoil.key</span>
<span id="cb70-33"><a href="#cb70-33" aria-hidden="true"></a>---</span>
<span id="cb70-34"><a href="#cb70-34" aria-hidden="true"></a>&gt;               SSLCertificateFile      /etc/apache2/certs/server.crt</span>
<span id="cb70-35"><a href="#cb70-35" aria-hidden="true"></a>&gt;               SSLCertificateKeyFile   /etc/apache2/certs/server.key</span>
<span id="cb70-36"><a href="#cb70-36" aria-hidden="true"></a></span>
<span id="cb70-37"><a href="#cb70-37" aria-hidden="true"></a><span class="kw">$ sudo systemctl restart apache2</span></span>
<span id="cb70-38"><a href="#cb70-38" aria-hidden="true"></a><span class="kw">$ sudo lsof -i | grep apache</span></span>
<span id="cb70-39"><a href="#cb70-39" aria-hidden="true"></a>apache2  549190         root   4u  IPv6 1943852      0t0  TCP *:http (LISTEN)</span>
<span id="cb70-40"><a href="#cb70-40" aria-hidden="true"></a>apache2  549190         root   6u  IPv6 1943856      0t0  TCP *:https (LISTEN)</span>
<span id="cb70-41"><a href="#cb70-41" aria-hidden="true"></a>apache2  549191     www-data   4u  IPv6 1943852      0t0  TCP *:http (LISTEN)</span>
<span id="cb70-42"><a href="#cb70-42" aria-hidden="true"></a>apache2  549191     www-data   6u  IPv6 1943856      0t0  TCP *:https (LISTEN)</span>
<span id="cb70-43"><a href="#cb70-43" aria-hidden="true"></a>apache2  549192     www-data   4u  IPv6 1943852      0t0  TCP *:http (LISTEN)</span>
<span id="cb70-44"><a href="#cb70-44" aria-hidden="true"></a>apache2  549192     www-data   6u  IPv6 1943856      0t0  TCP *:https (LISTEN)</span></code></pre></div>
<p>Now we want to test the secured web connection connection, and ask your web browser to accept the certificate. With <em>firefox</em> we select ‘Advanced’ where we see the message<br />
</p>
<p><em>Error code: MOZILLA_PKIX_ERROR_SELF_SIGNED_CERT</em></p>
<p>We go ahead and accept the risk and we see our default secured web page. You only need to do this once.</p>
<p>Both text mode browsers will warn about self-signed certificates, but also will allow you to connect:</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true"></a><span class="kw">$ firefox https://pi.home</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true"></a></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true"></a><span class="co">// This example is with &#39;links&#39; -- we ignore self-signed certs when we use </span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true"></a><span class="co">// the &#39;-ssl.certicates 0&#39; option</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true"></a><span class="kw">$ links -dump -ssl.certificates 0  http://pi.home/ | head</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true"></a>   Ubuntu Logo</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true"></a>   Apache2 Default Page</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true"></a>   It works!</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true"></a></span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true"></a>   This is the default welcome page used to test ...</span></code></pre></div>
<h2 id="apache-directory-infrastructure">Apache directory infrastructure</h2>
<p>When developing web infrastructure and editing web pages you should always work as a regular user, and never as root. The best way to proceed is to assign ownership of specific directories in the web tree to regular users like yourself.</p>
<p>One way to do this is to simply change the ownership of /var/www/html/ to yourself – this will also change ownership for any files in the directory. This way you can immediately add and change content as a regular user.</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true"></a><span class="kw">$ cd /var/www/html</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true"></a><span class="kw">$ sudo chown -R myname:myname .</span></span></code></pre></div>
<p>Another way to do this is to make sub-directories inside /var/www/html/ and assign ownership of them to yourself. Then you add your own site configuration file(s) in <em>/etc/apache2/sites-available/</em> with your new sub-directory path(s) and enable them.</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true"></a><span class="co">// Make a couple of subdirectories and assign them to yourself.  Suppose</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true"></a><span class="co">// you want to use http-served pages for development under /var/www/html/test/,</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true"></a><span class="co">// and use https-served pages for production under /var/www/html/pi/.</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true"></a><span class="co">// We also copy the existing &#39;index.html&#39; file to each sub-directory as a</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true"></a><span class="co">// quick test:</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true"></a><span class="kw">$ cd /var/www/html</span></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true"></a><span class="kw">$ sudo mkdir test pi</span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true"></a><span class="kw">$ sudo cp -p /var/www/html/index.html test/</span></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true"></a><span class="kw">$ sudo cp -p /var/www/html/index.html pi/</span></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true"></a><span class="kw">$ sudo chown -R myname:myname test pi</span></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true"></a></span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true"></a><span class="co">// Let&#39;s change the &#39;title&#39; description in both &#39;index.html&#39; files so that</span></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true"></a><span class="co">// we see the difference in testing:</span></span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true"></a><span class="kw">$ nano pi/index.html</span></span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true"></a><span class="kw">$ nano test/index.html</span></span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true"></a><span class="kw">$ grep &#39;title&#39; pi/index.html test/index.html</span></span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true"></a>pi/index.html:    &lt;title&gt;Apache2 Ubuntu Default Page on HTTPS (secure): It works&lt;/title&gt;</span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true"></a>test/index.html:    &lt;title&gt;Apache2 Ubuntu Default Page on HTTP (no encryption): It works&lt;/title&gt;</span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true"></a></span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true"></a><span class="co">// Create a configuration file based on the existing configurations:</span></span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true"></a><span class="kw">$ cd /etc/apache2/sites-available</span></span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true"></a><span class="kw">$ sudo cp -p 000-default.conf test.conf</span></span>
<span id="cb73-23"><a href="#cb73-23" aria-hidden="true"></a></span>
<span id="cb73-24"><a href="#cb73-24" aria-hidden="true"></a><span class="co">// Change the DocumentRoot, and also change the log files names for this site:</span></span>
<span id="cb73-25"><a href="#cb73-25" aria-hidden="true"></a><span class="kw">$ sudo nano test.conf</span></span>
<span id="cb73-26"><a href="#cb73-26" aria-hidden="true"></a><span class="kw">$ diff 000-default.conf test.conf </span></span>
<span id="cb73-27"><a href="#cb73-27" aria-hidden="true"></a>12c12</span>
<span id="cb73-28"><a href="#cb73-28" aria-hidden="true"></a>&lt;       DocumentRoot /var/www/html</span>
<span id="cb73-29"><a href="#cb73-29" aria-hidden="true"></a>---</span>
<span id="cb73-30"><a href="#cb73-30" aria-hidden="true"></a>&gt;       DocumentRoot /var/www/html/test</span>
<span id="cb73-31"><a href="#cb73-31" aria-hidden="true"></a>20,21c20,21</span>
<span id="cb73-32"><a href="#cb73-32" aria-hidden="true"></a>&lt;       ErrorLog ${APACHE_LOG_DIR}/error.log</span>
<span id="cb73-33"><a href="#cb73-33" aria-hidden="true"></a>&lt;       CustomLog ${APACHE_LOG_DIR}/access.log combined</span>
<span id="cb73-34"><a href="#cb73-34" aria-hidden="true"></a>---</span>
<span id="cb73-35"><a href="#cb73-35" aria-hidden="true"></a>&gt;       ErrorLog ${APACHE_LOG_DIR}/test-error.log</span>
<span id="cb73-36"><a href="#cb73-36" aria-hidden="true"></a>&gt;       CustomLog ${APACHE_LOG_DIR}/test-access.log combined</span>
<span id="cb73-37"><a href="#cb73-37" aria-hidden="true"></a></span>
<span id="cb73-38"><a href="#cb73-38" aria-hidden="true"></a><span class="kw">$ sudo cp -p default-ssl.conf pi.conf</span></span>
<span id="cb73-39"><a href="#cb73-39" aria-hidden="true"></a></span>
<span id="cb73-40"><a href="#cb73-40" aria-hidden="true"></a><span class="co">// Again, change the DocumentRoot, and change the log files names for this site:</span></span>
<span id="cb73-41"><a href="#cb73-41" aria-hidden="true"></a><span class="kw">$ sudo nano pi.conf</span></span>
<span id="cb73-42"><a href="#cb73-42" aria-hidden="true"></a><span class="kw">$ diff default-ssl.conf pi.conf </span></span>
<span id="cb73-43"><a href="#cb73-43" aria-hidden="true"></a>5c5</span>
<span id="cb73-44"><a href="#cb73-44" aria-hidden="true"></a>&lt;               DocumentRoot /var/www/html</span>
<span id="cb73-45"><a href="#cb73-45" aria-hidden="true"></a>---</span>
<span id="cb73-46"><a href="#cb73-46" aria-hidden="true"></a>&gt;               DocumentRoot /var/www/html/pi</span>
<span id="cb73-47"><a href="#cb73-47" aria-hidden="true"></a>13,14c13,14</span>
<span id="cb73-48"><a href="#cb73-48" aria-hidden="true"></a>&lt;               ErrorLog ${APACHE_LOG_DIR}/error.log</span>
<span id="cb73-49"><a href="#cb73-49" aria-hidden="true"></a>&lt;               CustomLog ${APACHE_LOG_DIR}/access.log combined</span>
<span id="cb73-50"><a href="#cb73-50" aria-hidden="true"></a>---</span>
<span id="cb73-51"><a href="#cb73-51" aria-hidden="true"></a>&gt;               ErrorLog ${APACHE_LOG_DIR}/pi-error.log</span>
<span id="cb73-52"><a href="#cb73-52" aria-hidden="true"></a>&gt;               CustomLog ${APACHE_LOG_DIR}/pi-access.log combined</span>
<span id="cb73-53"><a href="#cb73-53" aria-hidden="true"></a></span>
<span id="cb73-54"><a href="#cb73-54" aria-hidden="true"></a><span class="co">// Finally enable the new site configurations, and disable the old ones;</span></span>
<span id="cb73-55"><a href="#cb73-55" aria-hidden="true"></a><span class="co">// then restart apache:</span></span>
<span id="cb73-56"><a href="#cb73-56" aria-hidden="true"></a><span class="kw">$ sudo a2ensite test</span></span>
<span id="cb73-57"><a href="#cb73-57" aria-hidden="true"></a>Enabling site test.</span>
<span id="cb73-58"><a href="#cb73-58" aria-hidden="true"></a>...</span>
<span id="cb73-59"><a href="#cb73-59" aria-hidden="true"></a><span class="kw">$ sudo a2ensite pi</span></span>
<span id="cb73-60"><a href="#cb73-60" aria-hidden="true"></a>Enabling site pi.</span>
<span id="cb73-61"><a href="#cb73-61" aria-hidden="true"></a>...</span>
<span id="cb73-62"><a href="#cb73-62" aria-hidden="true"></a><span class="kw">$ sudo a2dissite 000-default default-ssl</span></span>
<span id="cb73-63"><a href="#cb73-63" aria-hidden="true"></a>Site 000-default disabled.</span>
<span id="cb73-64"><a href="#cb73-64" aria-hidden="true"></a>Site default-ssl disabled.</span>
<span id="cb73-65"><a href="#cb73-65" aria-hidden="true"></a>...</span>
<span id="cb73-66"><a href="#cb73-66" aria-hidden="true"></a><span class="kw">$ ls -l /etc/apache2/sites-enabled/</span></span>
<span id="cb73-67"><a href="#cb73-67" aria-hidden="true"></a>total 0</span>
<span id="cb73-68"><a href="#cb73-68" aria-hidden="true"></a>lrwxrwxrwx 1 root root 26 Jun 22 14:11 pi.conf -&gt; ../sites-available/pi.conf</span>
<span id="cb73-69"><a href="#cb73-69" aria-hidden="true"></a>lrwxrwxrwx 1 root root 28 Jun 22 14:11 test.conf -&gt; ../sites-available/test.conf</span>
<span id="cb73-70"><a href="#cb73-70" aria-hidden="true"></a><span class="kw">$ sudo systemctl restart apache2</span></span>
<span id="cb73-71"><a href="#cb73-71" aria-hidden="true"></a><span class="kw">$ systemctl status apache2</span></span>
<span id="cb73-72"><a href="#cb73-72" aria-hidden="true"></a>     ...</span>
<span id="cb73-73"><a href="#cb73-73" aria-hidden="true"></a>     Active: active (running) since Thu 2023-06-22 14:14:00 MDT; 2s ago</span>
<span id="cb73-74"><a href="#cb73-74" aria-hidden="true"></a>     ...</span></code></pre></div>
<p>Now test the changed configurations using <em>links</em> and the ‘-source’ argument:</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true"></a><span class="kw">$ links -source http://pi.home/ | grep title</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true"></a>    &lt;title&gt;Apache2 Ubuntu Default Page on HTTP (no encryption): It works&lt;/title&gt;</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true"></a></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true"></a><span class="kw">$ links -source -ssl.certificates 0 https://pi.home/ | grep title</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true"></a>    &lt;title&gt;Apache2 Ubuntu Default Page on HTTPS (secure): It works&lt;/title&gt;</span></code></pre></div>
<p>Also, you can always add new sub-directories for web page design, rather than changing ownership inside /var/www/html. For example, create a sub-directory owned by yourself named /var/www/sites and add your own site configuration in <em>/etc/apache2/sites-available/</em> with your new sub-directory path(s) and enable them. The exercise is very similar to the previous example.</p>
<h2 id="apache-configuration-issues">Apache configuration issues</h2>
<p>For home use the default settings in <em>/etc/apache2/apache2.conf</em> are fine. However these settings are too open in my opinion, and I would never keep such a configuration on a publicly-exposed web server.</p>
<p>Be aware of these settings if you plan on using home-grown configurations on an internet-exposed site:</p>
<ul>
<li>The configuration for the root of the file system allows <em>FollowSymLinks</em></li>
<li>Access to directory <em>/usr/share</em> is allowed</li>
<li>The base of the web tree, <em>/var/www/</em>, allows <em>Indexes</em> and <em>FollowSymLinks</em> – these settings should be enabled only within site configurations for specific sub-directories on an as-needed basis</li>
</ul>
<p>When you work on internet-exposed sites you should generally learn enough about Apache configurations to cope with installing new packages and safely configuring them, without depending on deliberately loose initial configurations that shield you from necessary details.</p>
<h2 id="disabling-ipv6-access-to-the-apache-daemon">Disabling IPv6 access to the Apache daemon</h2>
<p>If you want to configure Apache to listen only for IPv4 connections, then alter <em>/etc/apache2/ports.conf</em> and change instances of <em>Listen PORTNUMBER</em> to <em>Listen 0.0.0.0:PORTNUMBER</em>. You will also need to change site configuration <em>VirtualHost</em> settings to use <em>0.0.0.0:PORTNUMBER</em>. By using ‘0.0.0.0’ all hardware network interfaces on your machine would serve web pages. On SBC hardware that is not an issue; on complex hardware with multiple network interfaces on differing networks this would not necessarily be what you wanted - in that case a specific IP address is used instead.</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true"></a><span class="kw">$ cd /etc/apache2</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true"></a><span class="kw">$ diff ports.conf.orig ports.conf</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true"></a>5c5</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true"></a>&lt; Listen 80</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true"></a>---</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true"></a>&gt; Listen 0.0.0.0:80</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true"></a>8c8</span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true"></a>&lt;       Listen 443</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true"></a>---</span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true"></a>&gt;       Listen 0.0.0.0:443</span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true"></a>12c12</span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true"></a>&lt;       Listen 443</span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true"></a>---</span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true"></a>&gt;       Listen 0.0.0.0:443</span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true"></a></span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true"></a><span class="kw">$ diff sites-available/000-default.conf.orig sites-available/000-default.conf</span></span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true"></a>1c1</span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true"></a>&lt; &lt;VirtualHost *:80&gt;</span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true"></a>---</span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true"></a>&gt; &lt;VirtualHost 0.0.0.0:80&gt;</span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true"></a>10a11,12</span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true"></a>&gt;       ServerName pi.home</span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true"></a>&gt;       ServerAlias pi</span>
<span id="cb75-24"><a href="#cb75-24" aria-hidden="true"></a>12c14,20</span>
<span id="cb75-25"><a href="#cb75-25" aria-hidden="true"></a>&lt;       DocumentRoot /var/www/html</span>
<span id="cb75-26"><a href="#cb75-26" aria-hidden="true"></a>---</span>
<span id="cb75-27"><a href="#cb75-27" aria-hidden="true"></a>&gt;       DocumentRoot /var/www/html/test</span>
<span id="cb75-28"><a href="#cb75-28" aria-hidden="true"></a>...</span>
<span id="cb75-29"><a href="#cb75-29" aria-hidden="true"></a></span>
<span id="cb75-30"><a href="#cb75-30" aria-hidden="true"></a><span class="kw">$ diff sites-available/default-ssl.conf.orig sites-available/default-ssl.conf</span></span>
<span id="cb75-31"><a href="#cb75-31" aria-hidden="true"></a>2c2</span>
<span id="cb75-32"><a href="#cb75-32" aria-hidden="true"></a>&lt;       &lt;VirtualHost _default_:443&gt;</span>
<span id="cb75-33"><a href="#cb75-33" aria-hidden="true"></a>---</span>
<span id="cb75-34"><a href="#cb75-34" aria-hidden="true"></a>&gt;       &lt;VirtualHost 0.0.0.0:443&gt;</span>
<span id="cb75-35"><a href="#cb75-35" aria-hidden="true"></a>...</span></code></pre></div>
<h2 id="installing-the-php-apache-module">Installing the PHP Apache module</h2>
<p>If you are interesting in doing some embedded PHP web development then you only need to install the PHP Apache module:</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true"></a><span class="kw">$ sudo apt install libapache2-mod-php</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true"></a> ...</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true"></a>The following additional packages will be installed:</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true"></a>  libapache2-mod-php8.1 php-common php8.1-cli php8.1-common php8.1-opcache</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true"></a>  php8.1-readline</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true"></a> ...</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true"></a>Unpacking libapache2-mod-php (2:8.1+92ubuntu1) ...</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true"></a>Setting up php-common (2:92ubuntu1) ...</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true"></a>Created symlink /etc/systemd/system/timers.target.wants/phpsessionclean.timer ...</span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true"></a> ...</span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true"></a>Setting up libapache2-mod-php8.1 (8.1.2-1ubuntu2.11) ...</span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true"></a>apache2_invoke: Enable module php8.1</span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true"></a>Setting up libapache2-mod-php (2:8.1+92ubuntu1) ...</span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true"></a> ...</span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true"></a></span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true"></a><span class="co">// the PHP module is already enabled:</span></span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true"></a><span class="kw">$ cd /etc/apache2/</span></span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true"></a><span class="kw">$ find . -iname \*php\*</span></span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true"></a>./mods-available/php8.1.conf</span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true"></a>./mods-available/php8.1.load</span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true"></a>./mods-enabled/php8.1.conf</span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true"></a>./mods-enabled/php8.1.load</span></code></pre></div>
<p>You can quickly test that PHP works; simply create a PHP file in the root of your new web tree and point your browser to it:</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true"></a><span class="co">// Here we assume that the root of your web tree is at /var/www/html/test/</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true"></a><span class="kw">$ cd /var/www/html/test/</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true"></a><span class="kw">$ echo &quot;&lt;?php phpinfo() ?&gt;&quot; &gt; info.php</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true"></a></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true"></a><span class="co">// now use either &#39;firefox&#39; or &#39;links&#39; to look at it:</span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true"></a><span class="kw">$ firefox http://pi.home/info.php</span></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true"></a></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true"></a><span class="kw">$ links -dump http://pi.home/info.php | head</span></span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true"></a>   PHP logo</span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true"></a></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true"></a>   PHP Version 8.1.2-1ubuntu2.11</span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true"></a></span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true"></a>   System            Linux pi.home 5.15.0-1029-raspi #31-Ubuntu SMP PREEMPT</span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true"></a>                     Sat Apr 22 12:26:40 UTC 2023 aarch64</span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true"></a>   Build Date        Feb 22 2023 22:56:18</span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true"></a>   Build System      Linux</span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true"></a>   Server API        Apache 2.0 Handler</span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true"></a> ...</span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true"></a></span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true"></a><span class="co">// The PHP function &#39;phpinfo()&#39; shows all configuration information that</span></span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true"></a><span class="co">// you as a developer want to know about.  However, do not expose all this</span></span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true"></a><span class="co">// information to others in a publicly available web site.  Remove the </span></span>
<span id="cb77-23"><a href="#cb77-23" aria-hidden="true"></a><span class="co">// info.php file after use, or hide it from the apache daemon:</span></span>
<span id="cb77-24"><a href="#cb77-24" aria-hidden="true"></a><span class="kw">$ cd /var/www/html/test/</span></span>
<span id="cb77-25"><a href="#cb77-25" aria-hidden="true"></a><span class="kw">$ rm info.php</span></span>
<span id="cb77-26"><a href="#cb77-26" aria-hidden="true"></a><span class="co">// or set it read-write to yourself only:</span></span>
<span id="cb77-27"><a href="#cb77-27" aria-hidden="true"></a><span class="kw">$ chmod 600 info.php</span></span></code></pre></div>
<p>You might want to disable PHP session cleanup until a later time when you are actually making use of PHP sessions. You can re-enable this later when you think you need it:</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true"></a><span class="kw">$ systemctl list-unit-files | grep php</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true"></a>phpsessionclean.service                    static          -</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true"></a>phpsessionclean.timer                      enabled         enabled</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true"></a></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true"></a><span class="kw">$ sudo systemctl mask phpsessionclean.timer</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true"></a>Created symlink /etc/systemd/system/phpsessionclean.timer → /dev/null.</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true"></a></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true"></a><span class="kw">$ tail -1 /etc/cron.d/php</span></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true"></a>09,39 *     * * *     root   [ -x /usr/lib/php/sessionclean ] &amp;&amp; if ...</span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true"></a></span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true"></a><span class="co">// This is an example case of not making a copy of a file in the same directory.</span></span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true"></a><span class="co">// All valid files in &#39;/etc/cron.d/&#39; are subject to being run by the &#39;cron&#39;</span></span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true"></a><span class="co">// daemon.  Instead we put a copy in root&#39;s home directory, in case we need it</span></span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true"></a><span class="co">// as a reference:</span></span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true"></a><span class="kw">$ sudo cp -p /etc/cron.d/php /root/php.orig</span></span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true"></a></span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true"></a><span class="co">// When we edit this cron file we comment out the active entry with a &#39;#&#39;:</span></span>
<span id="cb78-18"><a href="#cb78-18" aria-hidden="true"></a><span class="kw">$ sudo nano /etc/cron.d/php</span></span>
<span id="cb78-19"><a href="#cb78-19" aria-hidden="true"></a><span class="kw">$ sudo diff /root/php.orig /etc/cron.d/php</span></span>
<span id="cb78-20"><a href="#cb78-20" aria-hidden="true"></a>14c14</span>
<span id="cb78-21"><a href="#cb78-21" aria-hidden="true"></a>&lt; 09,39 *     * * *     root   [ -x /usr/lib/php/sessionclean ] &amp;&amp; if ...</span>
<span id="cb78-22"><a href="#cb78-22" aria-hidden="true"></a>---</span>
<span id="cb78-23"><a href="#cb78-23" aria-hidden="true"></a>&gt; #09,39 *     * * *     root   [ -x /usr/lib/php/sessionclean ] &amp;&amp; if ...</span></code></pre></div>
<!-- !! need to add logging information -->
<!-- -->
<h1 id="chapter-12">Creating a database server</h1>
<p>Linux is a great platform for databases. There are lots of options if you want to dabble in database technology – take a look at an example list of <a href="https://www.zenarmor.com/docs/linux-tutorials/best-open-source-database-software">well-known open source database offerings</a> on zenarmor.com. Ubuntu packages and supports PostgreSQL, SQLite, MariaDB and Redis mentioned on that list.</p>
<p>Here we are going to set up a MariaDB server. MariaDB is a fork of MySQL, well known as one of the four pillars of a <a href="https://en.wikipedia.org/wiki/LAMP_(software_bundle)">LAMP (Linux, Apache, MySQL, PHP/Perl/Python)</a> Server. Note that Ubuntu also provides the MySQL offering that follows the Oracle MySQL maintainers – that package is named <em>mysql-server</em>.</p>
<h2 id="installing-the-server">Installing the server</h2>
<p>The main package for a MariaDB server is <em>mariadb-server</em>. It pulls in additional support packages, including the client software used to query the server databases. Once up and running it listens on port 3306, which is defined in <em>mariadb.cnf</em>. That file is found with other MySQL configuration files residing in <em>/etc/mysql/</em> on a Debian-based system. Note that there is also a file named <em>my.cnf</em> in the configuration area. When you install MariaDB the file ‘my.cnf’ is a symbolic link, pointing through /etc/alternatives to ‘mariadb.cnf’.</p>
<p>Some of the log files go to <em>/var/log/mysql/</em> if you configure it in the server configuration file. Otherwise status logging shows up in <em>/var/log/syslog</em>.</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true"></a><span class="kw">$ sudo apt install mariadb-server</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true"></a>...</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true"></a>The following additional packages will be installed:</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true"></a>  galera-4 libcgi-fast-perl libcgi-pm-perl libconfig-inifiles-perl libdaxctl1</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true"></a>  libdbd-mysql-perl libfcgi-bin libfcgi-perl libfcgi0ldbl</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true"></a>  libhtml-template-perl libmariadb3 libmysqlclient21 libndctl6 libpmem1</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true"></a>  mariadb-client-10.6 mariadb-client-core-10.6 mariadb-common</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true"></a>  mariadb-server-10.6 mariadb-server-core-10.6 mysql-common socat</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true"></a>...</span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true"></a>Setting up mariadb-server-10.6 (1:10.6.12-0ubuntu0.22.04.1) ...</span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true"></a>Created symlink /etc/systemd/system/multi-user.target.wants/mariadb.service ...</span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true"></a>....</span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true"></a></span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true"></a><span class="co">// The server by default listens on port 3306; here we see that only localhost</span></span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true"></a><span class="co">// is bound to that port in the lsof output.  Thus LAN nodes cannot connect:</span></span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true"></a><span class="kw">$ sudo lsof -i :3306</span></span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true"></a>COMMAND     PID  USER   FD   TYPE  DEVICE SIZE/OFF NODE NAME</span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true"></a>mariadbd 709549 mysql   18u  IPv4 2506936      0t0  TCP localhost:mysql (LISTEN)</span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true"></a></span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true"></a><span class="co">// The database files reside in &#39;/var/lib/mysql/&#39;</span></span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true"></a><span class="co">// That directory is protected, so you must use sudo to see it:</span></span>
<span id="cb79-22"><a href="#cb79-22" aria-hidden="true"></a><span class="kw">$ sudo ls -CpF /var/lib/mysql/</span></span>
<span id="cb79-23"><a href="#cb79-23" aria-hidden="true"></a>aria_log.00000001  ib_buffer_pool  multi-master.info    sys/</span>
<span id="cb79-24"><a href="#cb79-24" aria-hidden="true"></a>aria_log_control   ibdata1         mysql/</span>
<span id="cb79-25"><a href="#cb79-25" aria-hidden="true"></a>ddl_recovery.log   ib_logfile0     mysql_upgrade_info</span>
<span id="cb79-26"><a href="#cb79-26" aria-hidden="true"></a>debian-10.6.flag   ibtmp1          performance_schema/</span></code></pre></div>
<h2 id="configuring-the-server">Configuring the server</h2>
<p>The very first thing to do is secure the default configuration. There is a utility named <em>mysql_secure_installation</em> which helps you do this. Note that the MySQL internal administrative user is also named <em>root</em> - this is not the root user for the Linux operating system.</p>
<p>This utility allows you to do these things:</p>
<ul>
<li>enforce ‘unix_socket’ authentication</li>
<li>set a password for the mysql ‘root’ user</li>
<li>remove the anonymous user</li>
<li>disable mysql root login from any other host</li>
<li>remove the test database, which allows anyone access to that database</li>
</ul>
<p>The default answer is ‘Y’ to these questions; therefore if you hit the carriage return you will get the defaults below:</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true"></a><span class="kw">$ mysql_secure_installation</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true"></a>...</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true"></a>Switch to unix_socket authentication [Y/n]</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true"></a>Change the root password? [Y/n]</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true"></a>Remove anonymous users? [Y/n] </span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true"></a>Disallow root login remotely? [Y/n]</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true"></a>Remove test database and access to it? [Y/n] </span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true"></a>...</span></code></pre></div>
<p>Since we set a mysql superuser (‘root’) password, then any user logged into our server can connect as the mysql superuser if they know that password. Otherwise, users with sudo privileges can connect without needing the password:</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true"></a><span class="kw">$ mysql -u root</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true"></a>ERROR 1698 (28000): Access denied for user &#39;root&#39;@&#39;localhost&#39;</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true"></a></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true"></a><span class="co">// Use the &#39;-p&#39; option to get the password prompt:</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true"></a><span class="kw">$ mysql -u root -p</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true"></a>Enter password: </span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true"></a>Welcome to the MariaDB monitor.  Commands end with ; or \g.</span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true"></a>...</span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true"></a></span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true"></a><span class="co">// Or use sudo to connect without the mysql superuser password:</span></span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true"></a><span class="co">// While we are at it, lets look at MySQL system variables to see what</span></span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true"></a><span class="co">// the storage engine defaults might be:</span></span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true"></a><span class="kw">$ sudo mysql -u root</span></span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true"></a>[sudo] password for myname: </span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true"></a>Welcome to the MariaDB monitor.  Commands end with ; or \g.</span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true"></a>Your MariaDB connection id is 33</span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true"></a>Server version: 10.6.12-MariaDB-0ubuntu0.22.04.1 Ubuntu 22.04</span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true"></a>...</span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true"></a><span class="dt">MariaDB&gt; show variables like &#39;%engine%&#39;;</span></span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true"></a>+----------------------------+--------+</span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true"></a>| Variable_name              | Value  |</span>
<span id="cb81-22"><a href="#cb81-22" aria-hidden="true"></a>+----------------------------+--------+</span>
<span id="cb81-23"><a href="#cb81-23" aria-hidden="true"></a>| default_storage_engine     | InnoDB |</span>
<span id="cb81-24"><a href="#cb81-24" aria-hidden="true"></a>| default_tmp_storage_engine |        |</span>
<span id="cb81-25"><a href="#cb81-25" aria-hidden="true"></a>| enforce_storage_engine     |        |</span>
<span id="cb81-26"><a href="#cb81-26" aria-hidden="true"></a>| gtid_pos_auto_engines      |        |</span>
<span id="cb81-27"><a href="#cb81-27" aria-hidden="true"></a>| storage_engine             | InnoDB |</span>
<span id="cb81-28"><a href="#cb81-28" aria-hidden="true"></a>+----------------------------+--------+</span>
<span id="cb81-29"><a href="#cb81-29" aria-hidden="true"></a>5 rows in set (0.004 sec)</span>
<span id="cb81-30"><a href="#cb81-30" aria-hidden="true"></a><span class="dt">MariaDB&gt; show engines;</span></span>
<span id="cb81-31"><a href="#cb81-31" aria-hidden="true"></a>+--------------------+---------+---------------------------------------+--------------+-------+</span>
<span id="cb81-32"><a href="#cb81-32" aria-hidden="true"></a>| Engine             | Support | Comment                               | Transactions | XA ...|</span>
<span id="cb81-33"><a href="#cb81-33" aria-hidden="true"></a>+--------------------+---------+---------------------------------------+--------------+-------+</span>
<span id="cb81-34"><a href="#cb81-34" aria-hidden="true"></a>| CSV                | YES     | Stores tables as CSV files            | NO           | NO ...|</span>
<span id="cb81-35"><a href="#cb81-35" aria-hidden="true"></a>| MRG_MyISAM         | YES     | Collection of identical MyISAM tab... | NO           | NO ...|</span>
<span id="cb81-36"><a href="#cb81-36" aria-hidden="true"></a>| MEMORY             | YES     | Hash based, stored in memory, usef... | NO           | NO ...|</span>
<span id="cb81-37"><a href="#cb81-37" aria-hidden="true"></a>| Aria               | YES     | Crash-safe tables with MyISAM heri... | NO           | NO ...|</span>
<span id="cb81-38"><a href="#cb81-38" aria-hidden="true"></a>| MyISAM             | YES     | Non-transactional engine with good... | NO           | NO ...|</span>
<span id="cb81-39"><a href="#cb81-39" aria-hidden="true"></a>| SEQUENCE           | YES     | Generated tables filled with seque... | YES          | NO ...|</span>
<span id="cb81-40"><a href="#cb81-40" aria-hidden="true"></a>| InnoDB             | DEFAULT | Supports transactions, row-level l... | YES          | YES...|</span>
<span id="cb81-41"><a href="#cb81-41" aria-hidden="true"></a>| PERFORMANCE_SCHEMA | YES     | Performance Schema                    | NO           | NO ...|</span>
<span id="cb81-42"><a href="#cb81-42" aria-hidden="true"></a>+--------------------+---------+---------------------------------------+--------------+-------+</span>
<span id="cb81-43"><a href="#cb81-43" aria-hidden="true"></a></span>
<span id="cb81-44"><a href="#cb81-44" aria-hidden="true"></a><span class="dt">MariaDB&gt; exit;</span></span>
<span id="cb81-45"><a href="#cb81-45" aria-hidden="true"></a>Bye</span></code></pre></div>
<h3 id="allowing-non-superuser-users-to-connect-remotely">Allowing non-superuser users to connect remotely</h3>
<p>Most users who use MySQL databases interact with their own databases, and do not need to touch the administrative server mysql databases. So it is reasonable to expect users to connect to the database from another host. Here we configure the Mariadb server to listen for LAN connections, thus allowing users to connect via our home LAN:</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true"></a><span class="kw">$ head /etc/mysql/mariadb.cnf</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true"></a> # The MariaDB configuration file</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true"></a> #</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true"></a> # The MariaDB/MySQL tools read configuration files in the following order:</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true"></a> # 0. &quot;/etc/mysql/my.cnf&quot; symlinks to this file, reason why all the rest is read.</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true"></a> # 1. &quot;/etc/mysql/mariadb.cnf&quot; (this file) to set global defaults,</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true"></a> # 2. &quot;/etc/mysql/conf.d/*.cnf&quot; to set global options.</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true"></a> # 3. &quot;/etc/mysql/mariadb.conf.d/*.cnf&quot; to set MariaDB-only options.</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true"></a> # 4. &quot;~/.my.cnf&quot; to set user-specific options.</span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true"></a>...</span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true"></a><span class="kw">$ cd /etc/mysql/mariadb.conf.d</span></span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true"></a><span class="kw">$ sudo cp -p 50-server.cnf 50-server.cnf.orig</span></span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true"></a><span class="co">// Edit the server configuration, and change the &#39;bind-address&#39; to 0.0.0.0</span></span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true"></a><span class="co">// Also enable separate error and slow-query logging:</span></span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true"></a><span class="kw">$ sudo nano 50-server.cnf</span></span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true"></a><span class="kw">$ diff 50-server.cnf.orig 50-server.cnf</span></span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true"></a>27c27,28</span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true"></a>&lt; bind-address            = 127.0.0.1</span>
<span id="cb82-19"><a href="#cb82-19" aria-hidden="true"></a>---</span>
<span id="cb82-20"><a href="#cb82-20" aria-hidden="true"></a>&gt; #bind-address            = 127.0.0.1</span>
<span id="cb82-21"><a href="#cb82-21" aria-hidden="true"></a>&gt; bind-address            = 0.0.0.0</span>
<span id="cb82-22"><a href="#cb82-22" aria-hidden="true"></a>57c58</span>
<span id="cb82-23"><a href="#cb82-23" aria-hidden="true"></a>&lt; #log_error = /var/log/mysql/error.log</span>
<span id="cb82-24"><a href="#cb82-24" aria-hidden="true"></a>---</span>
<span id="cb82-25"><a href="#cb82-25" aria-hidden="true"></a>&gt; log_error = /var/log/mysql/error.log</span>
<span id="cb82-26"><a href="#cb82-26" aria-hidden="true"></a>59c60</span>
<span id="cb82-27"><a href="#cb82-27" aria-hidden="true"></a>&lt; #slow_query_log_file    = /var/log/mysql/mariadb-slow.log</span>
<span id="cb82-28"><a href="#cb82-28" aria-hidden="true"></a>---</span>
<span id="cb82-29"><a href="#cb82-29" aria-hidden="true"></a>&gt; slow_query_log_file    = /var/log/mysql/mariadb-slow.log</span>
<span id="cb82-30"><a href="#cb82-30" aria-hidden="true"></a> </span>
<span id="cb82-31"><a href="#cb82-31" aria-hidden="true"></a><span class="kw">$ sudo systemctl restart mariadb</span></span>
<span id="cb82-32"><a href="#cb82-32" aria-hidden="true"></a><span class="kw">$ sudo lsof -i :3306</span></span>
<span id="cb82-33"><a href="#cb82-33" aria-hidden="true"></a>COMMAND     PID  USER   FD   TYPE  DEVICE SIZE/OFF NODE NAME</span>
<span id="cb82-34"><a href="#cb82-34" aria-hidden="true"></a>mariadbd 716168 mysql   18u  IPv4 2530211      0t0  TCP *:mysql (LISTEN)</span>
<span id="cb82-35"><a href="#cb82-35" aria-hidden="true"></a></span>
<span id="cb82-36"><a href="#cb82-36" aria-hidden="true"></a></span>
<span id="cb82-37"><a href="#cb82-37" aria-hidden="true"></a><span class="co">// Though we can connect we are not allowed access until we create a regular</span></span>
<span id="cb82-38"><a href="#cb82-38" aria-hidden="true"></a><span class="co">// database user:</span></span>
<span id="cb82-39"><a href="#cb82-39" aria-hidden="true"></a><span class="kw">$ mysql -u root -h pi.home -p</span></span>
<span id="cb82-40"><a href="#cb82-40" aria-hidden="true"></a>Enter password: </span>
<span id="cb82-41"><a href="#cb82-41" aria-hidden="true"></a>ERROR 1130 (HY000): Host &#39;desktop.home&#39; is not allowed to connect to this MariaDB server</span></code></pre></div>
<p>So back on the database server let’s create an empty database and two users with LAN access to it. One user is ‘rw’ (read-write) with all privileges on its own database; the other user is ‘ro’ (read-only) with only select privileges on its database. In this example the LAN network is identified by all hosts in 192.168.1.</p>
<p>The default <a href="https://mariadb.com/kb/en/storage-engines/">MariaDB storage engine</a> is InnoDB; for this exercise we will create a database named <em>webdb</em>. Until you create at least one table there is only a directory with a text options file exists in the database area. Thus the database engine is defined when tables are created, not at database creation.</p>
<p>There is extensive help at the database prompt:</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true"></a><span class="kw">$ sudo mysql -u root</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true"></a>...</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true"></a><span class="dt">MariaDB&gt; help create database;</span></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true"></a>Name: &#39;CREATE DATABASE&#39;</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true"></a>Description:</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true"></a>Syntax</span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true"></a>------</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true"></a></span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true"></a>CREATE [OR REPLACE] {DATABASE | SCHEMA} [IF NOT EXISTS] db_name</span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true"></a>  [create_specification] ...</span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true"></a>...</span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true"></a>URL: https://mariadb.com/kb/en/create-database/</span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true"></a></span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true"></a><span class="dt">MariaDB&gt; create database webdb;</span></span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true"></a>...</span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true"></a><span class="dt">MariaDB&gt;  grant all privileges on webdb.* to &#39;rw&#39;@&#39;192.168.1.%&#39;</span></span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true"></a><span class="dt">    -&gt; identified by &#39;some_password_here&#39;;</span></span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true"></a></span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true"></a><span class="dt">MariaDB&gt; grant select on webdb.* to &#39;ro&#39;@&#39;192.168.1.%&#39;</span></span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true"></a><span class="dt">    -&gt; identified by &#39;some_other_password_here&#39;;</span></span>
<span id="cb83-21"><a href="#cb83-21" aria-hidden="true"></a></span>
<span id="cb83-22"><a href="#cb83-22" aria-hidden="true"></a><span class="dt">MariaDB&gt; flush privileges;</span></span>
<span id="cb83-23"><a href="#cb83-23" aria-hidden="true"></a>Query OK, 0 rows affected (0.002 sec)</span>
<span id="cb83-24"><a href="#cb83-24" aria-hidden="true"></a></span>
<span id="cb83-25"><a href="#cb83-25" aria-hidden="true"></a><span class="dt">MariaDB&gt; select concat(user, &#39;@&#39;, host) from mysql.global_priv;</span></span>
<span id="cb83-26"><a href="#cb83-26" aria-hidden="true"></a>+-------------------------+</span>
<span id="cb83-27"><a href="#cb83-27" aria-hidden="true"></a>| concat(user, &#39;@&#39;, host) |</span>
<span id="cb83-28"><a href="#cb83-28" aria-hidden="true"></a>+-------------------------+</span>
<span id="cb83-29"><a href="#cb83-29" aria-hidden="true"></a>| ro@192.168.1.%          |</span>
<span id="cb83-30"><a href="#cb83-30" aria-hidden="true"></a>| rw@192.168.1.%          |</span>
<span id="cb83-31"><a href="#cb83-31" aria-hidden="true"></a>| mariadb.sys@localhost   |</span>
<span id="cb83-32"><a href="#cb83-32" aria-hidden="true"></a>| mysql@localhost         |</span>
<span id="cb83-33"><a href="#cb83-33" aria-hidden="true"></a>| root@localhost          |</span>
<span id="cb83-34"><a href="#cb83-34" aria-hidden="true"></a>+-------------------------+</span>
<span id="cb83-35"><a href="#cb83-35" aria-hidden="true"></a>5 rows in set (0.001 sec)</span>
<span id="cb83-36"><a href="#cb83-36" aria-hidden="true"></a></span>
<span id="cb83-37"><a href="#cb83-37" aria-hidden="true"></a><span class="co">// Now I can connect to the database from my desktop:</span></span>
<span id="cb83-38"><a href="#cb83-38" aria-hidden="true"></a></span>
<span id="cb83-39"><a href="#cb83-39" aria-hidden="true"></a><span class="kw">$ mysql -u rw -h pi.home -p webdb</span></span>
<span id="cb83-40"><a href="#cb83-40" aria-hidden="true"></a>Enter password: </span>
<span id="cb83-41"><a href="#cb83-41" aria-hidden="true"></a>Welcome to the MariaDB monitor.  Commands end with ; or \g.</span></code></pre></div>
<p>Now we add a simple table named <em>mytab</em> using the older MyISAM engine. It is annoying to try to create a table interactively. It is better to create a small text file first. So I create an sql file ‘create_tab.sql’, and I source it at the database prompt:</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true"></a><span class="dt">MariaDB&gt; source create_tab.sql;</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true"></a>Query OK, 0 rows affected (0.02 sec)</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true"></a></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true"></a><span class="dt">MariaDB&gt; show tables;</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true"></a>+-----------------+</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true"></a>| Tables_in_webdb |</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true"></a>+-----------------+</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true"></a>| members         |</span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true"></a>+-----------------+</span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true"></a>1 row in set (0.00 sec)</span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true"></a></span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true"></a><span class="dt">MariaDB&gt; show create table members;</span></span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true"></a>...</span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true"></a>| members | CREATE TABLE `members` (</span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true"></a>  `uid` int(8) unsigned NOT NULL AUTO_INCREMENT,</span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true"></a>  `moddate` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(),</span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true"></a>  `credate` timestamp NOT NULL DEFAULT current_timestamp(),</span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true"></a>  `role` set(&#39;user&#39;,&#39;admin&#39;) NOT NULL DEFAULT &#39;user&#39;,</span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true"></a>  `email` set(&#39;Y&#39;,&#39;N&#39;) NOT NULL DEFAULT &#39;N&#39;,</span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true"></a>  PRIMARY KEY (`uid`)</span>
<span id="cb84-21"><a href="#cb84-21" aria-hidden="true"></a>) ENGINE=MyISAM DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci |</span>
<span id="cb84-22"><a href="#cb84-22" aria-hidden="true"></a>...</span>
<span id="cb84-23"><a href="#cb84-23" aria-hidden="true"></a></span>
<span id="cb84-24"><a href="#cb84-24" aria-hidden="true"></a><span class="co">// And I insert a row into the table:</span></span>
<span id="cb84-25"><a href="#cb84-25" aria-hidden="true"></a><span class="dt">MariaDB&gt; insert into members (email) values (&#39;Y&#39;);</span></span>
<span id="cb84-26"><a href="#cb84-26" aria-hidden="true"></a>Query OK, 1 row affected (0.00 sec)</span>
<span id="cb84-27"><a href="#cb84-27" aria-hidden="true"></a></span>
<span id="cb84-28"><a href="#cb84-28" aria-hidden="true"></a><span class="dt">MariaDB&gt; select * from members;</span></span>
<span id="cb84-29"><a href="#cb84-29" aria-hidden="true"></a>+-----+---------------------+---------------------+------+-------+</span>
<span id="cb84-30"><a href="#cb84-30" aria-hidden="true"></a>| uid | moddate             | credate             | role | email |</span>
<span id="cb84-31"><a href="#cb84-31" aria-hidden="true"></a>+-----+---------------------+---------------------+------+-------+</span>
<span id="cb84-32"><a href="#cb84-32" aria-hidden="true"></a>|   1 | 2023-06-30 16:09:29 | 2023-06-30 16:09:29 | user | Y     |</span>
<span id="cb84-33"><a href="#cb84-33" aria-hidden="true"></a>+-----+---------------------+---------------------+------+-------+</span>
<span id="cb84-34"><a href="#cb84-34" aria-hidden="true"></a>1 row in set (0.01 sec)</span>
<span id="cb84-35"><a href="#cb84-35" aria-hidden="true"></a></span>
<span id="cb84-36"><a href="#cb84-36" aria-hidden="true"></a><span class="co">// Then I reconnect as the &#39;read-only&#39; user.  I can select but nothing else:</span></span>
<span id="cb84-37"><a href="#cb84-37" aria-hidden="true"></a><span class="kw">$ mysql -u ro -h pi.home -p webdb</span></span>
<span id="cb84-38"><a href="#cb84-38" aria-hidden="true"></a>Enter password: </span>
<span id="cb84-39"><a href="#cb84-39" aria-hidden="true"></a>Reading table information for completion of table and column names</span>
<span id="cb84-40"><a href="#cb84-40" aria-hidden="true"></a>...</span>
<span id="cb84-41"><a href="#cb84-41" aria-hidden="true"></a><span class="dt">MariaDB&gt; select * from members;</span></span>
<span id="cb84-42"><a href="#cb84-42" aria-hidden="true"></a>+-----+---------------------+---------------------+------+-------+</span>
<span id="cb84-43"><a href="#cb84-43" aria-hidden="true"></a>| uid | moddate             | credate             | role | email |</span>
<span id="cb84-44"><a href="#cb84-44" aria-hidden="true"></a>+-----+---------------------+---------------------+------+-------+</span>
<span id="cb84-45"><a href="#cb84-45" aria-hidden="true"></a>|   1 | 2023-06-30 16:09:29 | 2023-06-30 16:09:29 | user | Y     |</span>
<span id="cb84-46"><a href="#cb84-46" aria-hidden="true"></a>+-----+---------------------+---------------------+------+-------+</span>
<span id="cb84-47"><a href="#cb84-47" aria-hidden="true"></a>1 row in set (0.00 sec)</span>
<span id="cb84-48"><a href="#cb84-48" aria-hidden="true"></a></span>
<span id="cb84-49"><a href="#cb84-49" aria-hidden="true"></a><span class="dt">MariaDB&gt; delete from members;</span></span>
<span id="cb84-50"><a href="#cb84-50" aria-hidden="true"></a>ERROR 1142 (42000): DELETE command denied to user &#39;ro&#39;@&#39;desktop.home&#39; for table `webdb`.`members`</span>
<span id="cb84-51"><a href="#cb84-51" aria-hidden="true"></a></span>
<span id="cb84-52"><a href="#cb84-52" aria-hidden="true"></a><span class="kw">$ sudo ls -l /var/lib/mysql/webdb/</span></span>
<span id="cb84-53"><a href="#cb84-53" aria-hidden="true"></a>-rw-rw---- 1 mysql mysql   67 Jun 30 15:10 db.opt</span>
<span id="cb84-54"><a href="#cb84-54" aria-hidden="true"></a>-rw-rw---- 1 mysql mysql 1050 Jun 30 16:09 members.frm</span>
<span id="cb84-55"><a href="#cb84-55" aria-hidden="true"></a>-rw-rw---- 1 mysql mysql   15 Jun 30 16:09 members.MYD</span>
<span id="cb84-56"><a href="#cb84-56" aria-hidden="true"></a>-rw-rw---- 1 mysql mysql 2048 Jun 30 16:09 members.MYI</span></code></pre></div>
<h2 id="backing-up-a-mariadb-database">Backing up a MariaDB database</h2>
<p>Databases typically cannot be backed up reliably by backing up the filesystem on which they live. Minimally you would need to shut down the database to get a copy of it using this method.</p>
<p>Instead, databases have some sort of export facility that locks and dumps databases on demand, while also leaving the database up and running. Databases also need an import facility to re-create databases from the dump files.</p>
<p>For <a href="https://www.digitalocean.com/community/tutorials/how-to-import-and-export-databases-in-mysql-or-mariadb">MariaDB and MySQL</a> <em>mysqldump</em> is used to export data, while <em>mysqlimport</em> is used to re-create databases.</p>
<p>An <a href="https://github.com/deatrich/tools/blob/main/mysql-backup.sh">example mysql backup script</a> in my github ‘tools’ area can do local backups of the MariaDB database; it should be installed as <em>/root/bin/mysql-backup.sh</em>. It needs a <a href="https://github.com/deatrich/tools/blob/main/etc/mysql-backup.conf">configuration file</a> as well which must be installed as <em>/etc/mysql-backup.conf</em>:</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true"></a><span class="co">// Edit the configuration file in case you want to use different directories:</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true"></a><span class="kw">$ sudo nano /etc/mysql-backup.conf</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true"></a></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true"></a><span class="co">// Run the script in debug mode from the command line to make sure</span></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true"></a><span class="co">// that everything is correctly configured:</span></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true"></a><span class="kw">$ sudo /root/bin/mysql-backup.sh --test</span></span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true"></a></span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true"></a><span class="co">// Run the script once and check the log file for any errors:</span></span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true"></a><span class="kw">$ sudo /root/bin/mysql-backup.sh</span></span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true"></a></span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true"></a><span class="co">// Finally edit the cronjob to do daily database backups (here at 03h00):</span></span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true"></a><span class="kw">$ EDITOR=/bin/nano sudo crontab -e</span></span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true"></a><span class="kw">$ sudo crontab -l | grep mysql</span></span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true"></a>0 3 * * * /root/bin/mysql-backup.sh</span></code></pre></div>
<!-- -->
<h1 id="chapter-13">Starting your own Git service</h1>
<p>Services like <a href="https://github.com/">github.com</a> are wonderful, but sometimes it is useful and necessary to create your own Git server. You might have extremely sensitive data that cannot be exposed on public servers. Sometimes at work you might have internal networks which are deliberately shielded from the public internet, and you might want to play with git at home to learn about running your own server.</p>
<p>Here we look at installing and configuring a Git service. We will also install <em>gitweb</em> so that we have a web interface for browsing the git repositories. It will not be as funky as <em>github</em>, but it will still be useful.</p>
<p>The git service documented here supports 2 protocols accessing our git repositories. Of course, these services are for our home LAN:</p>
<ul>
<li>SSH – only this protocol allows read-write access to our repositories. Each git user provides their public ssh key to have access. The linux owner ‘git’ stores these public keys in the associated authorized keys file.</li>
<li>Git – this protocol allows read-only access to the repositories. You might decide not to offer this protocol; however it can be useful if you are experimenting with automatic installations and you want to automatically pull git-stored configuration information on the fly without fiddling with an ssh configuration.</li>
</ul>
<h2 id="installing-and-configuring-git-services">Installing and configuring Git services</h2>
<p>If ‘git’ is not yet installed, then do it. The Debian git package also includes a git server binary, and a git ‘shell’:</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true"></a><span class="kw">$ sudo apt install git</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true"></a>...</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true"></a>Selecting previously unselected package liberror-perl.</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true"></a>Selecting previously unselected package git-man.</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true"></a>Selecting previously unselected package git.</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true"></a>...</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true"></a></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true"></a><span class="co">// You can get a listing of all components of the git package and search</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true"></a><span class="co">// for specific files:</span></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true"></a><span class="kw">$ dpkg -L git | grep daemon</span></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true"></a>/usr/lib/git-core/git-daemon</span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true"></a>/usr/lib/git-core/git-credential-cache--daemon</span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true"></a></span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true"></a><span class="kw">$ dpkg -L git | grep shell</span></span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true"></a>/usr/bin/git-shell</span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true"></a>/usr/lib/git-core/git-shell</span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true"></a>/usr/share/doc/git/contrib/git-shell-commands</span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true"></a>/usr/share/doc/git/contrib/git-shell-commands/README</span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true"></a>...</span></code></pre></div>
<p>There are a couple of envelope packages for <em>git-daemon</em> offered by Ubuntu:</p>
<ul>
<li>git-daemon-run</li>
<li>git-daemon-sysvinit</li>
</ul>
<p>The documentation for <em>git-daemon-run</em> claims:</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true"></a><span class="kw">$ apt show git-daemon-run</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true"></a>...</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true"></a> git-daemon, as provided by the git package, is a simple server for git</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true"></a> repositories, ideally suited for read-only updates, i.e. pulling from git</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true"></a> repositories through the network.  This package provides a runit service</span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true"></a> for running git-daemon permanently.  This configuration is simpler and</span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true"></a> more reliable than git-daemon-sysvinit, at a cost of being less</span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true"></a> familiar for administrators accustomed to sysvinit.</span></code></pre></div>
<p>We will not use either package for a read-only git pull service; instead we will install <em>xinetd</em> and then the daemon will listen for requests and respond. Note that if you do not want a read-only git pull service then you can skip the section on <em>Setting up the Git Protocol</em>.</p>
<h3 id="setting-up-the-repository">Setting up the repository</h3>
<p>First we need a user, as well as a defined group for that user:</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true"></a><span class="co">// I picked an unused uid and gid less than 1000 (regular users start at uid 1000):</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true"></a><span class="kw">$ sudo groupadd -g 600 git</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true"></a><span class="kw">$ sudo useradd -u 600 -g git -m -s &#39;/usr/bin/git-shell&#39; -c &#39;Code Versioning&#39; git</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true"></a><span class="kw">$ ls -la /home/</span></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true"></a>ls -la /home/</span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true"></a>drwxr-xr-x  4 root     root       33 Jul  7 16:11 .</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true"></a>drwxr-xr-x 21 root     root     4096 Jul  6 14:40 ..</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true"></a>drwxr-x--- 27 myname   myname   4096 Jul  7 16:08 myname</span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true"></a>drwxr-x---  5 git      git        58 Jul  6 14:43 git</span></code></pre></div>
<p>Then we need a directory for the repositories. I decide to put it in /var/www/. Since I already back up that directory then I don’t need to change my backup configuration.</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true"></a><span class="kw">$ sudo mkdir /var/www/git</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true"></a><span class="kw">$ sudo chown git:git /var/www/git</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true"></a></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true"></a><span class="co">// And lets make it easy to specify git service paths by creating a symbolic</span></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true"></a><span class="co">// link to the repository&#39;s top directory:</span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true"></a><span class="kw">$ sudo ln -s /var/www/git /git</span></span></code></pre></div>
<h4 id="adding-a-test-repository">Adding a test repository</h4>
<p>To do some testing we need an initial repository. We need to become the <strong>git user</strong> with sudo. For every repository which we create we go through this process. Typically home users do not make dozens of repositories, so it is not an onerous task. The <a href="#new-git-repo">repository creation process</a> is outlined in the appendix - be sure to look at it.</p>
<p>Here we also do a one-time clean up of the ‘git’ user’s directory - we want to avoid unneeded login configuration files since no one is allowed to login as git except yourself via sudo.</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true"></a><span class="kw">$ sudo -u git /bin/bash</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true"></a><span class="kw">$ cd</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true"></a><span class="kw">$ id</span></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true"></a>uid=600(git) gid=600(git) groups=600(git)</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true"></a><span class="kw">$ ls -a</span></span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true"></a>drwxr-x--- 2 git  git    57 Jul  7 16:11 .</span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true"></a>drwxr-xr-x 5 root root   45 Jul  7 16:11 ..</span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true"></a>-rw-r--r-- 1 git  git   220 Jan  6  2022 .bash_logout</span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true"></a>-rw-r--r-- 1 git  git  3771 Jan  6  2022 .bashrc</span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true"></a>-rw-r--r-- 1 git  git   807 Jan  6  2022 .profile</span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true"></a></span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true"></a><span class="co">// remove the bash files to keep the git user&#39;s life simple</span></span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true"></a><span class="kw">$ rm .bash* .profile</span></span></code></pre></div>
<h3 id="setting-up-the-git-protocol">Setting up the <em>Git</em> protocol</h3>
<p>Do not bother with this service if you will not use <em>read-only</em> git pulls.</p>
<p>We install <em>xinetd</em> and configure it to listen for git requests:</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true"></a><span class="co">// Install xinetd:</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true"></a><span class="kw">$ sudo apt install xinetd</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true"></a></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true"></a><span class="kw">$ systemctl list-unit-files | grep -i xinet</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true"></a>xinetd.service                             generated       -</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true"></a></span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true"></a><span class="kw">$ cd /etc/xinet.d/</span></span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true"></a></span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true"></a><span class="co">// Note that none of these services are enabled -- they are traditional</span></span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true"></a><span class="co">// services from the past.  We will create a &#39;git&#39; service and enable it:</span></span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true"></a><span class="kw">$ ls</span></span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true"></a>chargen      daytime      discard      echo      servers  time</span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true"></a>chargen-udp  daytime-udp  discard-udp  echo-udp  services time-udp</span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true"></a></span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true"></a><span class="kw">$ sudo touch git</span></span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true"></a><span class="kw">$ sudo nano git</span></span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true"></a><span class="kw">$ cat git</span></span>
<span id="cb91-18"><a href="#cb91-18" aria-hidden="true"></a>## description: The git dæmon allows git repositories to be exported using \</span>
<span id="cb91-19"><a href="#cb91-19" aria-hidden="true"></a>##       the git:// protocol.</span>
<span id="cb91-20"><a href="#cb91-20" aria-hidden="true"></a></span>
<span id="cb91-21"><a href="#cb91-21" aria-hidden="true"></a>service git</span>
<span id="cb91-22"><a href="#cb91-22" aria-hidden="true"></a>{</span>
<span id="cb91-23"><a href="#cb91-23" aria-hidden="true"></a>        disable         = no</span>
<span id="cb91-24"><a href="#cb91-24" aria-hidden="true"></a>        socket_type     = stream</span>
<span id="cb91-25"><a href="#cb91-25" aria-hidden="true"></a>        wait            = no</span>
<span id="cb91-26"><a href="#cb91-26" aria-hidden="true"></a>        user            = nobody</span>
<span id="cb91-27"><a href="#cb91-27" aria-hidden="true"></a>        flags           = IPv4</span>
<span id="cb91-28"><a href="#cb91-28" aria-hidden="true"></a>        server          = /usr/lib/git-core/git-daemon</span>
<span id="cb91-29"><a href="#cb91-29" aria-hidden="true"></a>        server_args     = --base-path=/var/www/git --syslog --inetd --verbose</span>
<span id="cb91-30"><a href="#cb91-30" aria-hidden="true"></a>        log_on_failure  += USERID</span>
<span id="cb91-31"><a href="#cb91-31" aria-hidden="true"></a>}</span>
<span id="cb91-32"><a href="#cb91-32" aria-hidden="true"></a></span>
<span id="cb91-33"><a href="#cb91-33" aria-hidden="true"></a><span class="kw">$ sudo systemctl restart xinetd</span></span>
<span id="cb91-34"><a href="#cb91-34" aria-hidden="true"></a><span class="kw">$ systemctl status xinetd</span></span>
<span id="cb91-35"><a href="#cb91-35" aria-hidden="true"></a>...</span>
<span id="cb91-36"><a href="#cb91-36" aria-hidden="true"></a>Jul 06 13:41:59 pi.home xinetd[175277]: 2.3.15.3 started with libwrap loadavg l&gt;</span>
<span id="cb91-37"><a href="#cb91-37" aria-hidden="true"></a>Jul 06 13:41:59 pi.home xinetd[175277]: Started working: 1 available service</span></code></pre></div>
<p>Let’s give it a test. We will clone the <em>test</em> repository, even though it is pretty much empty: <!-- add 'new to git' footnote about .gitconfig ? --></p>
<div class="sourceCode" id="cb92"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true"></a><span class="co">// I clone it on my &#39;desktop&#39; host.  Since the configuration of the Git service</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true"></a><span class="co">// already knows the base path to the repositories then we do not add its path</span></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true"></a><span class="co">// to the clone URL:</span></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true"></a><span class="kw">$ git clone git://pi.home/test</span></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true"></a>Cloning into &#39;test&#39;...</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true"></a>warning: You appear to have cloned an empty repository.</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true"></a></span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true"></a><span class="kw">$ cd test</span></span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true"></a><span class="kw">$ git ls-remote</span></span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true"></a>From git://pi.home/test</span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true"></a></span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true"></a><span class="co">// we can remove it; we will test again when the ssh protocol is ready:</span></span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true"></a><span class="kw">$ cd ..</span></span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true"></a><span class="kw">$ rm -rf test</span></span></code></pre></div>
<h3 id="setting-up-the-ssh-protocol">Setting up the <em>SSH</em> protocol</h3>
<p>First we become the ‘git’ user and do 2 things:</p>
<ul>
<li>We need to allow access to the git user in the secure-shell daemon’s configuration file</li>
<li>We create a <em>git-shell-commands</em> directory and add an informational script.</li>
</ul>
<p>We add access to the git user in <em>/etc/ssh/sshd_config</em>:</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true"></a><span class="kw">$ sudo nano /etc/ssh/sshd_config</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true"></a><span class="kw">$ sudo tail -2 /etc/ssh/sshd_config</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true"></a>AllowUsers  myname@192.168.1.* git@192.168.1.* ...</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true"></a><span class="kw">$ sudo systemctl reload sshd</span></span></code></pre></div>
<p>By default ‘git-shell’ does not allow users to ssh into the git server and get access to the command-line – here is an example:</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true"></a><span class="kw">$ ssh git@pi.home</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true"></a>fatal: Interactive git shell is not enabled.</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true"></a>hint: ~/git-shell-commands should exist and have read and execute access.</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true"></a>Connection to pi.home closed.</span></code></pre></div>
<p>So we create a script that gives a more informational message:</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true"></a><span class="kw">$ whoami</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true"></a>git</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true"></a><span class="kw">$ cd</span></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true"></a><span class="kw">$ mkdir git-shell-commands</span></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true"></a><span class="kw">$ touch git-shell-commands/no-interactive-login</span></span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true"></a><span class="kw">$ chmod 555 git-shell-commands/no-interactive-login</span></span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true"></a><span class="kw">$ nano git-shell-commands/no-interactive-login </span></span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true"></a><span class="kw">$ cat git-shell-commands/no-interactive-login </span></span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true"></a>#!/bin/sh</span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true"></a>printf &#39;%s\n&#39; &quot;Hi $USER! You&#39;ve successfully authenticated, but I do not&quot;</span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true"></a>printf &#39;%s\n&#39; &quot;provide interactive shell access.&quot;</span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true"></a>exit 128</span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true"></a><span class="kw">$ exit</span></span></code></pre></div>
<p>So we try to ssh into the server again from the desktop host:</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true"></a><span class="kw">$ ssh git@pi.home</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true"></a>Hi git! You&#39;ve successfully authenticated, but I do not</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true"></a>provide interactive shell access.</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true"></a>Connection to pi.home closed.</span></code></pre></div>
<p>We also need to create a personal <em>.ssh</em> directory and add an <em>authorized_keys</em> file. Then we will add new users’ public ssh keys to this file. This process is <a href="#new-git-user">detailed in the appendix</a>.</p>
<p>Finally we test the ssh protocol for access to git services:</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true"></a><span class="kw">$ hostname</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true"></a>desktop.home</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true"></a><span class="kw">$ git clone ssh://git@pi.home/git/test</span></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true"></a>Cloning into &#39;test&#39;...</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true"></a>warning: You appear to have cloned an empty repository.</span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true"></a><span class="kw">$ cd test</span></span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true"></a><span class="kw">$ git ls-remote</span></span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true"></a>From ssh://git@pi.home/git/test</span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true"></a></span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true"></a><span class="co">// If you don&#39;t like using &#39;master&#39; as the initial branch name, then you</span></span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true"></a><span class="co">// can change it.  I did not do that here, but you could change it to &#39;main&#39;</span></span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true"></a><span class="co">// with this command:    git config --global init.defaultBranch main</span></span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true"></a></span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true"></a><span class="co">// Let&#39;s add something to the test repo:</span></span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true"></a><span class="kw">$ cp -p /path/to/myxt .</span></span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true"></a><span class="kw">$ git add myxt </span></span>
<span id="cb97-17"><a href="#cb97-17" aria-hidden="true"></a></span>
<span id="cb97-18"><a href="#cb97-18" aria-hidden="true"></a><span class="co">// When you commit your changes you will be prompted to add a comment</span></span>
<span id="cb97-19"><a href="#cb97-19" aria-hidden="true"></a><span class="co">// in your editor of choice (typically &#39;nano&#39;) but for me it is &#39;vim&#39;.</span></span>
<span id="cb97-20"><a href="#cb97-20" aria-hidden="true"></a><span class="kw">$ cat ~/.gitconfig</span></span>
<span id="cb97-21"><a href="#cb97-21" aria-hidden="true"></a>[user]</span>
<span id="cb97-22"><a href="#cb97-22" aria-hidden="true"></a>        name = Your Name</span>
<span id="cb97-23"><a href="#cb97-23" aria-hidden="true"></a>        email = your.name@somewhere.com</span>
<span id="cb97-24"><a href="#cb97-24" aria-hidden="true"></a>[core]</span>
<span id="cb97-25"><a href="#cb97-25" aria-hidden="true"></a>        editor = vim</span>
<span id="cb97-26"><a href="#cb97-26" aria-hidden="true"></a></span>
<span id="cb97-27"><a href="#cb97-27" aria-hidden="true"></a><span class="kw">$ git commit -a</span></span>
<span id="cb97-28"><a href="#cb97-28" aria-hidden="true"></a>[master (root-commit) 254c31c] - test commit.</span>
<span id="cb97-29"><a href="#cb97-29" aria-hidden="true"></a> 1 file changed, 6 insertions(+)</span>
<span id="cb97-30"><a href="#cb97-30" aria-hidden="true"></a> create mode 100755 myxt</span>
<span id="cb97-31"><a href="#cb97-31" aria-hidden="true"></a></span>
<span id="cb97-32"><a href="#cb97-32" aria-hidden="true"></a><span class="kw">$ git push origin master</span></span>
<span id="cb97-33"><a href="#cb97-33" aria-hidden="true"></a>Counting objects: 3, done.</span>
<span id="cb97-34"><a href="#cb97-34" aria-hidden="true"></a>Delta compression using up to 6 threads.</span>
<span id="cb97-35"><a href="#cb97-35" aria-hidden="true"></a>Compressing objects: 100% (2/2), done.</span>
<span id="cb97-36"><a href="#cb97-36" aria-hidden="true"></a>Writing objects: 100% (3/3), 295 bytes | 0 bytes/s, done.</span>
<span id="cb97-37"><a href="#cb97-37" aria-hidden="true"></a>Total 3 (delta 0), reused 0 (delta 0)</span>
<span id="cb97-38"><a href="#cb97-38" aria-hidden="true"></a>To ssh://git@pi.home/git/test</span>
<span id="cb97-39"><a href="#cb97-39" aria-hidden="true"></a> * [new branch]      master -&gt; master</span>
<span id="cb97-40"><a href="#cb97-40" aria-hidden="true"></a><span class="kw">$ git status</span></span>
<span id="cb97-41"><a href="#cb97-41" aria-hidden="true"></a> # On branch master</span>
<span id="cb97-42"><a href="#cb97-42" aria-hidden="true"></a> nothing to commit, working directory clean</span></code></pre></div>
<h2 id="setting-up-gitweb-for-web-access-to-git-repositories">Setting up <strong>gitweb</strong> for web access to Git repositories</h2>
<p>Note that <em>gitweb</em> requires a functioning web service on the server; here I assume that the <a href="#chapter-11">Apache server is installed and running</a>.</p>
<p>First we install and configure gitweb. The Ubuntu <em>gitweb</em> package is just a wrapper for gitweb – instead the actual gitweb files are part of the <em>git</em> package:</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true"></a></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true"></a><span class="kw">$ dpkg -S /usr/share/gitweb</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true"></a>git: /usr/share/gitweb</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true"></a></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true"></a><span class="kw">$ sudo apt install gitweb </span></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true"></a>...</span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true"></a>Setting up gitweb (1:2.34.1-1ubuntu1.9) ...</span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true"></a>apache2_invoke: Enable configuration gitweb</span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true"></a></span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true"></a><span class="co">// Now we alter &#39;/etc/gitweb.conf&#39; so that it matches our setup:</span></span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true"></a><span class="kw">$ sudo cp -p /etc/gitweb.conf /etc/gitweb.conf.orig</span></span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true"></a><span class="kw">$ sudo nano /etc/gitweb.conf</span></span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true"></a><span class="kw">$ diff /etc/gitweb.conf.orig /etc/gitweb.conf</span></span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true"></a>2c2</span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true"></a>&lt; $projectroot = &quot;/var/lib/git&quot;;</span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true"></a>---</span>
<span id="cb98-17"><a href="#cb98-17" aria-hidden="true"></a>&gt; $projectroot = &quot;/var/www/git&quot;;</span>
<span id="cb98-18"><a href="#cb98-18" aria-hidden="true"></a>14a15</span>
<span id="cb98-19"><a href="#cb98-19" aria-hidden="true"></a>&gt; $projects_list = &quot;/git/projects_list_for_homegit&quot;;</span></code></pre></div>
<p>Before trying to access gitweb in the browser we want to enable the cgi module.</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true"></a><span class="kw">$ sudo a2enmod cgi</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true"></a>Enabling module cgi.</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true"></a>To activate the new configuration, you need to run:</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true"></a>  systemctl restart apache2</span></code></pre></div>
<p>We also want to create and maintain a ‘projects_list’ file - this is another thing that you do for each new repository, so <a href="#new-git-repo">its description</a> is found in the appendix.</p>
<p>Once you have a git repository hosted by your Linux server, then you can access it on your Linux server’s web site. Assuming the hostname is <em>pi.home</em> the go to:</p>
<p>https://pi.home/gitweb/</p>
<p>It should look something like this:</p>
<figure>
<img src="gitweb-example.png" id="id" class="class" style="width:100.0%" alt="" /><figcaption>(Your browser looking at your <em>gitweb</em> site)</figcaption>
</figure>
<!--
```console
```
 -->
<!-- -->
<h1 id="chapter-14">Setting up a virtualization service with QEMU/KVM</h1>
<p>Running multiple hosts virtually from the same hardware is very convenient and useful; you might want to:</p>
<ul>
<li>experiment with other Linux distributions</li>
<li>experiment with other Operating Systems</li>
<li>test beta software</li>
<li>set up and test a new service without polluting your home server</li>
</ul>
<p>Running other hosts virtually requires sufficient memory and disk space. Though my Linux server only has 4 GB of memory, I set up an example Rocky Linux 8 virtual host to demonstrate the process. Recall that this server also runs Samba, remote desktops, NFS, Apache, Git and MySQL. It is much better to have 8 GB of memory to start with when implementing virtualization.</p>
<p>Traditionally virtualization is deployed on x86 hardware (your <em>bog standard</em> server room rack server) with Intel or AMD processors, so much of the documentation is geared for those platforms. Systems like the Raspberry Pi with a Broadcom-based SoC<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> and <a href="https://en.wikipedia.org/wiki/ARM_architecture_family">ARM</a> processors are relatively new to hardware-based virtualization.</p>
<p>Though there are <a href="https://www.fosslinux.com/48755/top-opensource-virtualization-software-for-linux.htm">many choices for virtualization software</a>, here we use the combination of three integrated open source software projects to build and manage running virtual hosts:</p>
<dl>
<dt><a href="https://github.com/qemu/qemu">QEMU</a></dt>
<dd>stands for <em>QuickEmulator</em>
</dd>
<dd>it can fully emulate another hardware system, but is much slower without hardware acceleration
</dd>
<dt><a href="https://en.wikipedia.org/wiki/Libvirt">libvirt</a></dt>
<dd>is a multifaceted toolkit used for virtualization management
</dd>
<dt><a href="https://en.wikipedia.org/wiki/Kernel-based_Virtual_Machine">KVM</a></dt>
<dd>stands for <em>Kernel-based Virtual Machine</em>
</dd>
<dd>it is either a kernel module, or it is built into the kernel
</dd>
<dd>the processor (CPU) must have hardware virtualization capabilities in order to support KVM
</dd>
</dl>
<h2 id="verifying-kernel-support">Verifying kernel support</h2>
<p>Before installing virtualization software packages we can check to be sure that our kernel supports KVM:</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true"></a><span class="co">// Install cpu-checker on the Raspberry Pi so that we can check for kvm</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true"></a><span class="co">// capatibilty:</span></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true"></a><span class="kw">$ sudo apt install cpu-checker</span></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true"></a>...</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true"></a></span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true"></a><span class="kw">$ kvm-ok</span></span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true"></a>INFO: /dev/kvm exists</span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true"></a>KVM acceleration can be used</span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true"></a></span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true"></a><span class="co">// Compare this to the older Odroid, which is not compatible:</span></span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true"></a><span class="kw">$ kvm-ok</span></span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true"></a>INFO: Your CPU does not support KVM extensions</span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true"></a>INFO: For more detailed results, you should run this as root</span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true"></a>HINT:   sudo /usr/sbin/kvm-ok</span>
<span id="cb100-15"><a href="#cb100-15" aria-hidden="true"></a><span class="kw">$ sudo kvm-ok</span></span>
<span id="cb100-16"><a href="#cb100-16" aria-hidden="true"></a>INFO: Your CPU does not support KVM extensions</span>
<span id="cb100-17"><a href="#cb100-17" aria-hidden="true"></a>KVM acceleration can NOT be used</span>
<span id="cb100-18"><a href="#cb100-18" aria-hidden="true"></a></span>
<span id="cb100-19"><a href="#cb100-19" aria-hidden="true"></a><span class="co">// Back on the Raspberry Pi, here are some other ways to look at kernel</span></span>
<span id="cb100-20"><a href="#cb100-20" aria-hidden="true"></a><span class="co">// capabilities.  The currently running kernel has a configuration file</span></span>
<span id="cb100-21"><a href="#cb100-21" aria-hidden="true"></a><span class="co">// in /boot which mentions all kernel options configurated:</span></span>
<span id="cb100-22"><a href="#cb100-22" aria-hidden="true"></a><span class="kw">$ grep CONFIG_KVM /boot/config-$(uname -r)</span></span>
<span id="cb100-23"><a href="#cb100-23" aria-hidden="true"></a>CONFIG_KVM=y</span>
<span id="cb100-24"><a href="#cb100-24" aria-hidden="true"></a>CONFIG_KVM_MMIO=y</span>
<span id="cb100-25"><a href="#cb100-25" aria-hidden="true"></a>CONFIG_KVM_VFIO=y</span>
<span id="cb100-26"><a href="#cb100-26" aria-hidden="true"></a>CONFIG_KVM_GENERIC_DIRTYLOG_READ_PROTECT=y</span>
<span id="cb100-27"><a href="#cb100-27" aria-hidden="true"></a>CONFIG_KVM_XFER_TO_GUEST_WORK=y</span>
<span id="cb100-28"><a href="#cb100-28" aria-hidden="true"></a></span>
<span id="cb100-29"><a href="#cb100-29" aria-hidden="true"></a><span class="co">// As well, KVM support is often provided by a kernel module; you can use</span></span>
<span id="cb100-30"><a href="#cb100-30" aria-hidden="true"></a><span class="co">// &#39;modinfo&#39; to query about it. On a Pi it reports that it is &#39;built-in&#39;</span></span>
<span id="cb100-31"><a href="#cb100-31" aria-hidden="true"></a><span class="kw">$ modinfo kvm</span></span>
<span id="cb100-32"><a href="#cb100-32" aria-hidden="true"></a>name:           kvm</span>
<span id="cb100-33"><a href="#cb100-33" aria-hidden="true"></a>filename:       (builtin)</span>
<span id="cb100-34"><a href="#cb100-34" aria-hidden="true"></a>license:        GPL</span>
<span id="cb100-35"><a href="#cb100-35" aria-hidden="true"></a>file:           arch/arm64/kvm/kvm</span>
<span id="cb100-36"><a href="#cb100-36" aria-hidden="true"></a>author:         Qumranet</span>
<span id="cb100-37"><a href="#cb100-37" aria-hidden="true"></a>parm:           halt_poll_ns:uint</span>
<span id="cb100-38"><a href="#cb100-38" aria-hidden="true"></a>parm:           halt_poll_ns_grow:uint</span>
<span id="cb100-39"><a href="#cb100-39" aria-hidden="true"></a>parm:           halt_poll_ns_grow_start:uint</span>
<span id="cb100-40"><a href="#cb100-40" aria-hidden="true"></a>parm:           halt_poll_ns_shrink:uint</span>
<span id="cb100-41"><a href="#cb100-41" aria-hidden="true"></a></span>
<span id="cb100-42"><a href="#cb100-42" aria-hidden="true"></a><span class="co">// Compare the output to an x86 Ubuntu virtual machine where KVM support is </span></span>
<span id="cb100-43"><a href="#cb100-43" aria-hidden="true"></a><span class="co">// provided by a kernel module:</span></span>
<span id="cb100-44"><a href="#cb100-44" aria-hidden="true"></a><span class="kw">$ modinfo kvm | head</span></span>
<span id="cb100-45"><a href="#cb100-45" aria-hidden="true"></a>filename:       /lib/modules/5.19.0-46-generic/kernel/arch/x86/kvm/kvm.ko</span>
<span id="cb100-46"><a href="#cb100-46" aria-hidden="true"></a>license:        GPL</span>
<span id="cb100-47"><a href="#cb100-47" aria-hidden="true"></a>author:         Qumranet</span>
<span id="cb100-48"><a href="#cb100-48" aria-hidden="true"></a>srcversion:     637F3CEEFA045C6DB95F67D</span>
<span id="cb100-49"><a href="#cb100-49" aria-hidden="true"></a>depends:        </span>
<span id="cb100-50"><a href="#cb100-50" aria-hidden="true"></a>retpoline:      Y</span>
<span id="cb100-51"><a href="#cb100-51" aria-hidden="true"></a>intree:         Y</span>
<span id="cb100-52"><a href="#cb100-52" aria-hidden="true"></a>name:           kvm</span>
<span id="cb100-53"><a href="#cb100-53" aria-hidden="true"></a>vermagic:       5.19.0-46-generic SMP preempt mod_unload modversions </span>
<span id="cb100-54"><a href="#cb100-54" aria-hidden="true"></a>...</span></code></pre></div>
<h2 id="changing-the-network-interface-to-bridging-mode">Changing the network interface to bridging mode</h2>
<p>Before we go further, it is really useful to configure <em>bridge networking</em>. If the host server has a bridging network configuration then any virtual hosts which you install can connect directly to your LAN, and they appear as independent hosts. Otherwise the virtual hosts hide behind the Linux host server’s <em>NAT</em><a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> which will forward their traffic to the intended destinations. Other computers on your LAN will not be able to connect to the virtual hosts unless you play with options like port forwarding on the Linux server.</p>
<p>Setting up a bridge is not difficult. Once you do it your server can keep this configuration even if you eventually do not use virtualization services. It is however important to have direct login access to your server in case you make any mistakes and lose your network connection.</p>
<p>Here are the commands which create an ethernet bridge. This example assumes you have manually configured your current network connection first, <a href="#static-ip">as described in the appendix</a>. It does not make sense to me to depend on your home router’s DHCP network configuration when creating a bridge.</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true"></a><span class="co">// Show network connection names and become root</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true"></a><span class="kw">$ nmcli con show --active</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true"></a>NAME                UUID                                  TYPE      DEVICE </span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true"></a>ethernet-eth0       bc6badb3-3dde-4009-998d-2dee20831670  ethernet  eth0</span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true"></a></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true"></a><span class="kw">$ sudo /bin/bash</span></span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true"></a></span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true"></a><span class="co">// Let&#39;s copy the network manager configurations to another place</span></span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true"></a><span class="co">// If we have problems we can revert back to the previous configuration</span></span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true"></a><span class="fu"># cp -a /etc/NetworkManager /var/tmp/NetworkManager.beforebridge</span></span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true"></a></span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true"></a><span class="co">// We add the bridge interface and give it the name &#39;br0&#39;</span></span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true"></a><span class="co">// By default the system names this connection &#39;bridge-br0&#39; unless you pick</span></span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true"></a><span class="co">// a different name:</span></span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true"></a><span class="fu"># nmcli con add type bridge ifname br0</span></span>
<span id="cb101-16"><a href="#cb101-16" aria-hidden="true"></a>Connection &#39;bridge-br0&#39; (f1e8c688-5b47-4576-ad72-b0e082e34da1) successfully added.</span>
<span id="cb101-17"><a href="#cb101-17" aria-hidden="true"></a></span>
<span id="cb101-18"><a href="#cb101-18" aria-hidden="true"></a><span class="co">// Assign the ethernet interface to this bridge by modifying the existing</span></span>
<span id="cb101-19"><a href="#cb101-19" aria-hidden="true"></a><span class="co">// ethernet connection named ethernet-eth0:</span></span>
<span id="cb101-20"><a href="#cb101-20" aria-hidden="true"></a><span class="fu"># nmcli con modify ethernet-eth0 master bridge-br0 slave-type bridge</span></span>
<span id="cb101-21"><a href="#cb101-21" aria-hidden="true"></a><span class="fu"># nmcli con show --active</span></span>
<span id="cb101-22"><a href="#cb101-22" aria-hidden="true"></a>NAME           UUID                                  TYPE      DEVICE </span>
<span id="cb101-23"><a href="#cb101-23" aria-hidden="true"></a>bridge-br0     f1e8c688-5b47-4576-ad72-b0e082e34da1  bridge    br0    </span>
<span id="cb101-24"><a href="#cb101-24" aria-hidden="true"></a>ethernet-eth0  bc6badb3-3dde-4009-998d-2dee20831670  ethernet  eth0   </span></code></pre></div>
<p>This example uses my IP addresses, MAC addresses, home router gateway and name server configuration. Your configuration will of course be different:</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true"></a><span class="co">// We want the bridge to have the same MAC address as the ethernet device.</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true"></a><span class="co">// Remember that you reserved an IP address for your mac address on the</span></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true"></a><span class="co">// home router so that only your server uses the IP address:</span></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true"></a><span class="fu"># nmcli con mod bridge-br0 ethernet.cloned-mac-address e4:5f:01:a7:22:54</span></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true"></a></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true"></a><span class="co">// Let&#39;s turn off the Spanning Tree Protocol; we don&#39;t need it for our</span></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true"></a><span class="co">// simple setup:</span></span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true"></a><span class="fu"># nmcli con modify bridge-br0 bridge.stp no</span></span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true"></a></span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true"></a><span class="co">// As we are manually configuring the network configuration, then we set</span></span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true"></a><span class="co">// the IPv4 address, subnet mask, gateway and DNS for the bridge.</span></span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true"></a><span class="fu"># nmcli con modify bridge-br0 ipv4.method manual ipv4.addresses 192.168.1.90/24 gw4 192.168.1.254</span></span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true"></a><span class="fu"># nmcli con modify bridge-br0 ipv4.dns &quot;1.1.1.1 8.8.8.8 192.168.1.254 75.153.171.67&quot;</span></span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true"></a></span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true"></a><span class="co">// Bring the bridge up; it will take some seconds:</span></span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true"></a><span class="fu"># nmcli con up bridge-br0</span></span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true"></a>Connection successfully activated (master waiting for slaves) ...</span>
<span id="cb102-18"><a href="#cb102-18" aria-hidden="true"></a></span>
<span id="cb102-19"><a href="#cb102-19" aria-hidden="true"></a><span class="fu"># nmcli con show --active</span></span>
<span id="cb102-20"><a href="#cb102-20" aria-hidden="true"></a>NAME           UUID                                  TYPE      DEVICE </span>
<span id="cb102-21"><a href="#cb102-21" aria-hidden="true"></a>bridge-br0     f1e8c688-5b47-4576-ad72-b0e082e34da1  bridge    br0    </span>
<span id="cb102-22"><a href="#cb102-22" aria-hidden="true"></a>ethernet-eth0  bc6badb3-3dde-4009-998d-2dee20831670  ethernet  eth0   </span></code></pre></div>
<p>If you want to use a bridge-specific utility, you can install <em>bridge-utils</em> so that you have access to the <em>brctl</em> command:</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true"></a><span class="kw">$ sudo apt install bridge-utils</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true"></a>...</span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true"></a><span class="kw">$ brctl show</span></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true"></a>bridge name     bridge id               STP enabled     interfaces</span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true"></a>br0             8000.e45f01a7110d       no              eth0</span></code></pre></div>
<h2 id="installing-the-software">Installing the software</h2>
<p>Now we are ready to install the required software. First we install <em>qemu-system-arm</em>. You could also install <em>qemu-kvm</em>, a virtual package, and it will pick the right package to match your architecture, which is qemu-system-arm:</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true"></a><span class="kw">$ sudo apt install qemu-system-arm</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true"></a>...</span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true"></a>The following additional packages will be installed:</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true"></a>  ipxe-qemu ipxe-qemu-256k-compat-efi-roms ... qemu-efi-aarch64</span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true"></a>  qemu-efi-arm qemu-system-common qemu-system-data qemu-system-gui qemu-utils</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true"></a>...</span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true"></a>Created symlink /etc/systemd/system/multi-user.target.wants/qemu-kvm.service ...</span></code></pre></div>
<p>Then we install the needed libvirt packages:</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true"></a><span class="kw">$ sudo apt install libvirt-daemon-system libvirt-clients</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true"></a>...</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true"></a>The following additional packages will be installed:</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true"></a>  dmeventd jq libdevmapper-event1.02.1 libjq1 liblvm2cmd2.03 libnss-mymachines</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true"></a>  libonig5 libtpms0 libvirt-clients libvirt-daemon-config-network</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true"></a>  libvirt-daemon-config-nwfilter libvirt-daemon-driver-qemu</span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true"></a>  libvirt-daemon-system-systemd libvirt0 libxml2-utils lvm2 mdevctl swtpm</span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true"></a>  swtpm-tools systemd-container thin-provisioning-tools</span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true"></a>...</span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true"></a>Created symlink /etc/systemd/system/multi-user.target.wants/machines.target ...</span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true"></a>...</span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true"></a>Enabling libvirt default network</span>
<span id="cb105-13"><a href="#cb105-13" aria-hidden="true"></a>Created symlink /etc/systemd/system/multi-user.target.wants/libvirtd.service ...</span>
<span id="cb105-14"><a href="#cb105-14" aria-hidden="true"></a>...</span>
<span id="cb105-15"><a href="#cb105-15" aria-hidden="true"></a>Created symlink /etc/systemd/system/multi-user.target.wants/libvirt-guests.service ...</span>
<span id="cb105-16"><a href="#cb105-16" aria-hidden="true"></a>...</span>
<span id="cb105-17"><a href="#cb105-17" aria-hidden="true"></a>Created symlink /etc/systemd/system/sysinit.target.wants/blk-availability.service ...</span>
<span id="cb105-18"><a href="#cb105-18" aria-hidden="true"></a>Created symlink /etc/systemd/system/sysinit.target.wants/lvm2-monitor.service ...</span>
<span id="cb105-19"><a href="#cb105-19" aria-hidden="true"></a>...</span>
<span id="cb105-20"><a href="#cb105-20" aria-hidden="true"></a>Processing triggers for initramfs-tools (0.140ubuntu13.1) ...</span>
<span id="cb105-21"><a href="#cb105-21" aria-hidden="true"></a>update-initramfs: Generating /boot/initrd.img-5.15.0-1033-raspi</span>
<span id="cb105-22"><a href="#cb105-22" aria-hidden="true"></a>... (a bunch of messages occur whenever update-initramfs is invoked)</span></code></pre></div>
<p>We also want <em>virt-manager</em>, a useful management GUI. It will bring in virt-viewer and the <em>virtinst</em> package, which provides <em>virt-install</em>.</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true"></a><span class="kw">$ sudo apt install virt-manager</span></span></code></pre></div>
<p>Note that we can install <em>qemu-system-x86</em>, which allows full system emulation of binaries on x86 hardware; that is, i386 and x86_64. However there is no hardware acceleration for those architectures on a Raspberry Pi, so it is too slow to use in any practical way.</p>
<h2 id="disabling-the-default-virtual-network">Disabling the default virtual network</h2>
<div class="sourceCode" id="cb107"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true"></a><span class="co">// We will not be using the default virtual network, which operates behind</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true"></a><span class="co">// a NAT.  You might decide to keep the default virtual network if you need</span></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true"></a><span class="co">// the NAT for a particular purpose - for example - you purchase a VPN and</span></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true"></a><span class="co">// configure one of your virtual hosts to use that VPN.  You would need to</span></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true"></a><span class="co">// configure that virtual host to use your NAT.</span></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true"></a></span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true"></a></span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true"></a><span class="co">// Here we show what it is, and then we disable it:</span></span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true"></a><span class="kw">$ virsh net-list</span></span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true"></a> Name      State    Autostart   Persistent</span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true"></a>--------------------------------------------</span>
<span id="cb107-12"><a href="#cb107-12" aria-hidden="true"></a> default   active   yes         yes</span>
<span id="cb107-13"><a href="#cb107-13" aria-hidden="true"></a></span>
<span id="cb107-14"><a href="#cb107-14" aria-hidden="true"></a><span class="kw">$ virsh net-dumpxml default</span></span>
<span id="cb107-15"><a href="#cb107-15" aria-hidden="true"></a>&lt;network&gt;</span>
<span id="cb107-16"><a href="#cb107-16" aria-hidden="true"></a>  &lt;name&gt;default&lt;/name&gt;</span>
<span id="cb107-17"><a href="#cb107-17" aria-hidden="true"></a>  &lt;uuid&gt;0e5a34e6-85c9-49ba-a38a-7ce4dfe49a34&lt;/uuid&gt;</span>
<span id="cb107-18"><a href="#cb107-18" aria-hidden="true"></a>  &lt;forward mode=&#39;nat&#39;/&gt;</span>
<span id="cb107-19"><a href="#cb107-19" aria-hidden="true"></a>  &lt;bridge name=&#39;virbr0&#39; stp=&#39;on&#39; delay=&#39;0&#39;/&gt;</span>
<span id="cb107-20"><a href="#cb107-20" aria-hidden="true"></a>  &lt;mac address=&#39;52:54:00:05:29:43&#39;/&gt;</span>
<span id="cb107-21"><a href="#cb107-21" aria-hidden="true"></a>  &lt;ip address=&#39;192.168.123.1&#39; netmask=&#39;255.255.255.0&#39;&gt;</span>
<span id="cb107-22"><a href="#cb107-22" aria-hidden="true"></a>    &lt;dhcp&gt;</span>
<span id="cb107-23"><a href="#cb107-23" aria-hidden="true"></a>      &lt;range start=&#39;192.168.123.2&#39; end=&#39;192.168.123.254&#39;/&gt;</span>
<span id="cb107-24"><a href="#cb107-24" aria-hidden="true"></a>    &lt;/dhcp&gt;</span>
<span id="cb107-25"><a href="#cb107-25" aria-hidden="true"></a>  &lt;/ip&gt;</span>
<span id="cb107-26"><a href="#cb107-26" aria-hidden="true"></a>&lt;/network&gt;</span>
<span id="cb107-27"><a href="#cb107-27" aria-hidden="true"></a></span>
<span id="cb107-28"><a href="#cb107-28" aria-hidden="true"></a><span class="kw">$ sudo /bin/bash</span></span>
<span id="cb107-29"><a href="#cb107-29" aria-hidden="true"></a><span class="fu"># virsh net-autostart default --disable</span></span>
<span id="cb107-30"><a href="#cb107-30" aria-hidden="true"></a><span class="fu"># virsh net-destroy default</span></span>
<span id="cb107-31"><a href="#cb107-31" aria-hidden="true"></a><span class="fu"># virsh net-undefine default</span></span>
<span id="cb107-32"><a href="#cb107-32" aria-hidden="true"></a>Network default has been undefined</span>
<span id="cb107-33"><a href="#cb107-33" aria-hidden="true"></a><span class="fu"># virsh net-list --all</span></span>
<span id="cb107-34"><a href="#cb107-34" aria-hidden="true"></a> Name   State   Autostart   Persistent</span>
<span id="cb107-35"><a href="#cb107-35" aria-hidden="true"></a>----------------------------------------</span></code></pre></div>
<h2 id="setting-up-a-disk-area-for-clients-and-boot-images">Setting up a disk area for clients and boot images</h2>
<p>The default location for virtual hosts’ disks and boot images in in:</p>
<dl>
<dt><em>/var/lib/libvirt/boot</em></dt>
<dd>for boot images
</dd>
<dt><em>/var/lib/libvirt/images</em></dt>
<dd>for virtual host disk images
</dd>
</dl>
<p>The disk space used can be very large, so I prefer to use instead a large data disk which is mounted as <em>/data</em>, in the sub-directory <em>/data/kvm/</em>.</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true"></a><span class="kw">$ df -h /data/</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true"></a>Filesystem      Size  Used Avail Use% Mounted on</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true"></a>/dev/mmcblk0p3  142G   26G  115G  19% /data</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true"></a></span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true"></a><span class="kw">$ sudo /bin/bash</span></span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true"></a><span class="fu"># mkdir -p /data/kvm/client-images /data/kvm/boot-isos</span></span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true"></a></span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true"></a><span class="co">// Create pool for virtual host client disk images</span></span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true"></a><span class="fu"># virsh pool-define-as --name clients --type dir --target /data/kvm/client-images</span></span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true"></a>Pool clients defined</span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true"></a></span>
<span id="cb108-12"><a href="#cb108-12" aria-hidden="true"></a><span class="co">// Create pool for boot iso installer images</span></span>
<span id="cb108-13"><a href="#cb108-13" aria-hidden="true"></a><span class="fu"># virsh pool-define-as --name boot-isos --type dir --target /data/kvm/boot-isos</span></span>
<span id="cb108-14"><a href="#cb108-14" aria-hidden="true"></a>Pool boot-isos defined</span>
<span id="cb108-15"><a href="#cb108-15" aria-hidden="true"></a></span>
<span id="cb108-16"><a href="#cb108-16" aria-hidden="true"></a><span class="fu"># virsh pool-list --all</span></span>
<span id="cb108-17"><a href="#cb108-17" aria-hidden="true"></a> Name        State      Autostart</span>
<span id="cb108-18"><a href="#cb108-18" aria-hidden="true"></a>---------------------------------</span>
<span id="cb108-19"><a href="#cb108-19" aria-hidden="true"></a> clients     inactive   no</span>
<span id="cb108-20"><a href="#cb108-20" aria-hidden="true"></a> boot-isos   inactive   no</span>
<span id="cb108-21"><a href="#cb108-21" aria-hidden="true"></a></span>
<span id="cb108-22"><a href="#cb108-22" aria-hidden="true"></a><span class="fu"># virsh pool-start clients</span></span>
<span id="cb108-23"><a href="#cb108-23" aria-hidden="true"></a>Pool clients started</span>
<span id="cb108-24"><a href="#cb108-24" aria-hidden="true"></a><span class="fu"># virsh pool-start boot-isos</span></span>
<span id="cb108-25"><a href="#cb108-25" aria-hidden="true"></a>Pool boot-isos started</span>
<span id="cb108-26"><a href="#cb108-26" aria-hidden="true"></a></span>
<span id="cb108-27"><a href="#cb108-27" aria-hidden="true"></a><span class="fu"># virsh pool-autostart boot-isos</span></span>
<span id="cb108-28"><a href="#cb108-28" aria-hidden="true"></a>Pool boot-isos marked as autostarted</span>
<span id="cb108-29"><a href="#cb108-29" aria-hidden="true"></a><span class="fu"># virsh pool-autostart clients</span></span>
<span id="cb108-30"><a href="#cb108-30" aria-hidden="true"></a>Pool clients marked as autostarted</span>
<span id="cb108-31"><a href="#cb108-31" aria-hidden="true"></a></span>
<span id="cb108-32"><a href="#cb108-32" aria-hidden="true"></a><span class="co">// Note that libvirtd always creates a &#39;default&#39; pool, and sets its</span></span>
<span id="cb108-33"><a href="#cb108-33" aria-hidden="true"></a><span class="co">//  path to /var/lib/libvirt/images</span></span>
<span id="cb108-34"><a href="#cb108-34" aria-hidden="true"></a><span class="co">// The first time you create a VM the &#39;default&#39; pool will magically appear.</span></span>
<span id="cb108-35"><a href="#cb108-35" aria-hidden="true"></a><span class="co">// Do not select that pool during installation if you have created another</span></span>
<span id="cb108-36"><a href="#cb108-36" aria-hidden="true"></a><span class="co">//  pool such as &#39;clients&#39; here:</span></span>
<span id="cb108-37"><a href="#cb108-37" aria-hidden="true"></a><span class="fu"># virsh pool-list --all</span></span>
<span id="cb108-38"><a href="#cb108-38" aria-hidden="true"></a> Name        State    Autostart</span>
<span id="cb108-39"><a href="#cb108-39" aria-hidden="true"></a>---------------------------------</span>
<span id="cb108-40"><a href="#cb108-40" aria-hidden="true"></a> boot-isos   active   yes</span>
<span id="cb108-41"><a href="#cb108-41" aria-hidden="true"></a> clients     active   yes</span>
<span id="cb108-42"><a href="#cb108-42" aria-hidden="true"></a></span>
<span id="cb108-43"><a href="#cb108-43" aria-hidden="true"></a><span class="co">// Then I assign ownership of the boot images to myself:</span></span>
<span id="cb108-44"><a href="#cb108-44" aria-hidden="true"></a><span class="kw">$ sudo chown myname:myname /data/kvm/boot-images</span></span>
<span id="cb108-45"><a href="#cb108-45" aria-hidden="true"></a><span class="kw">$ scp -p desktop:/path/to/ubuntu-22.04.2-live-server-arm64.iso /data/kvm/boot-images/</span></span>
<span id="cb108-46"><a href="#cb108-46" aria-hidden="true"></a><span class="kw">$ scp -p desktop:/path/to/Rocky-8.8-aarch64-minimal.iso /data/kvm/boot-images/</span></span>
<span id="cb108-47"><a href="#cb108-47" aria-hidden="true"></a></span>
<span id="cb108-48"><a href="#cb108-48" aria-hidden="true"></a><span class="kw">$ virsh vol-list boot-isos</span></span>
<span id="cb108-49"><a href="#cb108-49" aria-hidden="true"></a> Name                                   Path</span>
<span id="cb108-50"><a href="#cb108-50" aria-hidden="true"></a>-----------------------------------------------------------------------------------------------</span>
<span id="cb108-51"><a href="#cb108-51" aria-hidden="true"></a> Rocky-8.8-aarch64-minimal.iso         /data/kvm/boot-isos/Rocky-8.8-aarch64-minimal.iso</span>
<span id="cb108-52"><a href="#cb108-52" aria-hidden="true"></a> ubuntu-22.04.2-live-server-arm64.iso  /data/kvm/boot-isos/ubuntu-22.04.2-live-server-arm64.iso</span></code></pre></div>
<h2 id="creating-some-virtual-hosts">Creating some virtual hosts</h2>
<p>There are 2 ways to install virtual machines (VMs):</p>
<ul>
<li>Using the <em>virt-manager</em> GUI</li>
<li>Using the <em>virt-install</em> command-line</li>
</ul>
<p>As a demonstration I installed a couple of VMs – one was an Ubuntu 22.04 server, and the other was a Rocky 8.8 Linux minimal server. Of course, both were ARM architectures so that the KVM acceleration capability of the Raspberry Pi’s architecture was used.</p>
<p>Note that all installed VMs are described by XML files, and those XML files can always be found in <em>/etc/libvirt/qemu/</em>.</p>
<h3 id="virt-manager">virt-manager</h3>
<p>There are a number of <a href="https://phoenixnap.com/kb/ubuntu-install-kvm">tutorials</a> on the web showing you how to create a new VM using virt-manager, so I do not reproduce the process here.</p>
<p>Note that when you launch <em>virt-manager</em> it always takes some seconds to appear.</p>
<p>Before creating a new VM, create the disk volume that will be its disk. You do this by choosing ‘Edit’ and then ‘Connections Details’. Click on the ‘Storage’ tab and add a volume under the correct filesystem directory, which is <em>clients</em> in my example in this chapter.</p>
<p>Installing an Ubuntu server VM works with 1024 MB (though I chose 1534 MB of RAM), and a disk size of 20 GB. I chose to install ‘Ubuntu Server’ rather than the minimized server during the installation dialog.</p>
<p>It is very useful to always select ‘Customize configuration before install’ on the last panel when creating a new VM. Then you can look at the VM details and change things before beginning the installation, such as:</p>
<ul>
<li>change the virtual firmware selection in the overview</li>
<li>change the virtual network card (NIC) MAC address</li>
<li>add a boot menu in the boot options</li>
</ul>
<h3 id="virt-install">virt-install</h3>
<p>The command-line utility <em>virt-install</em> is very useful. It is best done in a script because of the large number of options, but here is an example of using it to install Rocky Linux.</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true"></a><span class="co">// This one had an issue falling into an EFI shell at installation startup.</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true"></a><span class="co">// I fixed it with a ghastly set of options for the boot loader.  Trying the</span></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true"></a><span class="co">// installation with virt-manager also required an unexpected option for</span></span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true"></a><span class="co">// the firmware option in order to get past the EFI shell.</span></span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true"></a></span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true"></a><span class="co">// I set variables for the boot &#39;loader&#39; path and for the &#39;nvram&#39; path, so that</span></span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true"></a><span class="co">// the command below is less intimidating.  The man-page for virt-install </span></span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true"></a><span class="co">// suggests trying this to see all the boot options:</span></span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true"></a><span class="co">//    virt-install --boot=?</span></span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true"></a><span class="fu"># loader=&quot;/usr/share/AAVMF/AAVMF_CODE.fd&quot;</span></span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true"></a><span class="fu"># nvram=&quot;/usr/share/AAVMF/AAVMF_VARS.fd&quot;</span></span>
<span id="cb109-12"><a href="#cb109-12" aria-hidden="true"></a><span class="fu"># virt-install --virt-type kvm --name rocky8 --arch aarch64 \</span></span>
<span id="cb109-13"><a href="#cb109-13" aria-hidden="true"></a><span class="fu"> --ram 1534 \</span></span>
<span id="cb109-14"><a href="#cb109-14" aria-hidden="true"></a><span class="fu"> --boot uefi \</span></span>
<span id="cb109-15"><a href="#cb109-15" aria-hidden="true"></a><span class="fu"> --boot loader=$loader,loader.readonly=yes,loader.type=pflash,nvram=$nvram \</span></span>
<span id="cb109-16"><a href="#cb109-16" aria-hidden="true"></a><span class="fu"> --cdrom /data/kvm/boot-isos/Rocky-8.8-aarch64-minimal.iso \</span></span>
<span id="cb109-17"><a href="#cb109-17" aria-hidden="true"></a><span class="fu"> --network bridge:br0,mac=52:54:00:FF:00:04 \</span></span>
<span id="cb109-18"><a href="#cb109-18" aria-hidden="true"></a><span class="fu"> --nographics \</span></span>
<span id="cb109-19"><a href="#cb109-19" aria-hidden="true"></a><span class="fu"> --accelerate \</span></span>
<span id="cb109-20"><a href="#cb109-20" aria-hidden="true"></a><span class="fu"> --disk path=/data/kvm/clients/rocky8.2.qcow2,size=20</span></span></code></pre></div>
<h1 id="zappendix">Appendix</h1>
<h2 id="find-device">Identifying device names for storage devices</h2>
<p>In a Linux system it is important to correctly identify storage devices, especially when you want to repartition or reformat them. If you pick the wrong device you might wipe out its data.</p>
<p>Start with <em>lsblk</em> to list all current block (storage) devices. Note that a microSD card in a microSD slot will be identified with a name starting with <em>/dev/mmcblk</em>. But if you insert the microSD card into a multi-slot USB-based card reader then the Linux kernel will identify any kind of inserted card in the reader as a generic ‘scsi disk’ type and it will appear with a name which starts with <em>/dev/sd</em>.</p>
<p>Here is an example of a Pi that has 3 storage disks and a USB card reader with 4 slots. The lsblk command also shows active mount points. The 3 disks are:</p>
<ul>
<li>the Pi’s system microSD card (mmcblk0) with 2 partitions mounted as <em>/</em> and <em>/boot/firmware</em></li>
<li>a USB stick (sda) with 1 partition mounted as <em>/usbdata</em></li>
<li>a card reader with 4 slots – 3 slots have 0 bytes, so they are empty (sdb, sdc, sdd) and one of the slots (sde) is occupied by another 256 GB microSD card which is listed with lesser size of 232 GB.</li>
<li>you can use <em>fdisk</em> and <em>parted</em> to look more closely at the sde device:</li>
</ul>
<div class="sourceCode" id="cb110"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true"></a><span class="fu"># lsblk -i </span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true"></a>NAME        MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true"></a>sda           8:0    1 238.5G  0 disk</span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true"></a>`-sda1        8:1    1 238.5G  0 part /usbdata</span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true"></a>sdb           8:16   1     0B  0 disk</span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true"></a>sdc           8:32   1     0B  0 disk</span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true"></a>sdd           8:48   1     0B  0 disk</span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true"></a>sde           8:64   1 231.7G  0 disk</span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true"></a>|-sde1        8:65   1   243M  0 part</span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true"></a>`-sde2        8:66   1   5.9G  0 part</span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true"></a>mmcblk0     179:0    0  59.4G  0 disk</span>
<span id="cb110-12"><a href="#cb110-12" aria-hidden="true"></a>|-mmcblk0p1 179:1    0   243M  0 part /boot/firmware</span>
<span id="cb110-13"><a href="#cb110-13" aria-hidden="true"></a>`-mmcblk0p2 179:2    0  59.2G  0 part /</span>
<span id="cb110-14"><a href="#cb110-14" aria-hidden="true"></a></span>
<span id="cb110-15"><a href="#cb110-15" aria-hidden="true"></a><span class="fu"># fdisk -l /dev/sde</span></span>
<span id="cb110-16"><a href="#cb110-16" aria-hidden="true"></a>Disk /dev/sde: 231.68 GiB, 248765218816 bytes, 485869568 sectors</span>
<span id="cb110-17"><a href="#cb110-17" aria-hidden="true"></a>Disk model: FCR-HS3       -3</span>
<span id="cb110-18"><a href="#cb110-18" aria-hidden="true"></a>...</span>
<span id="cb110-19"><a href="#cb110-19" aria-hidden="true"></a>Disklabel type: dos</span>
<span id="cb110-20"><a href="#cb110-20" aria-hidden="true"></a>Disk identifier: 0x11d94b9e</span>
<span id="cb110-21"><a href="#cb110-21" aria-hidden="true"></a></span>
<span id="cb110-22"><a href="#cb110-22" aria-hidden="true"></a>Device     Boot  Start      End  Sectors  Size Id Type</span>
<span id="cb110-23"><a href="#cb110-23" aria-hidden="true"></a>/dev/sde1  *      2048   499711   497664  243M  c W95 FAT32 (LBA)</span>
<span id="cb110-24"><a href="#cb110-24" aria-hidden="true"></a>/dev/sde2       499712 12969983 12470272  5.9G 83 Linux</span>
<span id="cb110-25"><a href="#cb110-25" aria-hidden="true"></a></span>
<span id="cb110-26"><a href="#cb110-26" aria-hidden="true"></a><span class="fu"># parted /dev/sde print</span></span>
<span id="cb110-27"><a href="#cb110-27" aria-hidden="true"></a>Model:  FCR-HS3 -3 (scsi)</span>
<span id="cb110-28"><a href="#cb110-28" aria-hidden="true"></a>Disk /dev/sde: 249GB</span>
<span id="cb110-29"><a href="#cb110-29" aria-hidden="true"></a>Sector size (logical/physical): 512B/512B</span>
<span id="cb110-30"><a href="#cb110-30" aria-hidden="true"></a>Partition Table: msdos</span>
<span id="cb110-31"><a href="#cb110-31" aria-hidden="true"></a>Disk Flags: </span>
<span id="cb110-32"><a href="#cb110-32" aria-hidden="true"></a></span>
<span id="cb110-33"><a href="#cb110-33" aria-hidden="true"></a>Number  Start   End     Size    Type     File system  Flags</span>
<span id="cb110-34"><a href="#cb110-34" aria-hidden="true"></a> 1      1049kB  256MB   255MB   primary  fat16        boot, lba</span>
<span id="cb110-35"><a href="#cb110-35" aria-hidden="true"></a> 2      256MB   6641MB  6385MB  primary  ext4</span></code></pre></div>
<p>You can pass options to the <em>lsblk</em> command so that you print out columns you are interested in – try <em>lsblk --help</em> to see other options.</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true"></a><span class="fu"># lsblk -i -o &#39;NAME,MODEL,VENDOR,SIZE,MOUNTPOINT,FSTYPE&#39;</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true"></a>NAME        MODEL       VENDOR     SIZE MOUNTPOINT     FSTYPE</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true"></a>sda         Extreme Pro SanDisk  238.5G</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true"></a>`-sda1                           238.5G /usbdata       ext4</span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true"></a>sdb         FCR-HS3 -0               0B</span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true"></a>sdc         FCR-HS3 -1               0B</span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true"></a>sdd         FCR-HS3 -2               0B</span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true"></a>sde         FCR-HS3 -3           231.7G</span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true"></a>|-sde1                             243M                vfat</span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true"></a>`-sde2                             5.9G                ext4</span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true"></a>mmcblk0                           59.4G</span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true"></a>|-mmcblk0p1                        243M /boot/firmware vfat</span>
<span id="cb111-13"><a href="#cb111-13" aria-hidden="true"></a>`-mmcblk0p2                       59.2G /              ext4</span></code></pre></div>
<h2 id="image-cmds">Installation disk creation from the command-line</h2>
<p>This is a generic approach to creating an installation image on removable media; it generally works for various Linux distributions.</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true"></a><span class="co">// create a directory for downloaded images</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true"></a><span class="kw">$ mkdir raspberry-pi-images</span></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true"></a><span class="kw">$ cd raspberry-pi-images</span></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true"></a></span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true"></a><span class="co">// Use wget to pull the compressed image into our directory</span></span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true"></a><span class="co">// (The web page also shows the file checksum so that you can verify</span></span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true"></a><span class="co">//  that the compressed file is not corrupted)</span></span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true"></a><span class="kw">$ serverpath=&quot;https://releases.ubuntu-mate.org/jammy/arm64&quot;</span></span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true"></a><span class="kw">$ compressed=&quot;ubuntu-mate-22.04-desktop-arm64+raspi.img.xz&quot;</span></span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true"></a><span class="kw">$ wget -N -nd $serverpath&quot;/&quot;$compressed</span></span>
<span id="cb112-11"><a href="#cb112-11" aria-hidden="true"></a><span class="kw">$ sha256sum ubuntu-mate-22.04-desktop-arm64+raspi.img.xz</span></span>
<span id="cb112-12"><a href="#cb112-12" aria-hidden="true"></a>3b538f8462cdd957acfbab57f5d949faa607c50c3fb8e6e9d1ad13d5cd6c0c02 ...</span>
<span id="cb112-13"><a href="#cb112-13" aria-hidden="true"></a></span>
<span id="cb112-14"><a href="#cb112-14" aria-hidden="true"></a><span class="co">// uncompress the file so we can write the image file to our microSD.</span></span>
<span id="cb112-15"><a href="#cb112-15" aria-hidden="true"></a><span class="co">// the 1.9 GB compressed file uncompressed to 6.2 GB:</span></span>
<span id="cb112-16"><a href="#cb112-16" aria-hidden="true"></a><span class="kw">$ xz -dv ubuntu-mate-22.04-desktop-arm64+raspi.img.xz </span></span>
<span id="cb112-17"><a href="#cb112-17" aria-hidden="true"></a>ubuntu-mate-22.04-desktop-arm64+raspi.img.xz (1/1)</span>
<span id="cb112-18"><a href="#cb112-18" aria-hidden="true"></a> 5.1 %      95.2 MiB / 404.4 MiB = 0.235    35 MiB/s     0:11   3 min 40 s</span>
<span id="cb112-19"><a href="#cb112-19" aria-hidden="true"></a> ...</span>
<span id="cb112-20"><a href="#cb112-20" aria-hidden="true"></a> 100 %   1,847.8 MiB / 6,333.0 MiB = 0.292  27 MiB/s     3:50             </span></code></pre></div>
<p>Now plug in the microSD card, <a href="#find-device">identify the microSD card device name</a>, and then use the <em>dd</em> command to write the image to it. Safely remove the device when you are done with the <em>eject</em> command. In this example the device name <em>/dev/sdX</em> is not real; it is a place-holder for your real device name:</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true"></a><span class="kw">$ img=&quot;ubuntu-mate-22.04-desktop-arm64+raspi.img&quot;</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true"></a><span class="kw">$ sudo dd if=$img of=/dev/sdX bs=32M conv=fsync status=progress</span></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true"></a><span class="kw">$ sudo eject /dev/sdX</span></span></code></pre></div>
<h2 id="mod-partition">Modify the partitioning of the installation image</h2>
<p>If you modify the microSD’s partitioning <em>before</em> you start the installation then you can reserve a portion of the disk for special data usage - for example as a shared Samba area or an NFS area. We do this by expanding the main Linux partition up to 40 GB, and then we create a third partition.</p>
<p>I show here how to do that from another Linux computer (in my case another Pi) with a USB card reader and an inserted 256 GB microSD card.</p>
<p>There is a good graphical tool named <strong><em>gparted</em></strong> which is easy to use – <em>beginners should certainly use it</em>. It is great when managing a handful of servers (it is a different story if you are managing dozens or thousands of servers).</p>
<p>Here are a few gparted notes:</p>
<ul>
<li>You will need to first install it with <em>sudo apt install gparted</em></li>
<li>If you opt for this tool then it is all you need</li>
<li>It is intuitive, and there are many <a href="https://www.dedoimedo.com/computers/gparted.html#mozTocId133810">tutorials</a> on the web</li>
<li>Be careful to pick the correct disk from the drop-down list</li>
<li>Expand the second partition, then create the third (data) partition</li>
<li>Also use the tool to create an <em>ext4</em> file system on the third partition once you have created it</li>
<li>Once your new server is up and running you can further split your third partition into a fourth partition. You only need to unmount the third partition temporarily and use gparted to create another partition, make a file system on it, and alter /etc/fstab. I did this in order to move my home directory files to the fourth partition.</li>
</ul>
<p>As always, I show the command-line example in this section. As a bonus it shows a common problem of dealing with partition alignment when manually editing partitions. Skip the rest of this section if you have opted for <em>gparted</em>.</p>
<p>Here are some common command-line tools to help us:</p>
<dl>
<dt>lsblk</dt>
<dd>this command will list all block devices
</dd>
<dt>fdisk</dt>
<dd>this interactive text-based command can change disk partitioning
</dd>
<dd>To show all disk and their partitions, do: fdisk -l
</dd>
<dd>You can only operate on one disk
</dd>
<dt>parted</dt>
<dd>this interactive text-based command can also change disk partitioning
</dd>
<dd>You can only operate on one disk
</dd>
<dt>mkfs.ext4</dt>
<dd>You should create an ext4 file system on the new partition
</dd>
</dl>
<p>Here are some utilities used to find disk information:</p>
<ul>
<li><em>lshw -C disk</em></li>
<li><em>hdparm -I /dev/sdX</em> (where X is a block device letter)</li>
<li><em>smartctl -a /dev/sdX</em> (needs <em>smartmontools</em> to be installed)</li>
</ul>
<h3 id="identify-the-main-linux-partition-on-the-microsd">Identify the main Linux partition on the microSD</h3>
<p>First we need to <a href="#find-device">identify the device name</a>, and then we use that device name in the partitioning tool. In my test situation I am using <em>/dev/sde</em> and I am targeting the main Linux (second) partition: <em>/dev/sde2</em>.</p>
<h3 id="expand-the-main-linux-partition-on-the-microsd">Expand the main Linux partition on the microSD</h3>
<p>40 GB is lots of space for future system needs, so I decide to expand the second partition from 6 up to 40 GB.</p>
<p>To be sure this partition is sound I run a check on it with <em>e2fsck</em>. Then I use <em>parted</em> to expand the partition, and then <em>resize2fs</em> which can adjusts the size of the underlying ext4 file system.</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true"></a><span class="co">// run a file system check on the target partition:</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true"></a><span class="kw">$ sudo e2fsck /dev/sde2</span></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true"></a>e2fsck 1.46.5 (30-Dec-2021)</span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true"></a>writable: clean, 224088/390144 files, 1485804/1558784 blocks</span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true"></a></span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true"></a><span class="co">// invoke the partitioning tool *parted*, print the partition table</span></span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true"></a><span class="co">// for reference, and then resize the second partition:</span></span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true"></a><span class="kw">$ sudo parted /dev/sde</span></span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true"></a>...</span>
<span id="cb114-10"><a href="#cb114-10" aria-hidden="true"></a>(parted) print                                                            </span>
<span id="cb114-11"><a href="#cb114-11" aria-hidden="true"></a>...</span>
<span id="cb114-12"><a href="#cb114-12" aria-hidden="true"></a>Number  Start   End     Size    Type     File system  Flags</span>
<span id="cb114-13"><a href="#cb114-13" aria-hidden="true"></a> 1      1049kB  256MB   255MB   primary  fat16        boot, lba</span>
<span id="cb114-14"><a href="#cb114-14" aria-hidden="true"></a> 2      256MB   6641MB  6385MB  primary  ext4</span>
<span id="cb114-15"><a href="#cb114-15" aria-hidden="true"></a></span>
<span id="cb114-16"><a href="#cb114-16" aria-hidden="true"></a>(parted) resizepart</span>
<span id="cb114-17"><a href="#cb114-17" aria-hidden="true"></a>Partition number? 2                                                       </span>
<span id="cb114-18"><a href="#cb114-18" aria-hidden="true"></a>End?  [6641MB]? 40G                                                       </span>
<span id="cb114-19"><a href="#cb114-19" aria-hidden="true"></a></span>
<span id="cb114-20"><a href="#cb114-20" aria-hidden="true"></a>(parted) print                                                            </span>
<span id="cb114-21"><a href="#cb114-21" aria-hidden="true"></a>...</span>
<span id="cb114-22"><a href="#cb114-22" aria-hidden="true"></a>Number  Start   End     Size    Type     File system  Flags</span>
<span id="cb114-23"><a href="#cb114-23" aria-hidden="true"></a> 1      1049kB  256MB   255MB   primary  fat16        boot, lba</span>
<span id="cb114-24"><a href="#cb114-24" aria-hidden="true"></a> 2      256MB   40.0GB  39.7GB  primary  ext4</span>
<span id="cb114-25"><a href="#cb114-25" aria-hidden="true"></a></span>
<span id="cb114-26"><a href="#cb114-26" aria-hidden="true"></a>(parted) quit</span>
<span id="cb114-27"><a href="#cb114-27" aria-hidden="true"></a></span>
<span id="cb114-28"><a href="#cb114-28" aria-hidden="true"></a><span class="co">// Now expand the underlying file system to the end of the partition</span></span>
<span id="cb114-29"><a href="#cb114-29" aria-hidden="true"></a><span class="kw">$ sudo resize2fs /dev/sde2</span></span>
<span id="cb114-30"><a href="#cb114-30" aria-hidden="true"></a>resize2fs 1.46.5 (30-Dec-2021)</span>
<span id="cb114-31"><a href="#cb114-31" aria-hidden="true"></a>Resizing the filesystem on /dev/sde2 to 9703161 (4k) blocks.</span>
<span id="cb114-32"><a href="#cb114-32" aria-hidden="true"></a>The filesystem on /dev/sde2 is now 9703161 (4k) blocks long.</span></code></pre></div>
<h3 id="create-a-new-data-partition">Create a new data partition</h3>
<p>Now we want to create a third large partition. We run into the problem of partition alignment because I chose 40 GB for the second partition expansion without considering alignment for the next partition.</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true"></a><span class="co">// invoke *parted* and print the partition table in sector units:</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true"></a><span class="kw">$ sudo parted /dev/sde</span></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true"></a>...</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true"></a>(parted) unit s print</span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true"></a>Model:  FCR-HS3 -3 (scsi)</span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true"></a>Disk /dev/sde: 485869568s</span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true"></a>Sector size (logical/physical): 512B/512B</span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true"></a>Partition Table: msdos</span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true"></a>Disk Flags: </span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true"></a></span>
<span id="cb115-11"><a href="#cb115-11" aria-hidden="true"></a>Number  Start    End        Size       Type     File system  Flags</span>
<span id="cb115-12"><a href="#cb115-12" aria-hidden="true"></a> 1      2048s    499711s    497664s    primary  fat16        boot, lba</span>
<span id="cb115-13"><a href="#cb115-13" aria-hidden="true"></a> 2      499712s  78125000s  77625289s  primary  ext4</span>
<span id="cb115-14"><a href="#cb115-14" aria-hidden="true"></a></span>
<span id="cb115-15"><a href="#cb115-15" aria-hidden="true"></a><span class="co">// the &#39;End&#39; of the second partition is at 78125000 sectors, so I increment</span></span>
<span id="cb115-16"><a href="#cb115-16" aria-hidden="true"></a><span class="co">// that number and try to create the third partition up to 100% of the disk</span></span>
<span id="cb115-17"><a href="#cb115-17" aria-hidden="true"></a><span class="co">// There is a warning about partition alignment, so I cancel that operation</span></span>
<span id="cb115-18"><a href="#cb115-18" aria-hidden="true"></a>(parted) mkpart primary ext4 78125001 100%</span>
<span id="cb115-19"><a href="#cb115-19" aria-hidden="true"></a>Warning: The resulting partition is not properly aligned for best performance:</span>
<span id="cb115-20"><a href="#cb115-20" aria-hidden="true"></a>78125001s % 2048s != 0s</span>
<span id="cb115-21"><a href="#cb115-21" aria-hidden="true"></a>Ignore/Cancel? c</span></code></pre></div>
<p>Disk technology has evolved considerably. Block devices traditionally had a default 512 byte sector size (a sector is the minimum usable unit), but newer disks may have a 4096 (4k) sector size. In order to work efficiently with different sector sizes on various disk technologies a good starting point is at sector 2048. This is at 1 mebibyte (MiB), or 1048576 bytes into the disk, since 512 bytes * 2048 sectors is 1048576 bytes. You lose a bit of disk space at the ‘front’ of the disk, but partitioning and file system data structures are better aligned, and disk performance is enhanced.</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true"></a><span class="co">// To calculate the best starting sector number for an aligned new</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true"></a><span class="co">//  partition simply calculate: </span></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true"></a><span class="co">//  TRUNCATE(FIRST_POSSIBLE_SECTOR / 2048) * 2048 + 2048</span></span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true"></a><span class="co">//  thus: 78125001 / 2048 = 38146.973144</span></span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true"></a><span class="co">//        TRUNCATE(38146.973144) = 38146</span></span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true"></a><span class="co">//        (38146 * 2048) + 2048  = 78125056</span></span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true"></a></span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true"></a>(parted) mkpart primary ext4 78125056 100%</span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true"></a>(parted) print unit s </span>
<span id="cb116-10"><a href="#cb116-10" aria-hidden="true"></a>...</span>
<span id="cb116-11"><a href="#cb116-11" aria-hidden="true"></a>Number  Start   End     Size    Type     File system  Flags</span>
<span id="cb116-12"><a href="#cb116-12" aria-hidden="true"></a> 1      1049kB  256MB   255MB   primary  fat16        boot, lba</span>
<span id="cb116-13"><a href="#cb116-13" aria-hidden="true"></a> 2      256MB   40.0GB  39.7GB  primary  ext4</span>
<span id="cb116-14"><a href="#cb116-14" aria-hidden="true"></a> 3      40.0GB  249GB   209GB   primary</span>
<span id="cb116-15"><a href="#cb116-15" aria-hidden="true"></a>(parted) align-check optimal 3                                            </span>
<span id="cb116-16"><a href="#cb116-16" aria-hidden="true"></a>3 aligned</span>
<span id="cb116-17"><a href="#cb116-17" aria-hidden="true"></a></span>
<span id="cb116-18"><a href="#cb116-18" aria-hidden="true"></a>(parted) unit s print free</span>
<span id="cb116-19"><a href="#cb116-19" aria-hidden="true"></a>...</span>
<span id="cb116-20"><a href="#cb116-20" aria-hidden="true"></a>Number  Start      End         Size        Type     File system  Flags</span>
<span id="cb116-21"><a href="#cb116-21" aria-hidden="true"></a>        32s        2047s       2016s                Free Space</span>
<span id="cb116-22"><a href="#cb116-22" aria-hidden="true"></a> 1      2048s      499711s     497664s     primary  fat16        boot, lba</span>
<span id="cb116-23"><a href="#cb116-23" aria-hidden="true"></a> 2      499712s    78125000s   77625289s   primary  ext4</span>
<span id="cb116-24"><a href="#cb116-24" aria-hidden="true"></a>        78125001s  78125055s   55s                  Free Space</span>
<span id="cb116-25"><a href="#cb116-25" aria-hidden="true"></a> 3      78125056s  485869567s  407744512s  primary</span>
<span id="cb116-26"><a href="#cb116-26" aria-hidden="true"></a></span>
<span id="cb116-27"><a href="#cb116-27" aria-hidden="true"></a>(parted) quit</span></code></pre></div>
<p>Though we have now a bit of wasted space between partition 2 and 3, we can extend partition 2 to use that space. We need to resize its ext4 file system after:</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true"></a><span class="co">// first check the file system:</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true"></a><span class="kw">$ sudo e2fsck /dev/sde2</span></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true"></a>e2fsck 1.46.5 (30-Dec-2021)</span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true"></a>writable: clean, 224088/2414016 files, 1615846/9703161 blocks</span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true"></a></span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true"></a><span class="kw">$ sudo parted /dev/sde</span></span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true"></a>...</span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true"></a>(parted) unit s print free</span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true"></a>...</span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true"></a>Number  Start      End         Size        Type     File system  Flags</span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true"></a>        32s        2047s       2016s                Free Space</span>
<span id="cb117-12"><a href="#cb117-12" aria-hidden="true"></a> 1      2048s      499711s     497664s     primary  fat16        boot, lba</span>
<span id="cb117-13"><a href="#cb117-13" aria-hidden="true"></a> 2      499712s    78125000s   77625289s   primary  ext4</span>
<span id="cb117-14"><a href="#cb117-14" aria-hidden="true"></a>        78125001s  78125055s   55s                  Free Space</span>
<span id="cb117-15"><a href="#cb117-15" aria-hidden="true"></a> 3      78125056s  485869567s  407744512s  primary</span>
<span id="cb117-16"><a href="#cb117-16" aria-hidden="true"></a></span>
<span id="cb117-17"><a href="#cb117-17" aria-hidden="true"></a>(parted) resizepart</span>
<span id="cb117-18"><a href="#cb117-18" aria-hidden="true"></a>Partition number? 2                                                       </span>
<span id="cb117-19"><a href="#cb117-19" aria-hidden="true"></a>End?  [78125000s]? 78125055s                                              </span>
<span id="cb117-20"><a href="#cb117-20" aria-hidden="true"></a>(parted) print free</span>
<span id="cb117-21"><a href="#cb117-21" aria-hidden="true"></a>...</span>
<span id="cb117-22"><a href="#cb117-22" aria-hidden="true"></a>Number  Start      End         Size        Type     File system  Flags</span>
<span id="cb117-23"><a href="#cb117-23" aria-hidden="true"></a>        32s        2047s       2016s                Free Space</span>
<span id="cb117-24"><a href="#cb117-24" aria-hidden="true"></a> 1      2048s      499711s     497664s     primary  fat16        boot, lba</span>
<span id="cb117-25"><a href="#cb117-25" aria-hidden="true"></a> 2      499712s    78125055s   77625344s   primary  ext4</span>
<span id="cb117-26"><a href="#cb117-26" aria-hidden="true"></a> 3      78125056s  485869567s  407744512s  primary</span>
<span id="cb117-27"><a href="#cb117-27" aria-hidden="true"></a></span>
<span id="cb117-28"><a href="#cb117-28" aria-hidden="true"></a>(parted) quit                                                             </span>
<span id="cb117-29"><a href="#cb117-29" aria-hidden="true"></a>Information: You may need to update /etc/fstab.</span>
<span id="cb117-30"><a href="#cb117-30" aria-hidden="true"></a></span>
<span id="cb117-31"><a href="#cb117-31" aria-hidden="true"></a><span class="kw">$ sudo resize2fs /dev/sde2</span></span>
<span id="cb117-32"><a href="#cb117-32" aria-hidden="true"></a>resize2fs 1.46.5 (30-Dec-2021)</span>
<span id="cb117-33"><a href="#cb117-33" aria-hidden="true"></a>Resizing the filesystem on /dev/sde2 to 9703168 (4k) blocks.</span>
<span id="cb117-34"><a href="#cb117-34" aria-hidden="true"></a>The filesystem on /dev/sde2 is now 9703168 (4k) blocks long.</span></code></pre></div>
<h3 id="create-a-file-system-on-the-new-data-partition">Create a file system on the new data partition</h3>
<p>Ubuntu uses the <em>ext4</em> file system, so let’s create that file system on the new data partition:</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true"></a><span class="kw">$ sudo mkfs.ext4 /dev/sde3</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true"></a>mke2fs 1.46.5 (30-Dec-2021)</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true"></a>Creating filesystem with 50968064 4k blocks and 12746752 inodes</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true"></a>Filesystem UUID: 2dba1eef-34e4-47ed-90fc-c1938d5fa9e0</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true"></a>Superblock backups stored on blocks: </span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true"></a>    32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208, </span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true"></a>    4096000, 7962624, 11239424, 20480000, 23887872</span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true"></a></span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true"></a>Allocating group tables: done                            </span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true"></a>Writing inode tables: done                            </span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true"></a>Creating journal (262144 blocks): done</span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true"></a>Writing superblocks and filesystem accounting information: done</span></code></pre></div>
<p>By default, the generations of the <a href="https://en.wikipedia.org/wiki/Extended_file_system"><em>ext</em> file systems</a> reserve 5% of the available space for the <em>root</em> user. On a data partition where most files created will belong to ordinary users this reservation is not necessary. 5% of 200 GB is 10 GB - that is a lot of space. So it is a good idea to reduce the percentage to 1%; do this with the <em>tune2fs</em> utility:</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true"></a><span class="kw">$ sudo tune2fs -l /dev/sde3 | grep -i count</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true"></a>...</span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true"></a>Reserved block count:     2548403</span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true"></a></span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true"></a><span class="kw">$ sudo tune2fs -m 1 /dev/sde3</span></span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true"></a>tune2fs 1.46.5 (30-Dec-2021)</span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true"></a>Setting reserved blocks percentage to 1% (509680 blocks)</span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true"></a></span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true"></a><span class="kw">$ sudo tune2fs -l /dev/sde3 | grep -i count</span></span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true"></a>...</span>
<span id="cb119-11"><a href="#cb119-11" aria-hidden="true"></a>Reserved block count:     509680</span></code></pre></div>
<p>Lastly, let’s add a <em>label</em> to this partition to make it easier to mount the file system in the future. We will use the label <em>PI-DATA</em>:</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true"></a><span class="kw">$ sudo tune2fs -L PI-DATA /dev/sde3</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true"></a>tune2fs 1.46.5 (30-Dec-2021)</span></code></pre></div>
<h2 id="data-area">Setting up a data area</h2>
<p>If you did not <a href="#mod-partition">modify the initial partitioning</a> of your microSD card then you will simply make a directory in the root of your file system where we will store any data associated with a Samba service or with an NFS service – that is all.</p>
<p>In case you did make a data partition on the microSD card then we <em>still</em> need to make a directory in the root of the file system to mount that data partition:</p>
<p>Let’s call the directory <em>/data</em>:</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true"></a><span class="kw">$ sudo mkdir /data</span></span></code></pre></div>
<p>For the case with the third (data) partition then we need to mount it and make the mount action permanent on reboots. For this we create an entry in the file system table, the <em>/etc/fstab</em> file:</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true"></a><span class="co">// make a backup copy first</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true"></a><span class="kw">$ sudo cp -p /etc/fstab /etc/fstab.orig</span></span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true"></a></span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true"></a><span class="co">// There are 6 fields in an fstab entry:</span></span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true"></a><span class="co">//    1. the partition name, the partition label or the partition uuid</span></span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true"></a><span class="co">//    2. the directory to use for the mount point</span></span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true"></a><span class="co">//    3. the file system type</span></span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true"></a><span class="co">//    4. any mount options recognized by the mount command</span></span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true"></a><span class="co">//    5. use a zero here, it is a legacy option for the &#39;dump&#39; command</span></span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true"></a><span class="co">//    6. the file system check ordering, use &#39;2&#39; here</span></span>
<span id="cb122-11"><a href="#cb122-11" aria-hidden="true"></a></span>
<span id="cb122-12"><a href="#cb122-12" aria-hidden="true"></a><span class="co">// Edit the file, adding a mount entry line to the end of the file;</span></span>
<span id="cb122-13"><a href="#cb122-13" aria-hidden="true"></a><span class="co">// recall that we added the label &#39;PI-DATA&#39; to its file system:</span></span>
<span id="cb122-14"><a href="#cb122-14" aria-hidden="true"></a><span class="kw">$ sudo nano /etc/fstab</span></span>
<span id="cb122-15"><a href="#cb122-15" aria-hidden="true"></a><span class="kw">$ tail -2 /etc/fstab</span></span>
<span id="cb122-16"><a href="#cb122-16" aria-hidden="true"></a>LABEL=PI-DATA       /data           ext4    defaults  0  2</span>
<span id="cb122-17"><a href="#cb122-17" aria-hidden="true"></a></span>
<span id="cb122-18"><a href="#cb122-18" aria-hidden="true"></a><span class="kw">$ sudo mount /data</span></span>
<span id="cb122-19"><a href="#cb122-19" aria-hidden="true"></a><span class="kw">$ ls -la /data</span></span>
<span id="cb122-20"><a href="#cb122-20" aria-hidden="true"></a>total 24</span>
<span id="cb122-21"><a href="#cb122-21" aria-hidden="true"></a>drwxr-xr-x  3 root root  4096 Apr 16 10:35 .</span>
<span id="cb122-22"><a href="#cb122-22" aria-hidden="true"></a>drwxr-xr-x 20 root root  4096 Apr 16 14:30 ..</span>
<span id="cb122-23"><a href="#cb122-23" aria-hidden="true"></a>drwx------  2 root root 16384 Apr 16 10:35 lost+found</span>
<span id="cb122-24"><a href="#cb122-24" aria-hidden="true"></a></span>
<span id="cb122-25"><a href="#cb122-25" aria-hidden="true"></a><span class="kw">$ df -h /data</span></span>
<span id="cb122-26"><a href="#cb122-26" aria-hidden="true"></a>Filesystem      Size  Used Avail Use% Mounted on</span>
<span id="cb122-27"><a href="#cb122-27" aria-hidden="true"></a>/dev/sde3       191G   28K  189G   1% /data</span></code></pre></div>
<h2 id="eg-cmds">Some command-line utilities and their purpose</h2>
<table>
<colgroup>
<col style="width: 26%" />
<col style="width: 73%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Command</th>
<th style="text-align: left;">Purpose</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">whoami</td>
<td style="text-align: left;">Shows your login name</td>
</tr>
<tr class="even">
<td style="text-align: left;">id</td>
<td style="text-align: left;">Shows your UID and GID numbers and all of your group memberships</td>
</tr>
<tr class="odd">
<td style="text-align: left;">pwd</td>
<td style="text-align: left;">Shows your current working directory</td>
</tr>
<tr class="even">
<td style="text-align: left;">ls</td>
<td style="text-align: left;">Shows a listing of your current directory</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ls -l</td>
<td style="text-align: left;">Shows a detailed listing of your current directory</td>
</tr>
<tr class="even">
<td style="text-align: left;">ls /</td>
<td style="text-align: left;">Shows a listing of the base of the file system</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ls /root</td>
<td style="text-align: left;">Try to show a listing of the super-user’s protected home directory</td>
</tr>
<tr class="even">
<td style="text-align: left;">sudo ls /root</td>
<td style="text-align: left;">‘sudo’ allows you to be root temporarily. It will ask for your password</td>
</tr>
<tr class="odd">
<td style="text-align: left;">man sudo</td>
<td style="text-align: left;">Shows the manual page for the sudo command (type q to quit)</td>
</tr>
<tr class="even">
<td style="text-align: left;">date</td>
<td style="text-align: left;">Shows the current date and time</td>
</tr>
<tr class="odd">
<td style="text-align: left;">cat /etc/lsb-release</td>
<td style="text-align: left;">Shows the contents of this file</td>
</tr>
<tr class="even">
<td style="text-align: left;">uptime</td>
<td style="text-align: left;">Shows how long this computer has been up</td>
</tr>
<tr class="odd">
<td style="text-align: left;">cd /tmp</td>
<td style="text-align: left;">Change directories to the ‘tmp’ directory</td>
</tr>
<tr class="even">
<td style="text-align: left;">touch example</td>
<td style="text-align: left;">Creates a new (and empty) file named ‘example’</td>
</tr>
<tr class="odd">
<td style="text-align: left;">rm -i example</td>
<td style="text-align: left;">Removes the file named ‘example’ if you respond with: y</td>
</tr>
<tr class="even">
<td style="text-align: left;">mkdir thisdir</td>
<td style="text-align: left;">Creates a new directory named ‘thisdir’</td>
</tr>
<tr class="odd">
<td style="text-align: left;">mkdir --help</td>
<td style="text-align: left;">Shows help on using the mkdir command</td>
</tr>
<tr class="even">
<td style="text-align: left;">rmdir thisdir</td>
<td style="text-align: left;">Removes the directory named ‘thisdir’</td>
</tr>
<tr class="odd">
<td style="text-align: left;">cd</td>
<td style="text-align: left;">Without an argument, it takes you back to your home</td>
</tr>
<tr class="even">
<td style="text-align: left;">file .bash*</td>
<td style="text-align: left;">Shows what kind of files whose names start with ‘.bash’</td>
</tr>
<tr class="odd">
<td style="text-align: left;">echo $SHELL</td>
<td style="text-align: left;">Shows what shell you use</td>
</tr>
<tr class="even">
<td style="text-align: left;">env | sort | less</td>
<td style="text-align: left;">Shows your environment variables, sorted by name (q to quit)</td>
</tr>
</tbody>
</table>
<p>The last example in the above list:</p>
<p>env|sort|less</p>
<p>is actually 3 different commands <em>piped</em> together: - env - output the environment variables in your shell - sort - sort the incoming text, by default alphabetically - less - show the output a page at a time</p>
<p>A pipe, represented by a vertical line, sends the output from one command as the input for the next command. It is a hallmark of the UNIX way of doing things - create small programs that do one thing well, and string the commands together to accomplish a larger task.</p>
<h2 id="mate-exercise">A MATE configuration exercise</h2>
<p>Here are a series of exercises you can try on a fresh installation of the MATE desktop. By default, the initial mate configuration has 2 panels (taskbars):</p>
<ul>
<li>the top panel has:
<ul>
<li>a global menu button on the left</li>
<li>on the right is a group of icons that represent the state of things, known as ‘Indicator Applet Complete’</li>
</ul></li>
<li>the bottom panel has:
<ul>
<li>on the left: a ‘show desktop’ button</li>
<li>on the left: a window list area, where current open windows as shown</li>
<li>on the right: a workspace area with 4 workspaces</li>
<li>on the right: a trash can button</li>
</ul></li>
</ul>
<p>You may like this setup; but here is a small exercise to give you a quick start in making modifications.</p>
<h3 id="modify-the-top-panel">Modify the top panel</h3>
<ol type="1">
<li>Get rid of the bottom panel:
<ul>
<li>Right click on it and selecting ‘Delete This Panel’. We will add some of its contents to the top panel.</li>
</ul></li>
<li>On the top panel try a different menu presentation:
<ul>
<li>Right-click over the menu button on the top panel, and unlock its status. Then right-click and select ‘Remove from Panel’.</li>
<li>Now right-click and select ‘Add to Panel’. A list of applets mostly in alphabetical order will appear in a new window. Select ‘Classic Menu’ (or the ‘Compact Menu’) and click on ‘Add’ and it will appear on the panel. Right-click on it and move it completely to the left. Then right-click on it again and select ‘Lock to Panel’. Leave the ‘Add to Panel’ window on your screen to continue adding applets.</li>
</ul></li>
<li>Add a couple of separators:
<ul>
<li>Scroll down to find ‘Separator’ and add it to the panel. Then right-click on it, move it against the menu, and lock it to the panel. (Locked items cannot be accidentally moved; it is a mystery why it does not always prevent deletion of some applet buttons…)</li>
<li>Add another separator, and move it about an inch to the right of the first separator and lock it.</li>
</ul></li>
<li>Add an active-window list:
<ul>
<li>Scroll down to find ‘Window Selector’ and add it to the panel to the right of the second separator. It is a bit tricky to select it to lock it. Right-click just to the right of the second separator line. If you see ‘System Monitor’ at the top of the menu list then lock it to the panel. Right click on it again and select ‘Preferences’. In the ‘Window Grouping’ options select ‘Group windows when space is limited’ and then close that window.</li>
</ul></li>
<li>Add a workspace switcher:
<ul>
<li>scroll down to find ‘Workspace Switcher’ and add it to the panel. Then right-click on it and select ‘Preferences’. Reduce the number of workspaces to 2, and name them - for example rename one to ‘Home’ and the other to ‘Projects’.</li>
<li>Now right-click and move it as far right as you can, and lock it.</li>
</ul></li>
<li>Finally add a few of your own ‘Launchers’:
<ul>
<li>Add a firefox button:
<ul>
<li>right-click between the 2 separators and add to the panel: ‘Application Launcher’. That will bring up a further selection. Click on Internet, then ‘Firefox Web Browser’ and add it. Again, right-click on the firefox button and move it to the left and lock it.</li>
</ul></li>
<li>Add a terminal button:
<ul>
<li>right-click between the 2 separators and add to the panel: ‘MATE Terminal’ and again move and lock it.</li>
</ul></li>
</ul></li>
</ol>
<!--
I add some custom application launchers related to the use of secure
shell as well.  If you are interested look at the secure shell example
further in the appendix.
-->
<h3 id="other-changes-done-from-the-control-centre">Other changes done from the control centre</h3>
<ol type="1">
<li>Find the Control Center in the System Menu.</li>
<li>Under the ‘Look and Feel’ section select ‘Screensaver’:
<ul>
<li>Change the theme to something else, for example: ‘Cosmos’.</li>
<li>Disable the ‘lock screen’ option if you wish.</li>
</ul></li>
<li>Under the ‘Look and Feel’ section select ‘Windows’:
<ul>
<li>Change the ‘Titlebar Action’ to ‘Roll up’</li>
</ul></li>
<li>Under the ‘Look and Feel’ section select ‘Appearance’:
<ul>
<li>Try different themes</li>
<li>Try different backgrounds</li>
</ul></li>
<li>Under the ‘Personal’ section select ‘Startup Applications’:
<ul>
<li>Disable ‘Blueman Applet’ and ‘Power Manager’</li>
<li>Select ‘Show hidden’ and look at what is lurking underneath, disable things that clearly are not important to you.</li>
</ul></li>
</ol>
<h3 id="here-are-a-few-notes-about-window-actions">Here are a few notes about window actions:</h3>
<p>The ‘Maximize Window’ button (between the ‘Minimize Window’ button and the ‘Close Window’ on the right of each window) has difference actions depending on which mouse-click you use:</p>
<ul>
<li>a right-mouse-button-click over the maximize button maximizes the window horizontally. Another right-mouse-button-click will return it to the previous size.</li>
<li>a middle-mouse-button-click over the maximize button maximizes the window vertically. Another middle-mouse-button-click will return it to the previous size.</li>
<li>a left-mouse-button-click over the maximize button maximizes the window completely. Another left-mouse-button-click will return it to the previous size.</li>
</ul>
<h2 id="backups">An example process and script for backups</h2>
<p>There are many ways to do backups - this is one example.<br />
An <a href="https://github.com/deatrich/tools/blob/main/system-backup.sh">example script</a> in my github ‘tools’ area can do local system backups; it can also do external backups to a removable drive, such as an attached USB drive. If you do only local backups without creating a copy elsewhere then you run the risk of losing your data because of a major failure (like losing or overwriting the local disk) when you don’t have another copy.</p>
<p>As well the script can handle large directories by using <em>rsync</em> to copy them them to a removable drive. Though ‘rsync’ is typically used for remote copies it can also be used locally.</p>
<p>The script also allows you to keep an additional copy of your large directories on the removable drive.</p>
<p>The example script requires a few configuration entries into a file named <a href="https://github.com/deatrich/tools/blob/main/etc/system-backup.conf"><em>/etc/system-backup.conf</em></a>. You need a designated local directory; the files will be compressed so it requires only a few hundred megabytes per day for each day of the week. The provided example script also keeps the last week of each month for one year. If you use the external backup feature and/or the large directory backup feature then you simply need to provide the partition on the drive to use for backups, as well as the mounted name of the directories where the files will be copied.</p>
<p>In order to automate your backup script, you also need to create a <em>cronjob</em> which will automatically run your script in the time slot you pick. In the example below you:</p>
<pre><code>* create the needed local directories specified in /etc/system-backup.conf
* edit the configuration file if you choose different directory names
* copy the configuration file and the script into place
* run the script in test mode to check configuration correctness
* create/edit the cronjob to run the local backup at 1 in the early morning</code></pre>
<div class="sourceCode" id="cb124"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true"></a><span class="co">// Create local directory with permissions limiting access to</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true"></a><span class="co">// backed-up files to users in the &#39;adm&#39; group:</span></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true"></a><span class="kw">$ sudo mkdir /var/local-backups</span></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true"></a><span class="kw">$ sudo chown root:adm /var/local-backups</span></span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true"></a><span class="kw">$ sudo mkdir /var/log/local-backups</span></span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true"></a><span class="kw">$ sudo chown root:adm /var/local-backups</span></span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true"></a></span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true"></a><span class="co">// Protect the backup directory by removing permissions for others:</span></span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true"></a><span class="kw">$ sudo chmod o-rwx /var/local-backups</span></span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true"></a></span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true"></a><span class="co">// Copy the configuration file to /etc/ and the shell script to /root/bin/</span></span>
<span id="cb124-12"><a href="#cb124-12" aria-hidden="true"></a><span class="kw">$ sudo cp /path/to/system-backup.conf /etc</span></span>
<span id="cb124-13"><a href="#cb124-13" aria-hidden="true"></a><span class="kw">$ sudo mkdir /root/bin</span></span>
<span id="cb124-14"><a href="#cb124-14" aria-hidden="true"></a><span class="kw">$ sudo cp /path/to/system-backup.sh /root/bin/</span></span>
<span id="cb124-15"><a href="#cb124-15" aria-hidden="true"></a><span class="co">// The script must be marked as &#39;executable&#39;; the chmod command will do that:</span></span>
<span id="cb124-16"><a href="#cb124-16" aria-hidden="true"></a><span class="kw">$ sudo chmod 755 /root/bin/system-backup.sh</span></span>
<span id="cb124-17"><a href="#cb124-17" aria-hidden="true"></a></span>
<span id="cb124-18"><a href="#cb124-18" aria-hidden="true"></a><span class="co">// Edit the configuration file for the backups:</span></span>
<span id="cb124-19"><a href="#cb124-19" aria-hidden="true"></a><span class="kw">$ sudo nano /etc/system-backup.conf</span></span>
<span id="cb124-20"><a href="#cb124-20" aria-hidden="true"></a></span>
<span id="cb124-21"><a href="#cb124-21" aria-hidden="true"></a><span class="co">// Run the script in debug mode from the command line to make sure</span></span>
<span id="cb124-22"><a href="#cb124-22" aria-hidden="true"></a><span class="co">// that everything is correctly configured:</span></span>
<span id="cb124-23"><a href="#cb124-23" aria-hidden="true"></a><span class="kw">$ sudo /root/bin/system-backup.sh --test --local</span></span>
<span id="cb124-24"><a href="#cb124-24" aria-hidden="true"></a></span>
<span id="cb124-25"><a href="#cb124-25" aria-hidden="true"></a><span class="co">// Create and edit the cronjob -- this example would run at 01:00 hrs</span></span>
<span id="cb124-26"><a href="#cb124-26" aria-hidden="true"></a><span class="kw">$ EDITOR=/bin/nano sudo crontab -e</span></span>
<span id="cb124-27"><a href="#cb124-27" aria-hidden="true"></a></span>
<span id="cb124-28"><a href="#cb124-28" aria-hidden="true"></a><span class="co">// ( On Ubuntu &#39;crontab&#39; puts cron-job files in /var/spool/cron/crontabs/ )</span></span>
<span id="cb124-29"><a href="#cb124-29" aria-hidden="true"></a><span class="co">// Ask &#39;crontab&#39; to list what that job is:</span></span>
<span id="cb124-30"><a href="#cb124-30" aria-hidden="true"></a><span class="kw">$ sudo crontab -l | tail -3</span></span>
<span id="cb124-31"><a href="#cb124-31" aria-hidden="true"></a></span>
<span id="cb124-32"><a href="#cb124-32" aria-hidden="true"></a>0 1 * * * /root/bin/system-backup.sh --local</span></code></pre></div>
<p>If you will also synchronize backups to a USB drive, then you must make directories at the root of the USB file system for backups. The USB partition name and the names of the directories must match the configuration file setup. (example: your USB partition is /dev/sda1 and so you have set ‘usbpartition’ in the configuration file to ‘sda1’)</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true"></a><span class="co">// Here we also prepare for doing large directory rsyncs as well:</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true"></a><span class="kw">$ sudo mount /dev/sda1 /mnt</span></span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true"></a><span class="kw">$ cd /mnt</span></span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true"></a><span class="kw">$ sudo mkdir backups rsyncs</span></span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true"></a><span class="kw">$ sudo mkdir rsyncs/copy</span></span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true"></a></span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true"></a><span class="co">// Be sure to unmount the drive</span></span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true"></a><span class="kw">$ cd</span></span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true"></a><span class="kw">$ sudo umount /mnt</span></span>
<span id="cb125-10"><a href="#cb125-10" aria-hidden="true"></a></span>
<span id="cb125-11"><a href="#cb125-11" aria-hidden="true"></a><span class="co">// Run the script in debug mode from the command line to make sure</span></span>
<span id="cb125-12"><a href="#cb125-12" aria-hidden="true"></a><span class="co">// that everything is correctly configured for external copies of your</span></span>
<span id="cb125-13"><a href="#cb125-13" aria-hidden="true"></a><span class="co">// local backups (that is, the ones in /var/local-backups/):</span></span>
<span id="cb125-14"><a href="#cb125-14" aria-hidden="true"></a><span class="kw">$ sudo /root/bin/system-backup.sh --test --external</span></span>
<span id="cb125-15"><a href="#cb125-15" aria-hidden="true"></a></span>
<span id="cb125-16"><a href="#cb125-16" aria-hidden="true"></a><span class="co">// If you will also do large directory backups then test that option</span></span>
<span id="cb125-17"><a href="#cb125-17" aria-hidden="true"></a><span class="co">// as well.  You must have set &#39;largedirs&#39; in the configuration file:</span></span>
<span id="cb125-18"><a href="#cb125-18" aria-hidden="true"></a><span class="kw">$ sudo /root/bin/system-backup.sh --test --rsync-large</span></span>
<span id="cb125-19"><a href="#cb125-19" aria-hidden="true"></a></span>
<span id="cb125-20"><a href="#cb125-20" aria-hidden="true"></a><span class="co">// Finally edit the cronjob and add the external backup options to the command:</span></span>
<span id="cb125-21"><a href="#cb125-21" aria-hidden="true"></a><span class="kw">$ EDITOR=/bin/nano sudo crontab -e</span></span>
<span id="cb125-22"><a href="#cb125-22" aria-hidden="true"></a><span class="kw">$ sudo crontab -l | tail -3</span></span>
<span id="cb125-23"><a href="#cb125-23" aria-hidden="true"></a></span>
<span id="cb125-24"><a href="#cb125-24" aria-hidden="true"></a>0 1 * * * /root/bin/system-backup.sh --local --external --rsync-large</span></code></pre></div>
<p>In case your USB drive is formatted for Windows then it should be okay for all backups except for the large directories backup; that is, with the option ‘–rsync-large’.</p>
<p>The script might issue some warnings about trying to preserve LINUX permissions on the USB drive, but should otherwise work. I need to verify this case. You may have to change the rsync arguments in the script from <em>-aux</em> to <em>-rltux</em>. I need to test the Windows-formatted usb drive option!!.</p>
<p>If you ever need to restore files from your backups then you should unpack the <em>tar file</em> (compressed ‘tar’ files are sometimes called <em>tarballs</em>) on a Linux system and copy the needed files into place on the file system.</p>
<h2 id="lan">LAN (Local Area Network) configuration</h2>
<h3 id="common-network-related-files">Common network-related files</h3>
<p>There are some common networking files that are interesting to configure especially if you have more than one Linux computer on your home network. They are useful on your home Linux server as well, since it clarifies some configuration settings for some future services you might like to enable, for example, a web service.</p>
<p>You can only configure the hosts file if you have reserved IP addresses in your home router for your special devices, like your home Linux server.</p>
<p>The list of files that I like to manage are:</p>
<ul>
<li>/etc/networks
<ul>
<li>Read the man page on ‘networks’</li>
<li>Add a local domain for your home network here. We will call this domain <em>.home</em>, that is, if your server’s short name is <em>pi</em>, then its long name becomes <em>pi.home</em></li>
<li>Avoid problems – do not use a valid <a href="https://data.iana.org/TLD/tlds-alpha-by-domain.txt">Top Level Domain (TLD)</a>.<br />
‘.home’ is not a TLD (at least not yet..)</li>
</ul></li>
<li>/etc/hosts
<ul>
<li>Read the man page on ‘hosts’</li>
<li>Add some IP addresses you have reserved in your home router for your hostnames</li>
<li>Be sure to include your home server</li>
</ul></li>
</ul>
<p>Your router’s private network address is used when declaring your home domain; the private network is typically something like 192.168.1.0 or 10.0.0.0. I did a quick analysis of a list of <a href="https://www.techspot.com/guides/287-default-router-ip-addresses/">the IP addresses of common routers</a>. The network address of the router is usually obtained by dropping the last octet from its IP address. The top 4 network addresses (without a trailing .0) were:</p>
<ul>
<li>192.168.0</li>
<li>192.168.1</li>
<li>192.168.2</li>
<li>10.0.0</li>
</ul>
<p>Note that your home network’s IPv4 address space is always in <a href="https://en.wikipedia.org/wiki/Private_network">the private network space</a> – that is, network traffic addressed to devices in a private network is never routed over the Internet.</p>
<p>The Ubuntu version of the /etc/hosts file automatically puts your hostname within the ‘localhost’ network during installation; we will comment that out.</p>
<p>Here are the examples:</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true"></a><span class="co">// File: /etc/networks</span></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true"></a><span class="co">// You can look at your router&#39;s management web page to understand</span></span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true"></a><span class="co">// what your network address is - the example used here is: 192.168.1.0</span></span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true"></a><span class="co">// You can drop the last octet, that is the &#39;.0&#39;, but I leave it in:</span></span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true"></a></span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true"></a><span class="kw">$ man networks</span></span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true"></a><span class="kw">$ sudo cp -p /etc/networks /etc/networks.orig</span></span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true"></a><span class="kw">$ sudo nano /etc/networks</span></span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true"></a><span class="kw">$ cat /etc/networks</span></span>
<span id="cb126-10"><a href="#cb126-10" aria-hidden="true"></a>link-local 169.254.0.0</span>
<span id="cb126-11"><a href="#cb126-11" aria-hidden="true"></a>home  192.168.1.0</span>
<span id="cb126-12"><a href="#cb126-12" aria-hidden="true"></a></span>
<span id="cb126-13"><a href="#cb126-13" aria-hidden="true"></a><span class="kw">$ diff /etc/networks.orig /etc/networks</span></span>
<span id="cb126-14"><a href="#cb126-14" aria-hidden="true"></a>2a3</span>
<span id="cb126-15"><a href="#cb126-15" aria-hidden="true"></a>&gt; home  192.168.1.0</span>
<span id="cb126-16"><a href="#cb126-16" aria-hidden="true"></a></span>
<span id="cb126-17"><a href="#cb126-17" aria-hidden="true"></a><span class="co">// File: /etc/hosts</span></span>
<span id="cb126-18"><a href="#cb126-18" aria-hidden="true"></a><span class="co">// Add your favourite devices with their reserved hostnames to /etc/hosts</span></span>
<span id="cb126-19"><a href="#cb126-19" aria-hidden="true"></a><span class="co">// Each host gets it full name with .home attached, as well as its short name</span></span>
<span id="cb126-20"><a href="#cb126-20" aria-hidden="true"></a><span class="co">// and any aliases:</span></span>
<span id="cb126-21"><a href="#cb126-21" aria-hidden="true"></a></span>
<span id="cb126-22"><a href="#cb126-22" aria-hidden="true"></a><span class="kw">$ man hosts</span></span>
<span id="cb126-23"><a href="#cb126-23" aria-hidden="true"></a><span class="kw">$ sudo cp -p /etc/hosts /etc/hosts.orig</span></span>
<span id="cb126-24"><a href="#cb126-24" aria-hidden="true"></a><span class="kw">$ sudo nano /etc/hosts</span></span>
<span id="cb126-25"><a href="#cb126-25" aria-hidden="true"></a><span class="kw">$ diff /etc/hosts.orig /etc/hosts</span></span>
<span id="cb126-26"><a href="#cb126-26" aria-hidden="true"></a>2c2</span>
<span id="cb126-27"><a href="#cb126-27" aria-hidden="true"></a>&lt; 127.0.1.1     pi</span>
<span id="cb126-28"><a href="#cb126-28" aria-hidden="true"></a>---</span>
<span id="cb126-29"><a href="#cb126-29" aria-hidden="true"></a>&gt; #127.0.1.1    pi</span>
<span id="cb126-30"><a href="#cb126-30" aria-hidden="true"></a>9a10,13</span>
<span id="cb126-31"><a href="#cb126-31" aria-hidden="true"></a>&gt; </span>
<span id="cb126-32"><a href="#cb126-32" aria-hidden="true"></a>&gt; 192.168.1.90  pi.home pi www</span>
<span id="cb126-33"><a href="#cb126-33" aria-hidden="true"></a>&gt; 192.168.1.65  desktop.home desktop</span>
<span id="cb126-34"><a href="#cb126-34" aria-hidden="true"></a>&gt; 192.168.1.80  odroid.home odroid</span>
<span id="cb126-35"><a href="#cb126-35" aria-hidden="true"></a>&gt; 192.168.1.81  laptop.home laptop</span>
<span id="cb126-36"><a href="#cb126-36" aria-hidden="true"></a>&gt; 192.168.1.86  inkjet.home inkjet</span></code></pre></div>
<h3 id="changing-the-servers-hostname">Changing the server’s hostname</h3>
<p>Now that we have a <em>.home</em> domain we can rename our server’s hostname. Suppose the server was originally named <em>pi</em> during the installation:</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true"></a><span class="co">// Ask what your hostname currently is:</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true"></a><span class="kw">$ hostname</span></span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true"></a>pi</span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true"></a></span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true"></a><span class="co">// Use &#39;hostnamectl&#39; to give the server a fully-qualified hostname by</span></span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true"></a><span class="co">// adding on the domain name.</span></span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true"></a><span class="kw">$ sudo hostnamectl hostname pi.home</span></span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true"></a></span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true"></a><span class="kw">$ hostname</span></span>
<span id="cb127-10"><a href="#cb127-10" aria-hidden="true"></a>pi.home</span></code></pre></div>
<h3 id="the-resolver-and-looking-up-your-local-hostnames">The resolver and looking up your local hostnames</h3>
<p>Well-known traditional command-line tools for querying DNS <a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a> are:</p>
<ul>
<li>host</li>
<li>nslookup</li>
<li>dig</li>
</ul>
<p>These tools look in <em>/etc/resolv.conf</em> for the nameserver(s) to query when looking up IP addresses or hostnames.</p>
<p>Of course, external DNS servers know nothing about your private local network. So, when you try querying a private host using one of the above utilities, you might see:</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true"></a><span class="kw">$ host pi.home</span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true"></a>pi.home has address 192.168.1.90</span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true"></a>Host pi.home not found: 3(NXDOMAIN)</span></code></pre></div>
<p>The ‘host’ command looked at the /etc/hosts file, but might also consulted the listed nameservers. This is because it consults an important file named <em>/etc/nsswitch.conf</em> which configures the order to try when looking up host and other data. Because ‘files’ is first, the daemon consults /etc/hosts before doing any dns request:</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true"></a><span class="kw">$ grep hosts /etc/nsswitch.conf</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true"></a>hosts:          files mdns4_minimal [NOTFOUND=return] dns</span></code></pre></div>
<p>There is another command-line tool – <em>getent</em> – for looking up local dns data, and does not consult nameservers:</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true"></a><span class="kw">$ getent hosts pi</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true"></a>192.168.1.90   pi.home pi web</span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true"></a><span class="kw">$ getent hosts 192.168.1.90</span></span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true"></a>192.168.1.90   pi.home pi</span></code></pre></div>
<p>Contemporary Linux version’s using systemd-resolvd handle this case better since it acts as a local nameserver that handles local DNS lookups, especially local IP address lookups. However it still whines about hostname looks, though it returns the correct local lookup anyway:</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true"></a><span class="co">// Try from another ubuntu host:</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true"></a></span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true"></a><span class="kw">$ hostname</span></span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true"></a>ubuntu.home</span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true"></a></span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true"></a><span class="kw">$ host pi</span></span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true"></a>pi has address 192.168.1.90</span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true"></a>Host pi not found: 3(NXDOMAIN)</span>
<span id="cb131-9"><a href="#cb131-9" aria-hidden="true"></a><span class="kw">$ echo $?</span></span>
<span id="cb131-10"><a href="#cb131-10" aria-hidden="true"></a>1</span>
<span id="cb131-11"><a href="#cb131-11" aria-hidden="true"></a></span>
<span id="cb131-12"><a href="#cb131-12" aria-hidden="true"></a><span class="kw">$ host 192.168.1.90</span></span>
<span id="cb131-13"><a href="#cb131-13" aria-hidden="true"></a>90.1.168.192.in-addr.arpa domain name pointer pi.</span>
<span id="cb131-14"><a href="#cb131-14" aria-hidden="true"></a></span>
<span id="cb131-15"><a href="#cb131-15" aria-hidden="true"></a></span>
<span id="cb131-16"><a href="#cb131-16" aria-hidden="true"></a><span class="co">// Now from the pi host - NOTE that it will not emit an NXDOMAIN message</span></span>
<span id="cb131-17"><a href="#cb131-17" aria-hidden="true"></a><span class="co">// for its own hostname, and thus will return success, which is &#39;0&#39;:</span></span>
<span id="cb131-18"><a href="#cb131-18" aria-hidden="true"></a></span>
<span id="cb131-19"><a href="#cb131-19" aria-hidden="true"></a><span class="kw">$ hostname</span></span>
<span id="cb131-20"><a href="#cb131-20" aria-hidden="true"></a>pi.home</span>
<span id="cb131-21"><a href="#cb131-21" aria-hidden="true"></a></span>
<span id="cb131-22"><a href="#cb131-22" aria-hidden="true"></a><span class="kw">$ host pi</span></span>
<span id="cb131-23"><a href="#cb131-23" aria-hidden="true"></a>pi has address 192.168.1.90</span>
<span id="cb131-24"><a href="#cb131-24" aria-hidden="true"></a><span class="kw">$ echo $?</span></span>
<span id="cb131-25"><a href="#cb131-25" aria-hidden="true"></a>0</span></code></pre></div>
<h3 id="modifying-the-resolvers-list-of-nameservers">Modifying the resolver’s list of nameservers</h3>
<p>The resolver file would typically be created at bootup when your computer makes a DHCP request to the home router asking for an IP address and the names of the router’s configured DNS servers.</p>
<p>On contemporary Linux versions the resolver file is created and managed differently than in older Linux versions. Recent Ubuntu LTS versions use a systemd service named <em>systemd-resolved</em> which by default manages the resolver file, and it runs a local DNS server:</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true"></a><span class="co">// list open network connections and find a name match for &#39;resolve&#39;</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true"></a><span class="fu"># lsof -i -P -n +c0 | grep resolve</span></span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true"></a>systemd-resolve  568 systemd-resolve   13u  IPv4  20701      0t0  UDP 127.0.0.53:53 </span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true"></a>systemd-resolve  568 systemd-resolve   14u  IPv4  20702      0t0  TCP 127.0.0.53:53 (LISTEN)</span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true"></a></span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true"></a><span class="co">// This is what the resolver file looks like on a newly installed Ubuntu node</span></span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true"></a><span class="kw">$ tail -3 /etc/resolv.conf </span></span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true"></a>nameserver 127.0.0.53</span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true"></a>options edns0 trust-ad</span>
<span id="cb132-10"><a href="#cb132-10" aria-hidden="true"></a>search .</span>
<span id="cb132-11"><a href="#cb132-11" aria-hidden="true"></a></span>
<span id="cb132-12"><a href="#cb132-12" aria-hidden="true"></a><span class="co">// The resolver file might actually be a symbolic link into territory owned by</span></span>
<span id="cb132-13"><a href="#cb132-13" aria-hidden="true"></a><span class="co">//  systemd -- check the status of this file in your installation:</span></span>
<span id="cb132-14"><a href="#cb132-14" aria-hidden="true"></a><span class="kw">$ ls -l /etc/resolv.conf </span></span>
<span id="cb132-15"><a href="#cb132-15" aria-hidden="true"></a>lrwxrwxrwx 1 root ... Mar 17 14:38 /etc/resolv.conf -&gt; ../run/systemd/resolve/stub-resolv.conf</span>
<span id="cb132-16"><a href="#cb132-16" aria-hidden="true"></a></span>
<span id="cb132-17"><a href="#cb132-17" aria-hidden="true"></a><span class="co">// get the resolver&#39;s status -- in this example the first DNS server is</span></span>
<span id="cb132-18"><a href="#cb132-18" aria-hidden="true"></a><span class="co">// my router&#39;s IP address</span></span>
<span id="cb132-19"><a href="#cb132-19" aria-hidden="true"></a><span class="kw">$ resolvectl status</span></span>
<span id="cb132-20"><a href="#cb132-20" aria-hidden="true"></a>Global</span>
<span id="cb132-21"><a href="#cb132-21" aria-hidden="true"></a>       Protocols: -LLMNR -mDNS -DNSOverTLS DNSSEC=no/unsupported</span>
<span id="cb132-22"><a href="#cb132-22" aria-hidden="true"></a>resolv.conf mode: stub</span>
<span id="cb132-23"><a href="#cb132-23" aria-hidden="true"></a></span>
<span id="cb132-24"><a href="#cb132-24" aria-hidden="true"></a>Link 2 (eth0)</span>
<span id="cb132-25"><a href="#cb132-25" aria-hidden="true"></a>    Current Scopes: DNS</span>
<span id="cb132-26"><a href="#cb132-26" aria-hidden="true"></a>         Protocols: +DefaultRoute +LLMNR -mDNS -DNSOverTLS DNSSEC=no/unsupported</span>
<span id="cb132-27"><a href="#cb132-27" aria-hidden="true"></a>Current DNS Server: 192.168.1.254</span>
<span id="cb132-28"><a href="#cb132-28" aria-hidden="true"></a>       DNS Servers: 192.168.1.254 75.153.171.67</span></code></pre></div>
<p>Sometimes you want to modify the list of external DNS servers – for example – the DNS servers used by <em>my</em> router have ‘slow’ days, so I like to have control over the list of DNS servers to fix this issue. Here is a look at the process.</p>
<p>Create a local copy of the resolver file - do not pollute systemd space:</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true"></a><span class="co">// Remove the current resolver file, in case it is a symbolic link:</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true"></a><span class="kw">$ sudo rm /etc/resolv.conf</span></span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true"></a></span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true"></a><span class="co">// Get a copy of /usr/lib/systemd/resolv.conf for manual control of the resolver</span></span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true"></a><span class="kw">$ sudo cp -p /usr/lib/systemd/resolv.conf /etc/resolv.conf</span></span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true"></a></span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true"></a><span class="co">// Change only the comments at the top to show it is locally managed:</span></span>
<span id="cb133-8"><a href="#cb133-8" aria-hidden="true"></a><span class="kw">$ sudo nano /etc/resolv.conf</span></span>
<span id="cb133-9"><a href="#cb133-9" aria-hidden="true"></a></span>
<span id="cb133-10"><a href="#cb133-10" aria-hidden="true"></a><span class="kw">$ tail -3 /etc/resolv.conf</span></span>
<span id="cb133-11"><a href="#cb133-11" aria-hidden="true"></a>nameserver 127.0.0.53</span>
<span id="cb133-12"><a href="#cb133-12" aria-hidden="true"></a>options edns0 trust-ad</span>
<span id="cb133-13"><a href="#cb133-13" aria-hidden="true"></a>search .</span></code></pre></div>
<p>By default this version of Ubuntu uses NetworkManager for network configuration, and the local systemd-resolved for DNS service. To make a permanent change to the DNS information known to systemd we configure NetworkManager using its management utility <em>nmcli</em>:</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true"></a><span class="co">// Look at current network connection configurations - I have not yet deleted</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true"></a><span class="co">// my old wireless network configuration (it is not active).</span></span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true"></a><span class="co">// You can delete it with:  nmcli con del &#39;MY-SSID&#39;</span></span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true"></a><span class="kw">$ nmcli connection show</span></span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true"></a>NAME                UUID                                  TYPE      DEVICE </span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true"></a>Wired connection 1  91591311-3c9a-3541-8176-29a8b639fffa  ethernet  eth0   </span>
<span id="cb134-7"><a href="#cb134-7" aria-hidden="true"></a>MY-SSID             924de702-7f7e-4e31-8dff-4bc968148f2b  wifi      --</span>
<span id="cb134-8"><a href="#cb134-8" aria-hidden="true"></a></span>
<span id="cb134-9"><a href="#cb134-9" aria-hidden="true"></a><span class="kw">$ nmcli con show &#39;Wired connection 1&#39; | grep -i dns</span></span>
<span id="cb134-10"><a href="#cb134-10" aria-hidden="true"></a>connection.mdns:                        -1 (default)</span>
<span id="cb134-11"><a href="#cb134-11" aria-hidden="true"></a>connection.dns-over-tls:                -1 (default)</span>
<span id="cb134-12"><a href="#cb134-12" aria-hidden="true"></a>ipv4.dns:                               --</span>
<span id="cb134-13"><a href="#cb134-13" aria-hidden="true"></a>ipv4.dns-search:                        --</span>
<span id="cb134-14"><a href="#cb134-14" aria-hidden="true"></a>ipv4.dns-options:                       --</span>
<span id="cb134-15"><a href="#cb134-15" aria-hidden="true"></a>...</span>
<span id="cb134-16"><a href="#cb134-16" aria-hidden="true"></a>IP4.DNS[1]:                             192.168.1.254</span>
<span id="cb134-17"><a href="#cb134-17" aria-hidden="true"></a>IP4.DNS[2]:                             75.153.171.67</span></code></pre></div>
<p>Now we add some other DNS servers to this configuration using nmcli; it should persist after a reboot. We are adding well-known public IP addresses from Cloudflare (1.1.1.1), and from Google (8.8.8.8):</p>
<!-- !! I need to check if we need to restart the network.. -->
<div class="sourceCode" id="cb135"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true"></a><span class="kw">$ sudo nmcli con modify &#39;Wired connection 1&#39; ipv4.dns &quot;1.1.1.1,8.8.8.8&quot;</span></span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true"></a><span class="kw">$ nmcli con show &#39;Wired connection 1&#39; | grep -i dns</span></span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true"></a>connection.mdns:                        -1 (default)</span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true"></a>connection.dns-over-tls:                -1 (default)</span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true"></a>ipv4.dns:                               1.1.1.1,8.8.8.8</span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true"></a>ipv4.dns-search:                        --</span>
<span id="cb135-7"><a href="#cb135-7" aria-hidden="true"></a>...</span>
<span id="cb135-8"><a href="#cb135-8" aria-hidden="true"></a>IP4.DNS[1]:                             1.1.1.1</span>
<span id="cb135-9"><a href="#cb135-9" aria-hidden="true"></a>IP4.DNS[2]:                             8.8.8.8</span>
<span id="cb135-10"><a href="#cb135-10" aria-hidden="true"></a>IP4.DNS[3]:                             192.168.1.254</span>
<span id="cb135-11"><a href="#cb135-11" aria-hidden="true"></a>IP4.DNS[4]:                             75.153.171.67</span>
<span id="cb135-12"><a href="#cb135-12" aria-hidden="true"></a></span>
<span id="cb135-13"><a href="#cb135-13" aria-hidden="true"></a><span class="co">// Check it with resolvectl:</span></span>
<span id="cb135-14"><a href="#cb135-14" aria-hidden="true"></a><span class="kw">$ resolvectl status | grep &#39;DNS Serv&#39;</span></span>
<span id="cb135-15"><a href="#cb135-15" aria-hidden="true"></a>Current DNS Server: 1.1.1.1</span>
<span id="cb135-16"><a href="#cb135-16" aria-hidden="true"></a>       DNS Servers: 1.1.1.1 8.8.8.8 192.168.1.254 75.153.171.67</span></code></pre></div>
<p>If ever you want to make a temporary change, use ‘resolvctl’ to do that; it will not persist after a reboot:</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true"></a><span class="co">// Here the Pi&#39;s ethernet device name is &#39;eth0&#39;</span></span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true"></a><span class="kw">$ sudo resolvectl dns eth0 9.9.9.9 8.8.4.4 75.153.171.67</span></span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true"></a></span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true"></a><span class="kw">$ resolvectl status</span></span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true"></a>Global</span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true"></a>       Protocols: -LLMNR -mDNS -DNSOverTLS DNSSEC=no/unsupported</span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true"></a>resolv.conf mode: foreign</span>
<span id="cb136-8"><a href="#cb136-8" aria-hidden="true"></a>      DNS Domain: ~.</span>
<span id="cb136-9"><a href="#cb136-9" aria-hidden="true"></a></span>
<span id="cb136-10"><a href="#cb136-10" aria-hidden="true"></a>Link 2 (eth0)</span>
<span id="cb136-11"><a href="#cb136-11" aria-hidden="true"></a>    Current Scopes: DNS</span>
<span id="cb136-12"><a href="#cb136-12" aria-hidden="true"></a>         Protocols: +DefaultRoute +LLMNR -mDNS -DNSOverTLS DNSSEC=no/unsupported</span>
<span id="cb136-13"><a href="#cb136-13" aria-hidden="true"></a>Current DNS Server: 9.9.9.9</span>
<span id="cb136-14"><a href="#cb136-14" aria-hidden="true"></a>       DNS Servers: 9.9.9.9 8.8.4.4 75.153.171.67</span></code></pre></div>
<h3 id="static-ip">Statically configuring your server’s IP address</h3>
<p>Sometimes you want full control of your Linux server’s network setup and you decide to eliminate the DHCP network configuration and manually configure your network parameters. Remember though that you can only configure specific IP addresses if you have reserved them in your home router.</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true"></a><span class="co">// Look at the current connection information:</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true"></a><span class="kw">$ nmcli con show --active</span></span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true"></a>NAME                UUID                                  TYPE      DEVICE </span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true"></a>Wired connection 1  91591311-3c9a-3541-8176-29a8b639fffa  ethernet  eth0</span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true"></a></span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true"></a><span class="co">// Create a new connection definition with the NetworkManager configuration</span></span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true"></a><span class="co">// tool.  Here we add the IPv4 address with the usual &#39;/24&#39; subnet indicator</span></span>
<span id="cb137-8"><a href="#cb137-8" aria-hidden="true"></a><span class="co">// for common home &#39;Class C&#39; networks, the gateway and your list of DNS</span></span>
<span id="cb137-9"><a href="#cb137-9" aria-hidden="true"></a><span class="co">// servers.  In this case my IP address is 192.168.1.90 and my gateway is</span></span>
<span id="cb137-10"><a href="#cb137-10" aria-hidden="true"></a><span class="co">// 192.168.1.254</span></span>
<span id="cb137-11"><a href="#cb137-11" aria-hidden="true"></a></span>
<span id="cb137-12"><a href="#cb137-12" aria-hidden="true"></a><span class="kw">$ sudo nmcli con add \</span></span>
<span id="cb137-13"><a href="#cb137-13" aria-hidden="true"></a><span class="kw"> type ethernet \</span></span>
<span id="cb137-14"><a href="#cb137-14" aria-hidden="true"></a><span class="kw"> con-name &#39;ethernet-eth0&#39; \</span></span>
<span id="cb137-15"><a href="#cb137-15" aria-hidden="true"></a><span class="kw"> ifname eth0 \</span></span>
<span id="cb137-16"><a href="#cb137-16" aria-hidden="true"></a><span class="kw"> ipv4.method manual \</span></span>
<span id="cb137-17"><a href="#cb137-17" aria-hidden="true"></a><span class="kw"> ipv4.addresses 192.168.1.90/24 \</span></span>
<span id="cb137-18"><a href="#cb137-18" aria-hidden="true"></a><span class="kw"> gw4 192.168.1.254 \</span></span>
<span id="cb137-19"><a href="#cb137-19" aria-hidden="true"></a><span class="kw"> ipv4.dns &quot;1.1.1.1 8.8.8.8 192.168.1.254 75.153.171.67&quot;</span></span>
<span id="cb137-20"><a href="#cb137-20" aria-hidden="true"></a>Connection &#39;ethernet-eth0&#39; (bc6badb3-3dde-4009-998d-2dee20831670) successfully added.</span>
<span id="cb137-21"><a href="#cb137-21" aria-hidden="true"></a></span>
<span id="cb137-22"><a href="#cb137-22" aria-hidden="true"></a><span class="kw">$ nmcli con show</span></span>
<span id="cb137-23"><a href="#cb137-23" aria-hidden="true"></a>NAME                UUID                                  TYPE      DEVICE </span>
<span id="cb137-24"><a href="#cb137-24" aria-hidden="true"></a>Wired connection 1  91591311-3c9a-3541-8176-29a8b639fffa  ethernet  eth0   </span>
<span id="cb137-25"><a href="#cb137-25" aria-hidden="true"></a>ethernet-eth0       bc6badb3-3dde-4009-998d-2dee20831670  ethernet  --</span>
<span id="cb137-26"><a href="#cb137-26" aria-hidden="true"></a></span>
<span id="cb137-27"><a href="#cb137-27" aria-hidden="true"></a><span class="co">// Now we bring up the new connection; this automatically sets the old</span></span>
<span id="cb137-28"><a href="#cb137-28" aria-hidden="true"></a><span class="co">// connection method as &#39;not active&#39;.  We delete the old connection method:</span></span>
<span id="cb137-29"><a href="#cb137-29" aria-hidden="true"></a><span class="kw">$ sudo /bin/bash</span></span>
<span id="cb137-30"><a href="#cb137-30" aria-hidden="true"></a><span class="fu"># nmcli con up id ethernet-eth0</span></span>
<span id="cb137-31"><a href="#cb137-31" aria-hidden="true"></a><span class="fu"># nmcli con show</span></span>
<span id="cb137-32"><a href="#cb137-32" aria-hidden="true"></a>NAME                UUID                                  TYPE      DEVICE </span>
<span id="cb137-33"><a href="#cb137-33" aria-hidden="true"></a>ethernet-eth0       bc6badb3-3dde-4009-998d-2dee20831670  ethernet  eth0   </span>
<span id="cb137-34"><a href="#cb137-34" aria-hidden="true"></a>Wired connection 1  91591311-3c9a-3541-8176-29a8b639fffa  ethernet  -- </span>
<span id="cb137-35"><a href="#cb137-35" aria-hidden="true"></a><span class="fu"># nmcli con del &#39;Wired connection 1&#39;</span></span>
<span id="cb137-36"><a href="#cb137-36" aria-hidden="true"></a><span class="co">// We reboot to test subsequent network state:</span></span>
<span id="cb137-37"><a href="#cb137-37" aria-hidden="true"></a><span class="fu"># reboot</span></span></code></pre></div>
<h2 id="root">Other ways of becoming the superuser in a restricted environment</h2>
<p>You might run into a chicken-and-egg problem occasionally because you need to do something like:</p>
<ul>
<li>move your home directory files</li>
<li>fix a problem with logging in as a regular user</li>
<li>you accidentally removed the sudo package</li>
</ul>
<p>Then you realize that you need to be logged in as a regular user to sudo to <em>root</em>, but you cannot be logged in to accomplish your task.</p>
<h3 id="setting-a-password-for-the-superuser">Setting a password for the superuser</h3>
<p>One solution is to set a password for the <em>root</em> user - you can always disable the password afterwards.</p>
<p>This is an example of setting a password for root – as always you set a <strong>strong</strong> password:</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true"></a><span class="co">// Normally password access is locked in /etc/shadow - we unlock it when</span></span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true"></a><span class="co">// we set a password:</span></span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true"></a><span class="kw">$ man passwd</span></span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true"></a><span class="kw">$ man 5 passwd</span></span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true"></a><span class="kw">$ sudo /bin/bash</span></span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true"></a><span class="fu"># id</span></span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true"></a>uid=0(root) gid=0(root) groups=0(root)</span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true"></a><span class="fu"># head -1 /etc/shadow</span></span>
<span id="cb138-9"><a href="#cb138-9" aria-hidden="true"></a>root:!:19476:0:99999:7:::</span>
<span id="cb138-10"><a href="#cb138-10" aria-hidden="true"></a><span class="fu"># passwd </span></span>
<span id="cb138-11"><a href="#cb138-11" aria-hidden="true"></a>New password: </span>
<span id="cb138-12"><a href="#cb138-12" aria-hidden="true"></a>Retype new password: </span>
<span id="cb138-13"><a href="#cb138-13" aria-hidden="true"></a>passwd: password updated successfully</span>
<span id="cb138-14"><a href="#cb138-14" aria-hidden="true"></a></span>
<span id="cb138-15"><a href="#cb138-15" aria-hidden="true"></a><span class="co">// We now see an encrypted password in the password field in the shadow file:</span></span>
<span id="cb138-16"><a href="#cb138-16" aria-hidden="true"></a><span class="fu"># head -1 /etc/shadow</span></span>
<span id="cb138-17"><a href="#cb138-17" aria-hidden="true"></a>root:$y$j9T$FFNwo6b8WAoEu...tQQhPaSIumPjNPXjWAe7h2M4:19519:0:99999:7:::</span></code></pre></div>
<p>Now we can log in directly as root at the server’s text console; remember that it is foolish to login as ‘root’ to a graphical environment. Using web browsers as ‘root’ is not smart.</p>
<p>To lock the root user from using a password, use the <strong>-l</strong> option; you can unlock it in the future with the <strong>-u</strong> option.</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true"></a></span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true"></a><span class="co">// lock it:</span></span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true"></a><span class="fu"># passwd -l root</span></span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true"></a>passwd: password expiry information changed.</span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true"></a></span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true"></a><span class="fu"># head -1 /etc/shadow</span></span>
<span id="cb139-7"><a href="#cb139-7" aria-hidden="true"></a>root:!$y$j9T$FFNwo6b8WAoEu...tQQhPaSIumPjNPXjWAe7h2M4:19519:0:99999:7:::</span></code></pre></div>
<h3 id="allowing-secure-shell-access-from-another-device-in-your-lan">Allowing secure-shell access from another device in your LAN</h3>
<p>Another solution is to allow another device in your home network to have secure-shell access to the root account on your Ubuntu server or desktop. It is mentioned briefly in the <a href="#chapter-08">secure-shell section</a> of this guide, but I summarize the main options here.</p>
<p>The secure-shell daemon must be installed and running on the target device. In <em>/etc/ssh/sshd_config</em> add the remote device’s IP address with <em>root@</em> prefixing it to the ‘AllowUsers’ rule. Here access to the root account is allowed from 192.168.1.65:</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true"></a><span class="fu"># id</span></span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true"></a>uid=0(root) gid=0(root) groups=0(root)</span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true"></a><span class="fu"># grep AllowUsers /etc/ssh/sshd_config</span></span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true"></a>AllowUsers      myname@192.168.1.* root@192.168.1.65 *@localhost</span></code></pre></div>
<p>Then root’s <em>/root/.ssh/authorized_keys</em> file must specifically allow the remote device; in this case we use the *from=’‘* option (see the man page for ’authorized_keys’). As well, if you also allow localhost (127.0.0.1) you would allow your login account to ssh locally to root:</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true"></a><span class="fu"># tail -1 ~/.ssh/authorized_keys</span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true"></a>from=&quot;127.0.0.1,192.168.1.65&quot; ssh-rsa AAAAB3...6oLYnLx5d myname@somewhere.com</span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true"></a></span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true"></a><span class="kw">$ whoami</span></span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true"></a>myname</span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true"></a></span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true"></a><span class="kw">$ ssh -A -Y root@localhost</span></span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true"></a>Last login: Tue Jun 13 15:10:42 2023 from desktop.home</span>
<span id="cb141-9"><a href="#cb141-9" aria-hidden="true"></a><span class="fu"># ps -ef --forest|grep ssh</span></span>
<span id="cb141-10"><a href="#cb141-10" aria-hidden="true"></a>root       685       1  May26 ?      00:00:00 sshd: /usr/sbin/sshd -D [listener] ...</span>
<span id="cb141-11"><a href="#cb141-11" aria-hidden="true"></a>root    395328     685  09:27 ?      00:00:00  \_ sshd: myname [priv]</span>
<span id="cb141-12"><a href="#cb141-12" aria-hidden="true"></a>myname  395330  395328  09:27 ?      00:00:00  |   \_ sshd: myname@pts/0</span>
<span id="cb141-13"><a href="#cb141-13" aria-hidden="true"></a>myname  395414  395331  09:29 pts/0  00:00:00  |           \_ ssh -A -Y root@localhost</span>
<span id="cb141-14"><a href="#cb141-14" aria-hidden="true"></a>root    395415     685  09:29 ?      00:00:00  \_ sshd: root@pts/1</span>
<span id="cb141-15"><a href="#cb141-15" aria-hidden="true"></a>root    395460  395429  09:30 pts/1  00:00:00          \_ grep --color=auto ssh</span>
<span id="cb141-16"><a href="#cb141-16" aria-hidden="true"></a>myname    3693       1  May26 ?      00:00:00 ssh-agent</span></code></pre></div>
<h2 id="new-git-repo">Creating a new Git repository</h2>
<p>This is a list of small tasks that you as the git manager must do for each new repository that you host on your Git server:</p>
<ul>
<li>Initialize the repository</li>
<li>Create a symbolic link to the repository’s name without the ‘.git’ extension</li>
<li>Edit the ‘description’ file with a one-line description</li>
<li>Touch the git-daemon-export-ok file to enable exporting the repository</li>
<li>Add the repository name and author to the projects list file for gitweb</li>
</ul>
<div class="sourceCode" id="cb142"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true"></a><span class="kw">$ sudo -u git /bin/bash</span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true"></a></span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true"></a><span class="co">// Let&#39;s go ahead and create a git repository named &#39;test&#39;.</span></span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true"></a><span class="co">// We do this by using the git &#39;init&#39; command:</span></span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true"></a><span class="kw">$ cd /git</span></span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true"></a><span class="kw">$ git --bare init test.git</span></span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true"></a>hint: Using &#39;master&#39; as the name for the initial branch. This default branch name</span>
<span id="cb142-8"><a href="#cb142-8" aria-hidden="true"></a>hint: is subject to change. To configure the initial branch name to use in all</span>
<span id="cb142-9"><a href="#cb142-9" aria-hidden="true"></a>hint: of your new repositories, which will suppress this warning, call:</span>
<span id="cb142-10"><a href="#cb142-10" aria-hidden="true"></a>hint: </span>
<span id="cb142-11"><a href="#cb142-11" aria-hidden="true"></a>hint:   git config --global init.defaultBranch &lt;name&gt;</span>
<span id="cb142-12"><a href="#cb142-12" aria-hidden="true"></a>hint: </span>
<span id="cb142-13"><a href="#cb142-13" aria-hidden="true"></a>hint: Names commonly chosen instead of &#39;master&#39; are &#39;main&#39;, &#39;trunk&#39; and</span>
<span id="cb142-14"><a href="#cb142-14" aria-hidden="true"></a>hint: &#39;development&#39;. The just-created branch can be renamed via this command:</span>
<span id="cb142-15"><a href="#cb142-15" aria-hidden="true"></a>hint: </span>
<span id="cb142-16"><a href="#cb142-16" aria-hidden="true"></a>hint:   git branch -m &lt;name&gt;</span>
<span id="cb142-17"><a href="#cb142-17" aria-hidden="true"></a>Initialized empty Git repository in /var/www/git/test.git/</span>
<span id="cb142-18"><a href="#cb142-18" aria-hidden="true"></a></span>
<span id="cb142-19"><a href="#cb142-19" aria-hidden="true"></a><span class="kw">$ ls -l</span></span>
<span id="cb142-20"><a href="#cb142-20" aria-hidden="true"></a>drwxr-xr-x 7 git git 4096 Jul  6 14:52 test.git</span>
<span id="cb142-21"><a href="#cb142-21" aria-hidden="true"></a></span>
<span id="cb142-22"><a href="#cb142-22" aria-hidden="true"></a><span class="co">// Create the symbolic link without the &#39;git&#39; extension</span></span>
<span id="cb142-23"><a href="#cb142-23" aria-hidden="true"></a><span class="kw">$ ln -s test.git test</span></span>
<span id="cb142-24"><a href="#cb142-24" aria-hidden="true"></a></span>
<span id="cb142-25"><a href="#cb142-25" aria-hidden="true"></a><span class="co">// We create a repository description, and we export the repository so that</span></span>
<span id="cb142-26"><a href="#cb142-26" aria-hidden="true"></a><span class="co">// it is visible:</span></span>
<span id="cb142-27"><a href="#cb142-27" aria-hidden="true"></a><span class="kw">$ nano test.git/description</span></span>
<span id="cb142-28"><a href="#cb142-28" aria-hidden="true"></a><span class="kw">$ cat test.git/description</span></span>
<span id="cb142-29"><a href="#cb142-29" aria-hidden="true"></a>This is just a test.</span>
<span id="cb142-30"><a href="#cb142-30" aria-hidden="true"></a></span>
<span id="cb142-31"><a href="#cb142-31" aria-hidden="true"></a><span class="kw">$ cd test.git/</span></span>
<span id="cb142-32"><a href="#cb142-32" aria-hidden="true"></a><span class="kw">$ ls</span></span>
<span id="cb142-33"><a href="#cb142-33" aria-hidden="true"></a>branches  config  description  HEAD  hooks  info  objects  refs</span>
<span id="cb142-34"><a href="#cb142-34" aria-hidden="true"></a></span>
<span id="cb142-35"><a href="#cb142-35" aria-hidden="true"></a><span class="kw">$ touch git-daemon-export-ok</span></span>
<span id="cb142-36"><a href="#cb142-36" aria-hidden="true"></a></span>
<span id="cb142-37"><a href="#cb142-37" aria-hidden="true"></a><span class="co">// Finally we add the repository name and author to the projects list file.</span></span>
<span id="cb142-38"><a href="#cb142-38" aria-hidden="true"></a><span class="co">// This file is used by &#39;gitweb&#39;, and it&#39;s name is in &#39;/etc/gitweb.conf&#39;</span></span>
<span id="cb142-39"><a href="#cb142-39" aria-hidden="true"></a><span class="co">// You must create the file the first time you create a new repository.</span></span>
<span id="cb142-40"><a href="#cb142-40" aria-hidden="true"></a><span class="co">// Thereafter you simply add any new git projects to this file:</span></span>
<span id="cb142-41"><a href="#cb142-41" aria-hidden="true"></a><span class="kw">$ cd /git</span></span>
<span id="cb142-42"><a href="#cb142-42" aria-hidden="true"></a><span class="kw">$ touch projects_list_for_homegit</span></span>
<span id="cb142-43"><a href="#cb142-43" aria-hidden="true"></a><span class="kw">$ nano projects_list_for_homegit</span></span>
<span id="cb142-44"><a href="#cb142-44" aria-hidden="true"></a><span class="kw">$ cat projects_list_for_homegit </span></span>
<span id="cb142-45"><a href="#cb142-45" aria-hidden="true"></a>test MyFirstName+MyLastName</span>
<span id="cb142-46"><a href="#cb142-46" aria-hidden="true"></a></span>
<span id="cb142-47"><a href="#cb142-47" aria-hidden="true"></a><span class="kw">$ exit</span></span></code></pre></div>
<h2 id="new-git-user">Allowing a new user SSH access to the Git server</h2>
<p>One time only we set up the authorized keys file.</p>
<div class="sourceCode" id="cb143"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true"></a><span class="kw">$ sudo -u git /bin/bash</span></span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true"></a><span class="kw">$ cd</span></span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true"></a><span class="kw">$ pwd</span></span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true"></a>/home/git</span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true"></a><span class="kw">$ mkdir .ssh</span></span>
<span id="cb143-6"><a href="#cb143-6" aria-hidden="true"></a><span class="kw">$ chmod go-rwx .ssh</span></span>
<span id="cb143-7"><a href="#cb143-7" aria-hidden="true"></a><span class="kw">$ touch .ssh/authorized_keys</span></span>
<span id="cb143-8"><a href="#cb143-8" aria-hidden="true"></a><span class="kw">$ chmod 600 .ssh/authorized_keys</span></span></code></pre></div>
<p>Then for each new user whom we allow to use ssh access to git repositories we need to add their designated public ssh key.</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode console"><code class="sourceCode console"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true"></a><span class="co">// add public keys for allowed users, starting with yourself</span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true"></a><span class="kw">$ nano .ssh/authorized_keys</span></span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true"></a><span class="kw">$ tail -1 authorized_keys</span></span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true"></a>ssh-rsa AAAAB3...6oLYnLx5d myname@somewhere.com</span></code></pre></div>
<!-- !! Note about IPv6 -->
<!-- -->
<h1 id="command-list">List of Linux commands used in this guide</h1>
<p>This is a list of command-line tools from <em>console</em> sessions in this guide. Each command is linked back to the chapter in which it was found. If a command can be found in more than one chapter then only the first chapter is linked.</p>
<p>Only Linux-provided commands are shown. Local commands used from local scripts are not included.</p>
<p>The shell scripts used to generate this list are detailed in my <a href="https://deatrich.github.io/doc-with-pandoc-markdown/current/doc-with-pandoc-markdown.html#chapter-5">Getting Started With Pandoc Markdown</a> project.</p>
<!-- command-list-starts -->
<dl>
<dt><a href="#chapter-11">a2dissite</a>:</dt>
<dd>Disables an apache2 web site or virtual host configuration
</dd>
<dt><a href="#chapter-11">a2enmod</a>:</dt>
<dd>Enables an apache2 module
</dd>
<dt><a href="#chapter-11">a2ensite</a>:</dt>
<dd>Enables an apache2 web site or virtual host configuration
</dd>
<dt><a href="#chapter-07">aa-status</a>:</dt>
<dd>Displays various information about the current AppArmor policy
</dd>
<dt><a href="#chapter-07">aa-teardown</a>:</dt>
<dd>Unloads all AppArmor profiles
</dd>
<dt><a href="#chapter-07">add-apt-repository</a>:</dt>
<dd>Adds an apt software repository into the /etc/apt/sources.list file
</dd>
<dt><a href="#chapter-04">apt</a>:</dt>
<dd>Command-line interface for Debian-based <em>dpkg</em> management system
</dd>
<dt><a href="#chapter-07">/bin/bash</a>:</dt>
<dd>GNU Bourne-Again Shell
</dd>
<dt><a href="#chapter-14">brctl</a>:</dt>
<dd>Utility used for ethernet bridge administration
</dd>
<dt><a href="#chapter-01">cat</a>:</dt>
<dd>Concatenates files and print on standard output
</dd>
<dt><a href="#chapter-05">cd</a>:</dt>
<dd>Change directories to the requested directory
</dd>
<dd>Built-in shell command
</dd>
<dt><a href="#chapter-05">chmod</a>:</dt>
<dd>Changes the mode of a file or directory
</dd>
<dt><a href="#chapter-05">chown</a>:</dt>
<dd>Changes ownership of a file or directory
</dd>
<dt><a href="#chapter-05">cp</a>:</dt>
<dd>Copies file(s) and/or directories
</dd>
<dt><a href="#chapter-12">crontab</a>:</dt>
<dd>Maintains crontab files for individual users
</dd>
<dt><a href="#chapter-07">date</a>:</dt>
<dd>Prints or sets the system date and time
</dd>
<dt><a href="#zappendix">dd</a>:</dt>
<dd>Converts and copies a file
</dd>
<dt><a href="#chapter-10">df</a>:</dt>
<dd>Reports file system disk space usage
</dd>
<dt><a href="#chapter-05">diff</a>:</dt>
<dd>Reports the difference of 2 target files or directories
</dd>
<dt><a href="#chapter-13">dpkg</a>:</dt>
<dd>The lower-level package manager for Debian
</dd>
<dt><a href="#chapter-05">du</a>:</dt>
<dd>Estimates file space usage
</dd>
<dt><a href="#zappendix">e2fsck</a>:</dt>
<dd>Checks a Linux ext2/ext3/ext4 file system
</dd>
<dt><a href="#chapter-11">echo</a>:</dt>
<dd>Displays a line of text
</dd>
<dt><a href="#chapter-10">egrep</a>:</dt>
<dd>Prints lines that match extended regular expression patterns
</dd>
<dt><a href="#zappendix">eject</a>:</dt>
<dd>Ejects removable media
</dd>
<dt><a href="#chapter-08">exit</a>:</dt>
<dd>Causes normal process termination
</dd>
<dt><a href="#chapter-10">exportfs</a>:</dt>
<dd>Maintains table of exported NFS file systems
</dd>
<dt><a href="#chapter-07">fallocate</a>:</dt>
<dd>Preallocates or Deallocates space to a file
</dd>
<dt><a href="#chapter-03">fdisk</a>:</dt>
<dd>Manipulates disk partition table
</dd>
<dt><a href="#chapter-11">find</a>:</dt>
<dd>Searches for files in a directory hierarchy
</dd>
<dt><a href="#chapter-11">firefox</a>:</dt>
<dd>A free and open source web browser from Mozilla
</dd>
<dt><a href="#chapter-07">free</a>:</dt>
<dd>Displays amount of free and used memory in the system
</dd>
<dt><a href="#zappendix">getent</a>:</dt>
<dd>Gets entries from Name Service Switch libraries
</dd>
<dt><a href="#chapter-13">git</a>:</dt>
<dd>Utility for the Git revision control system
</dd>
<dt><a href="#chapter-05">grep</a>:</dt>
<dd>Prints lines that match patterns
</dd>
<dt><a href="#chapter-10">groupadd</a>:</dt>
<dd>Creates a new group
</dd>
<dt><a href="#chapter-07">hcitool</a>:</dt>
<dd>Configures Bluetooth connections
</dd>
<dt><a href="#chapter-11">head</a>:</dt>
<dd>Outputs the first part of files
</dd>
<dt><a href="#chapter-13">hostname</a>:</dt>
<dd>Shows or sets the system’s host name
</dd>
<dt><a href="#zappendix">hostnamectl</a>:</dt>
<dd>Controls the system hostname via systemd
</dd>
<dt><a href="#zappendix">host</a>:</dt>
<dd>Utility for DNS lookup
</dd>
<dt><a href="#chapter-13">id</a>:</dt>
<dd>Prints real and effective user and group IDs
</dd>
<dt><a href="#chapter-07">iw</a>:</dt>
<dd>Shows or manipulates wireless devices and their configuration
</dd>
<dt><a href="#chapter-14">kvm-ok</a>:</dt>
<dd>Determines if this system is capable of running hardware acceleration
</dd>
<dt><a href="#chapter-07">last</a>:</dt>
<dd>Shows a listing of last logged in users
</dd>
<dt><a href="#chapter-07">less</a>:</dt>
<dd>Opposite of ‘more’,
</dd>
<dt><a href="#chapter-11">links</a>:</dt>
<dd>A lynx-like alternative character mode WWW browser
</dd>
<dt><a href="#chapter-13">ln</a>:</dt>
<dd>Makes links between files
</dd>
<dt><a href="#chapter-07">locale</a>:</dt>
<dd>Gets locale-specific information
</dd>
<dt><a href="#chapter-07">localectl</a>:</dt>
<dd>Controls the system locale and keyboard layout settings via systemd
</dd>
<dt><a href="#zappendix">lsblk</a>:</dt>
<dd>Lists block devices
</dd>
<dt><a href="#chapter-01">ls</a>:</dt>
<dd>lists directory contents
</dd>
<dt><a href="#chapter-10">lsof</a>:</dt>
<dd>Lists open files (files being actively used)
</dd>
<dt><a href="#chapter-11">lynx</a>:</dt>
<dd>A general purpose distributed information browser for the World Wide Web
</dd>
<dt><a href="#chapter-07">man</a>:</dt>
<dd>Utility enabling repetitive command execution
</dd>
<dt><a href="#chapter-05">mkdir</a>:</dt>
<dd>Creates one or more directories
</dd>
<dt><a href="#zappendix">mkfs.ext4</a>:</dt>
<dd>Creates an ext4 file system
</dd>
<dt><a href="#chapter-07">mkswap</a>:</dt>
<dd>Sets up a Linux swap area
</dd>
<dt><a href="#chapter-14">modinfo</a>:</dt>
<dd>Shows information about a Linux kernel module
</dd>
<dt><a href="#chapter-07">mokutil</a>:</dt>
<dd>Utility for manipulating machine owner keys
</dd>
<dt><a href="#chapter-06">mount</a>:</dt>
<dd>Mount a filesystem
</dd>
<dt><a href="#chapter-12">mysql</a>:</dt>
<dd>A shell interface to MySQL or MariaDB databases
</dd>
<dt><a href="#chapter-12">mysql_secure_installation</a>:</dt>
<dd>Improves MariaDB installation security
</dd>
<dt><a href="#chapter-05">nano</a>:</dt>
<dd>A simple curses-based text editor
</dd>
<dt><a href="#chapter-14">nmcli</a>:</dt>
<dd>Command-line tool for controlling NetworkManager
</dd>
<dt><a href="#chapter-11">openssl</a>:</dt>
<dd>OpenSSL command line program
</dd>
<dt><a href="#zappendix">parted</a>:</dt>
<dd>A partition manipulation program
</dd>
<dt><a href="#chapter-10">passwd</a>:</dt>
<dd>Changes a user password
</dd>
<dt><a href="#chapter-10">ps</a>:</dt>
<dd>Reports a snapshot of the current processes
</dd>
<dt><a href="#chapter-06">pwd</a>:</dt>
<dd>Returns the <em>present working directory</em>
</dd>
<dt><a href="#zappendix">reboot</a>:</dt>
<dd>Reboots the machine
</dd>
<dt><a href="#chapter-09">remmina</a>:</dt>
<dd>A GTK+ Remote Desktop Client
</dd>
<dt><a href="#zappendix">resize2fs</a>:</dt>
<dd>Resizes an ext2/ext3/ext4 file system
</dd>
<dt><a href="#zappendix">resolvectl</a>:</dt>
<dd>Resolves domain names, IPv4 and IPv6 addresses, DNS records and services
</dd>
<dt><a href="#chapter-06">rm</a>:</dt>
<dd>Removes file(s) or directories
</dd>
<dt><a href="#chapter-04">rpi-eeprom-update</a>:</dt>
<dd>Checks whether the Raspberry Pi bootloader EEPROM
</dd>
<dt><a href="#chapter-08">scp</a>:</dt>
<dd>OpenSSH secure file copy program
</dd>
<dt><a href="#zappendix">sha256sum</a>:</dt>
<dd>Computes and checks SHA256 message digests
</dd>
<dt><a href="#chapter-07">snap</a>:</dt>
<dd>The package manager for Canonical’s alternate SNAP package system
</dd>
<dt><a href="#chapter-07">ssh</a>:</dt>
<dd>OpenSSH remote login client
</dd>
<dt><a href="#chapter-08">ssh-keygen</a>:</dt>
<dd>OpenSSH authentication key utility
</dd>
<dt><a href="#chapter-03">sudo</a>:</dt>
<dd>Executes a command as another user
</dd>
<dt><a href="#chapter-07">swapoff</a>:</dt>
<dd>Disables devices and files for paging and swapping
</dd>
<dt><a href="#chapter-07">swapon</a>:</dt>
<dd>Enables devices and files for paging and swapping
</dd>
<dt><a href="#chapter-05">systemctl</a>:</dt>
<dd>Controls the systemd system and service manager
</dd>
<dt><a href="#chapter-05">tail</a>:</dt>
<dd>Outputs the last part of files
</dd>
<dt><a href="#chapter-06">tar</a>:</dt>
<dd>Tape or file hierarchy archiving utility
</dd>
<dt><a href="#chapter-04">timedatectl</a>:</dt>
<dd>Controls the system time and date via systemd
</dd>
<dt><a href="#chapter-08">touch</a>:</dt>
<dd>Changes file timestamps
</dd>
<dt><a href="#zappendix">tune2fs</a>:</dt>
<dd>Adjusts tunable file system parameters on ext2/ext3/ext4 file systems
</dd>
<dt><a href="#chapter-06">umount</a>:</dt>
<dd>Unmounts filesystems
</dd>
<dt><a href="#chapter-10">useradd</a>:</dt>
<dd>Creates a new user or updates default new user information
</dd>
<dt><a href="#chapter-10">usermod</a>:</dt>
<dd>Modifies a user account
</dd>
<dt><a href="#chapter-14">virsh</a>:</dt>
<dd>Shell interface to virtual guest domains
</dd>
<dt><a href="#chapter-14">virt-install</a>:</dt>
<dd>Provisions new virtual machines
</dd>
<dt><a href="#zappendix">wget</a>:</dt>
<dd>The non-interactive network downloader
</dd>
<dt><a href="#chapter-13">whoami</a>:</dt>
<dd>Prints your effective userid
</dd>
<dt><a href="#chapter-09">x2goclient</a>:</dt>
<dd>Client application to launch server-side X2Go sessions
</dd>
<dt><a href="#chapter-09">xhost</a>:</dt>
<dd>Server access control program for X
</dd>
<dt><a href="#zappendix">xz</a>:</dt>
<dd>Compresses .xz and .lzma files
</dd>
</dl>
<!-- command-list-ends -->
<!-- -->
<h1 id="url-list">List of URLs mentioned in this guide</h1>
<p>If any external URLs are linked in a chapter then they are displayed and linked below, organized by chapter name.</p>
<dl>
<dt><a href="#chapter-01">Overview</a>:</dt>
<dd><p><a href="https://www.hardkernel.com/">https://www.hardkernel.com/</a></p>
</dd>
<dd><p><a href="https://www.markdownguide.org/getting-started/">https://www.markdownguide.org/getting-started/</a></p>
</dd>
<dd><p><a href="https://pandoc.org/">https://pandoc.org/</a></p>
</dd>
<dd><p><a href="https://github.com/deatrich/">https://github.com/deatrich/</a></p>
</dd>
<dd><p><a href="https://github.com/deatrich/console-syntax/">https://github.com/deatrich/console-syntax/</a></p>
</dd>
<dd><p><a href="https://github.com/deatrich/doc-with-pandoc-markdown/">https://github.com/deatrich/doc-with-pandoc-markdown/</a></p>
</dd>
<dt><a href="#chapter-02">Picking the OS (Operating System) and the window manager</a>:</dt>
<dd><p><a href="https://releases.ubuntu.com/">https://releases.ubuntu.com/</a></p>
</dd>
<dd><p><a href="https://ubuntu.com/pro/tutorial">https://ubuntu.com/pro/tutorial</a></p>
</dd>
<dd><p><a href="https://lists.ubuntu.com/">https://lists.ubuntu.com/</a></p>
</dd>
<dd><p><a href="https://lists.ubuntu.com/mailman/listinfo/ubuntu-security-announce">https://lists.ubuntu.com/mailman/listinfo/ubuntu-security-announce</a></p>
</dd>
<dd><p><a href="https://lists.ubuntu.com/mailman/listinfo/ubuntu-announce">https://lists.ubuntu.com/mailman/listinfo/ubuntu-announce</a></p>
</dd>
<dd><p><a href="https://mate-desktop.org/">https://mate-desktop.org/</a></p>
</dd>
<dd><p><a href="https://en.wikipedia.org/wiki/X.Org_Server">https://en.wikipedia.org/wiki/X.Org_Server</a></p>
</dd>
<dd><p><a href="https://en.wikipedia.org/wiki/Wayland_(protocol)#Wayland_compositors">https://en.wikipedia.org/wiki/Wayland_(protocol)#Wayland_compositors</a></p>
</dd>
<dd><p><a href="https://discourse.ubuntu.com/t/ubuntu-pro-faq/34042">https://discourse.ubuntu.com/t/ubuntu-pro-faq/34042</a></p>
</dd>
<dt><a href="#chapter-03">Creating the installation disk</a>:</dt>
<dd><p><a href="https://ubuntu-mate.org/raspberry-pi/">https://ubuntu-mate.org/raspberry-pi/</a></p>
</dd>
<dd><p><a href="https://ubuntu-mate.org/raspberry-pi/download/">https://ubuntu-mate.org/raspberry-pi/download/</a></p>
</dd>
<dd><p><a href="https://www.tomshardware.com/best-picks/raspberry-pi-microsd-cards">https://www.tomshardware.com/best-picks/raspberry-pi-microsd-cards</a></p>
</dd>
<dd><p><a href="https://ubuntu.com/tutorials/how-to-install-ubuntu-desktop-on-raspberry-pi-4#2-prepare-the-sd-card">https://ubuntu.com/tutorials/how-to-install-ubuntu-desktop-on-raspberry-pi-4#2-prepare-the-sd-card</a></p>
</dd>
<dd><p><a href="https://downloads.raspberrypi.org/imager/imager_latest.exe">https://downloads.raspberrypi.org/imager/imager_latest.exe</a></p>
</dd>
<dd><p><a href="https://downloads.raspberrypi.org/imager/imager_latest.dmg">https://downloads.raspberrypi.org/imager/imager_latest.dmg</a></p>
</dd>
<dd><p><a href="https://downloads.raspberrypi.org/imager/imager_latest_amd64.deb">https://downloads.raspberrypi.org/imager/imager_latest_amd64.deb</a></p>
</dd>
<dt><a href="#chapter-04">Installation and first experience</a>:</dt>
<dd><p><a href="https://ubuntu.com/tutorials/command-line-for-beginners">https://ubuntu.com/tutorials/command-line-for-beginners</a></p>
</dd>
<dd><p><a href="https://linuxconfig.org/ubuntu-server-tutorial-for-beginners">https://linuxconfig.org/ubuntu-server-tutorial-for-beginners</a></p>
</dd>
<dt><a href="#chapter-05">Creating a Samba file sharing service</a>:</dt>
<dd><p><a href="https://en.wikipedia.org/wiki/Chmod">https://en.wikipedia.org/wiki/Chmod</a></p>
</dd>
<dd><p><a href="https://www.baeldung.com/linux/lost-found-directory">https://www.baeldung.com/linux/lost-found-directory</a></p>
</dd>
<dd><p><a href="https://www.samba.org/samba/docs/current/man-html/vfs_fruit.8.html">https://www.samba.org/samba/docs/current/man-html/vfs_fruit.8.html</a></p>
</dd>
<dd><p><a href="https://raw.githubusercontent.com/deatrich/linux-home-server/main/examples/smb.conf">https://raw.githubusercontent.com/deatrich/linux-home-server/main/examples/smb.conf</a></p>
</dd>
<dd><p><a href="https://cxfileexplorer.com/">https://cxfileexplorer.com/</a></p>
</dd>
<dd><p><a href="https://wiki.gnome.org/Apps/Seahorse">https://wiki.gnome.org/Apps/Seahorse</a></p>
</dd>
<dt><a href="#chapter-07">Server customization</a>:</dt>
<dd><p><a href="https://en.wikipedia.org/wiki/Real-time_clock">https://en.wikipedia.org/wiki/Real-time_clock</a></p>
</dd>
<dd><p><a href="https://www.pishop.ca/product/ds3231-real-time-clock-module-for-raspberry-pi/">https://www.pishop.ca/product/ds3231-real-time-clock-module-for-raspberry-pi/</a></p>
</dd>
<dd><p><a href="https://www.redhat.com/sysadmin/inodes-linux-filesystem">https://www.redhat.com/sysadmin/inodes-linux-filesystem</a></p>
</dd>
<dd><p><a href="https://onlinux.systems/guides/20220524_how-to-disable-and-remove-snap-on-ubuntu-2204">https://onlinux.systems/guides/20220524_how-to-disable-and-remove-snap-on-ubuntu-2204</a></p>
</dd>
<dd><p><a href="https://docs.memset.com/cd/Linux%27s-OOM-Process-Killer.199066633.html">https://docs.memset.com/cd/Linux%27s-OOM-Process-Killer.199066633.html</a></p>
</dd>
<dd><p><a href="https://help.ubuntu.com/community/SwapFaq">https://help.ubuntu.com/community/SwapFaq</a></p>
</dd>
<dd><p><a href="https://www.swissbit.com/en/products/security-products/secure-boot-solution/">https://www.swissbit.com/en/products/security-products/secure-boot-solution/</a></p>
</dd>
<dd><p><a href="https://ubuntu.com/server/docs/service-sssd">https://ubuntu.com/server/docs/service-sssd</a></p>
</dd>
<dd><p><a href="https://news.ycombinator.com/item?id=35815382">https://news.ycombinator.com/item?id=35815382</a></p>
</dd>
<dd><p><a href="https://en.wikipedia.org/wiki/AppArmor">https://en.wikipedia.org/wiki/AppArmor</a></p>
</dd>
<dd><p><a href="https://en.wikipedia.org/wiki/Locale_(computer_software)">https://en.wikipedia.org/wiki/Locale_(computer_software)</a></p>
</dd>
<dd><p><a href="https://en.wikipedia.org/wiki/Linux_PAM">https://en.wikipedia.org/wiki/Linux_PAM</a></p>
</dd>
<dt><a href="#chapter-08">Enabling the Secure Shell daemon and using Secure Shell</a>:</dt>
<dd><p><a href="https://en.wikipedia.org/wiki/Secure_Shell">https://en.wikipedia.org/wiki/Secure_Shell</a></p>
</dd>
<dd><p><a href="https://www.ssh.com/academy/ssh/agent">https://www.ssh.com/academy/ssh/agent</a></p>
</dd>
<dd><p><a href="https://github.com/deatrich/tools/blob/main/prime-ssh-keys.sh">https://github.com/deatrich/tools/blob/main/prime-ssh-keys.sh</a></p>
</dd>
<dd><p><a href="https://en.wikipedia.org/wiki/Shebang_(Unix)">https://en.wikipedia.org/wiki/Shebang_(Unix)</a></p>
</dd>
<dt><a href="#chapter-09">Enabling remote desktop services</a>:</dt>
<dd><p><a href="https://threatpost.com/remote-desktop-protocol-secure/167719/">https://threatpost.com/remote-desktop-protocol-secure/167719/</a></p>
</dd>
<dd><p><a href="https://ubuntu.com/tutorials/access-remote-desktop#1-overview">https://ubuntu.com/tutorials/access-remote-desktop#1-overview</a></p>
</dd>
<dd><p><a href="https://www.digitalocean.com/community/tutorials/how-to-enable-remote-desktop-protocol-using-xrdp-on-ubuntu-22-04">https://www.digitalocean.com/community/tutorials/how-to-enable-remote-desktop-protocol-using-xrdp-on-ubuntu-22-04</a></p>
</dd>
<dd><p><a href="https://en.wikipedia.org/wiki/X2Go">https://en.wikipedia.org/wiki/X2Go</a></p>
</dd>
<dt><a href="#chapter-11">Creating a web server</a>:</dt>
<dd><p><a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-and-configure-a-certificate-authority-ca-on-ubuntu-20-04">https://www.digitalocean.com/community/tutorials/how-to-set-up-and-configure-a-certificate-authority-ca-on-ubuntu-20-04</a></p>
</dd>
<dd><p><a href="https://ubuntu.com/server/docs/web-servers-apache">https://ubuntu.com/server/docs/web-servers-apache</a></p>
</dd>
<dd><p><a href="https://en.wikipedia.org/wiki/Nginx">https://en.wikipedia.org/wiki/Nginx</a></p>
</dd>
<dd><p><a href="https://github.com/deatrich/tools/blob/main/addcert.sh">https://github.com/deatrich/tools/blob/main/addcert.sh</a></p>
</dd>
<dd><p><a href="https://github.com/deatrich/tools/blob/main/etc/addcert.cnf">https://github.com/deatrich/tools/blob/main/etc/addcert.cnf</a></p>
</dd>
<dt><a href="#chapter-12">Creating a database server</a>:</dt>
<dd><p><a href="https://www.zenarmor.com/docs/linux-tutorials/best-open-source-database-software">https://www.zenarmor.com/docs/linux-tutorials/best-open-source-database-software</a></p>
</dd>
<dd><p><a href="https://en.wikipedia.org/wiki/LAMP_(software_bundle)">https://en.wikipedia.org/wiki/LAMP_(software_bundle)</a></p>
</dd>
<dd><p><a href="https://mariadb.com/kb/en/storage-engines/">https://mariadb.com/kb/en/storage-engines/</a></p>
</dd>
<dd><p><a href="https://www.digitalocean.com/community/tutorials/how-to-import-and-export-databases-in-mysql-or-mariadb">https://www.digitalocean.com/community/tutorials/how-to-import-and-export-databases-in-mysql-or-mariadb</a></p>
</dd>
<dd><p><a href="https://github.com/deatrich/tools/blob/main/etc/mysql-backup.conf">https://github.com/deatrich/tools/blob/main/etc/mysql-backup.conf</a></p>
</dd>
<dd><p><a href="https://github.com/deatrich/tools/blob/main/mysql-backup.sh">https://github.com/deatrich/tools/blob/main/mysql-backup.sh</a></p>
</dd>
<dt><a href="#chapter-13">Starting your own Git service</a>:</dt>
<dd><p><a href="https://github.com/">https://github.com/</a></p>
</dd>
<dt><a href="#chapter-14">Setting up a virtualization service with QEMU/KVM</a>:</dt>
<dd><p><a href="https://www.techradar.com/news/computing/pc/system-on-a-chip-what-you-need-to-know-about-socs-1147235">https://www.techradar.com/news/computing/pc/system-on-a-chip-what-you-need-to-know-about-socs-1147235</a></p>
</dd>
<dd><p><a href="https://en.wikipedia.org/wiki/ARM_architecture_family">https://en.wikipedia.org/wiki/ARM_architecture_family</a></p>
</dd>
<dd><p><a href="https://www.fosslinux.com/48755/top-opensource-virtualization-software-for-linux.htm">https://www.fosslinux.com/48755/top-opensource-virtualization-software-for-linux.htm</a></p>
</dd>
<dd><p><a href="https://github.com/qemu/qemu">https://github.com/qemu/qemu</a></p>
</dd>
<dd><p><a href="https://en.wikipedia.org/wiki/Libvirt">https://en.wikipedia.org/wiki/Libvirt</a></p>
</dd>
<dd><p><a href="https://en.wikipedia.org/wiki/Kernel-based_Virtual_Machine">https://en.wikipedia.org/wiki/Kernel-based_Virtual_Machine</a></p>
</dd>
<dd><p><a href="https://wiki.libvirt.org/Networking.html">https://wiki.libvirt.org/Networking.html</a></p>
</dd>
<dd><p><a href="https://phoenixnap.com/kb/ubuntu-install-kvm">https://phoenixnap.com/kb/ubuntu-install-kvm</a></p>
</dd>
<dt><a href="#zappendix">Appendix</a>:</dt>
<dd><p><a href="https://www.dedoimedo.com/computers/gparted.html#mozTocId133810">https://www.dedoimedo.com/computers/gparted.html#mozTocId133810</a></p>
</dd>
<dd><p><a href="https://en.wikipedia.org/wiki/Extended_file_system">https://en.wikipedia.org/wiki/Extended_file_system</a></p>
</dd>
<dd><p><a href="https://github.com/deatrich/tools/blob/main/system-backup.sh">https://github.com/deatrich/tools/blob/main/system-backup.sh</a></p>
</dd>
<dd><p><a href="https://github.com/deatrich/tools/blob/main/etc/system-backup.conf">https://github.com/deatrich/tools/blob/main/etc/system-backup.conf</a></p>
</dd>
<dd><p><a href="https://data.iana.org/TLD/tlds-alpha-by-domain.txt">https://data.iana.org/TLD/tlds-alpha-by-domain.txt</a></p>
</dd>
<dd><p><a href="https://en.wikipedia.org/wiki/Private_network">https://en.wikipedia.org/wiki/Private_network</a></p>
</dd>
<dd><p><a href="https://www.techspot.com/guides/287-default-router-ip-addresses/">https://www.techspot.com/guides/287-default-router-ip-addresses/</a></p>
</dd>
</dl>
<section class="footnotes" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>Ubuntu Advantage is also known as <strong>Ubuntu Pro</strong>. It is <em>free</em> of charge for personal use on up to 5 machines.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>changes the mode of a file or directory. It takes <a href="https://en.wikipedia.org/wiki/Chmod">symbolic or numeric arguments</a>.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3" role="doc-endnote"><p>changes the owner of a file or directory; with a colon it also changes the group ownership.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4" role="doc-endnote"><p><a href="https://www.techradar.com/news/computing/pc/system-on-a-chip-what-you-need-to-know-about-socs-1147235">System on a Chip</a><a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5" role="doc-endnote"><p>Network Address Translation, used to hide internal device IP addresses from external devices<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6" role="doc-endnote"><p>Domain Name System – how we look up hostnames<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
</body>
</html>
